const { createClient } = require('@supabase/supabase-js');\nconst bcrypt = require('bcryptjs');\nconst { signToken, handleCors, errorResponse } = require('./lib/auth');\n\nfunction getSupabaseClient() {\n  const supabaseUrl = process.env.SUPABASE_URL;\n  const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;\n  if (!supabaseUrl || !supabaseKey) throw new Error('Supabase 환경 변수가 설정되지 않았습니다');\n  return createClient(supabaseUrl, supabaseKey);\n}\n\nexports.handler = async (event) => {\n  const cors = handleCors(event);\n  if (cors.statusCode) return cors;\n  const headers = cors.headers;\n\n  if (event.httpMethod !== 'POST') return errorResponse('POST only', 405, headers);\n\n  try {\n    let body;\n    try { body = JSON.parse(event.body); } catch { return errorResponse('잘못된 요청 데이터입니다', 400, headers); }\n\n    const { email, password, name, phone, companyName, businessNumber, ceoName } = body;\n\n    if (!email || !password || !name || !phone || !companyName || !businessNumber || !ceoName)\n      return errorResponse('모든 필수 항목을 입력해주세요.', 400, headers);\n\n    const emailRegex = /^[^\s@]+@[^\s@]+\\.[^\s@]+$/;\n    if (!emailRegex.test(email)) return errorResponse('올바른 이메일 형식이 아닙니다.', 400, headers);\n\n    if (password.length < 8 || !/[a-zA-Z]/.test(password) || !/[0-9]/.test(password))\n      return errorResponse('비밀번호는 8자 이상, 영문과 숫자를 포함해야 합니다.', 400, headers);\n\n    const bizRegex = /^\\d{3}-\\d{2}-\\d{5}$/;\n    if (!bizRegex.test(businessNumber)) return errorResponse('올바른 사업자등록번호 형식이 아닙니다.', 400, headers);\n\n    let supabase;\n    try { supabase = getSupabaseClient(); } catch (e) { return errorResponse('DB 연결 실패', 500, headers); }\n\n    const { data: existingUser } = await supabase.from('users').select('id').eq('email', email).is('deleted_at', null).single();\n    if (existingUser) return errorResponse('이미 사용 중인 이메일입니다.', 409, headers);\n\n    const { data: existingCompany } = await supabase.from('companies').select('id').eq('business_number', businessNumber).is('deleted_at', null).single();\n    if (existingCompany) return errorResponse('이미 등록된 사업자등록번호입니다.', 409, headers);\n\n    const passwordHash = await bcrypt.hash(password, 12);\n\n    const { data: newCompany, error: companyError } = await supabase\n      .from('companies')\n      .insert({ name: companyName, business_number: businessNumber, ceo_name: ceoName, subscription_plan: 'free', subscription_status: 'active', max_employees: 3, created_at: new Date().toISOString(), updated_at: new Date().toISOString() })\n      .select('id, name, subscription_plan, subscription_status')\n      .single();\n\n    if (companyError || !newCompany) { console.error('회사 생성 오류:', companyError); return errorResponse('회사 정보 등록 실패', 500, headers); }\n\n    const { data: newUser, error: userError } = await supabase\n      .from('users')\n      .insert({ email, password_hash: passwordHash, name, phone, role: 'owner', status: 'active', company_id: newCompany.id, login_count: 0, created_at: new Date().toISOString(), updated_at: new Date().toISOString() })\n      .select('id, email, name, role, company_id')\n      .single();\n\n    if (userError || !newUser) {\n      console.error('사용자 생성 오류:', userError);\n      await supabase.from('companies').delete().eq('id', newCompany.id);\n      return errorResponse('사용자 등록 실패', 500, headers);\n    }\n\n    const token = signToken({ userId: newUser.id, email: newUser.email, role: newUser.role, companyId: newCompany.id });\n\n    return {\n      statusCode: 201,\n      headers,\n      body: JSON.stringify({\n        success: true,\n        data: {\n          user: { id: newUser.id, email: newUser.email, name: newUser.name, role: newUser.role, companyId: newCompany.id, companyName: newCompany.name },\n          company: { id: newCompany.id, name: newCompany.name, plan: newCompany.subscription_plan, status: newCompany.subscription_status },\n          token,\n          message: '회원가입이 완료되었습니다.'\n        }\n      })\n    };\n\n  } catch (error) {\n    console.error('회원가입 오류:', error.message);\n    return errorResponse('서버 오류: ' + error.message, 500, headers);\n  }\n};\n