<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>구독 완료 - StaffManager</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans KR', sans-serif; background: #f8f9fa; min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 2rem; }
        .container { max-width: 520px; width: 100%; background: white; border-radius: 20px; padding: 3rem; box-shadow: 0 10px 40px rgba(0,0,0,0.1); text-align: center; }
        .loading-section { display: block; }
        .success-section { display: none; }
        .error-section { display: none; }
        .spinner { width: 50px; height: 50px; border: 4px solid #f0f0f0; border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1.5rem; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loading-text { color: #666; font-size: 1rem; }
        .success-icon { width: 80px; height: 80px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem; font-size: 2.5rem; }
        h1 { color: #333; margin-bottom: 0.5rem; font-size: 1.8rem; }
        .subtitle { color: #666; margin-bottom: 2rem; }
        .info-box { background: #f8f9fa; border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem; text-align: left; }
        .info-item { display: flex; justify-content: space-between; align-items: center; padding: 0.7rem 0; border-bottom: 1px solid #eee; }
        .info-item:last-child { border-bottom: none; }
        .info-label { color: #666; font-size: 0.9rem; }
        .info-value { color: #333; font-weight: 600; }
        .btn-group { display: flex; gap: 1rem; }
        .btn { flex: 1; padding: 0.9rem; border-radius: 10px; text-decoration: none; font-weight: 600; font-size: 0.95rem; text-align: center; cursor: pointer; border: none; display: block; }
        .btn-primary { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
        .btn-secondary { background: white; color: #667eea; border: 2px solid #667eea; }
        .error-icon { font-size: 3rem; margin-bottom: 1rem; }
        .error-msg { color: #e74c3c; margin-bottom: 2rem; }
    </style>
</head>
<body>
    <div class="container">
        <div class="loading-section" id="loadingSection">
            <div class="spinner"></div>
            <p class="loading-text">카드 등록을 처리하고 있습니다...</p>
            <p class="loading-text" style="font-size:0.85rem;color:#aaa;margin-top:0.5rem;">잠시만 기다려주세요</p>
        </div>
        <div class="success-section" id="successSection">
            <div class="success-icon">✓</div>
            <h1>구독이 시작됐습니다!</h1>
            <p class="subtitle">StaffManager와 함께 스마트한 HR 관리를 경험하세요.</p>
            <div class="info-box">
                <div class="info-item"><span class="info-label">구독 플랜</span><span class="info-value" id="resultPlan">-</span></div>
                <div class="info-item"><span class="info-label">월 결제 금액</span><span class="info-value" id="resultAmount">-</span></div>
                <div class="info-item"><span class="info-label">다음 결제일</span><span class="info-value" id="resultNextDate">-</span></div>
                <div class="info-item"><span class="info-label">등록 이메일</span><span class="info-value" id="resultEmail">-</span></div>
            </div>
            <div class="btn-group">
                <a href="/dashboard.html" class="btn btn-primary">대시보드로 이동</a>
                <a href="/settings.html" class="btn btn-secondary">설정 보기</a>
            </div>
        </div>
        <div class="error-section" id="errorSection">
            <div class="error-icon">⚠️</div>
            <h1 style="color:#e74c3c;">처리 중 오류가 발생했습니다</h1>
            <p class="error-msg" id="errorMsg">잠시 후 다시 시도해주세요.</p>
            <div class="btn-group">
                <a href="/billing.html" class="btn btn-primary">다시 시도</a>
                <a href="/dashboard.html" class="btn btn-secondary">대시보드로</a>
            </div>
        </div>
    </div>
    <script>
        const params = new URLSearchParams(window.location.search);
        const authKey = params.get('authKey');
        const customerKey = params.get('customerKey');
        const plan = params.get('plan') || 'pro';
        const customerEmail = params.get('customerEmail') || '';
        const customerName = params.get('customerName') || '';
        const plans = {
            free:     { name: 'Free 플랜',     price: 0,     text: '무료' },
            pro:      { name: 'Pro 플랜',       price: 19900, text: '19,900원' },
            business: { name: 'Business 플랜', price: 49900, text: '49,900원' }
        };
        function getNextPaymentDate() {
            const d = new Date();
            d.setMonth(d.getMonth() + 1);
            return d.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric' });
        }
        function showSection(name) {
            ['loading', 'success', 'error'].forEach(s => {
                document.getElementById(s + 'Section').style.display = s === name ? 'block' : 'none';
            });
        }
        if (!authKey) {
            showSection('error');
            document.getElementById('errorMsg').textContent = '결제 인증 정보가 없습니다. 결제 페이지에서 다시 시도해주세요.';
        } else {
            (async () => {
                try {
                    const response = await fetch('/.netlify/functions/payments-billing-confirm', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ authKey, customerKey, plan, customerEmail, customerName })
                    });
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.error || '빌링키 발급 실패');
                    const planInfo = plans[plan] || plans.pro;
                    document.getElementById('resultPlan').textContent = planInfo.name;
                    document.getElementById('resultAmount').textContent = planInfo.price === 0 ? '무료' : planInfo.text + ' / 월';
                    document.getElementById('resultNextDate').textContent = getNextPaymentDate();
                    document.getElementById('resultEmail').textContent = customerEmail || result.customerEmail || '-';
                    showSection('success');
                } catch (err) {
                    console.error('빌링 확정 오류:', err);
                    showSection('error');
                    document.getElementById('errorMsg').textContent = err.message || '처리 중 오류가 발생했습니다.';
                }
            })();
        }
    </script>
</body>
</html>