<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê³„ì•½ê´€ë¦¬ - StaffManager</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Malgun Gothic', sans-serif;
            background: #f0f2f5;
            color: #333;
            min-height: 100vh;
        }
        .navbar {
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 0 30px;
            height: 70px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .navbar-brand {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 24px;
            font-weight: 700;
            color: #667eea;
            text-decoration: none;
        }
        .navbar-menu { display: flex; gap: 30px; align-items: center; }
        .navbar-menu a {
            text-decoration: none; color: #666; font-weight: 500;
            padding: 8px 0; transition: color 0.2s;
        }
        .navbar-menu a:hover { color: #667eea; }
        .navbar-menu a.active { color: #667eea; font-weight: 700; border-bottom: 3px solid #667eea; }
        .container { max-width: 1200px; margin: 0 auto; padding: 30px 20px; }

        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 16px; margin-bottom: 30px;
        }
        .stat-card {
            background: white; border-radius: 12px; padding: 20px;
            text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            transition: transform 0.2s; cursor: pointer;
        }
        .stat-card:hover { transform: translateY(-2px); }
        .stat-card .stat-number { font-size: 32px; font-weight: 700; color: #333; }
        .stat-card .stat-label { font-size: 13px; color: #888; margin-top: 4px; }
        .stat-card.active { border: 2px solid #667eea; background: #f8f9ff; }

        .page-header {
            display: flex; justify-content: space-between;
            align-items: center; margin-bottom: 20px;
        }
        .page-header h1 { font-size: 28px; color: #1a1a1a; }

        .btn-primary {
            padding: 12px 28px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border: none; border-radius: 8px;
            font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s;
        }
        .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 15px rgba(102,126,234,0.4); }
        .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

        .btn-sm {
            padding: 6px 14px; font-size: 13px; border-radius: 6px;
            border: none; cursor: pointer; font-weight: 500; transition: all 0.2s;
        }
        .btn-send { background: #4CAF50; color: white; }
        .btn-send:hover { background: #43A047; }
        .btn-resend { background: #FF9800; color: white; }
        .btn-resend:hover { background: #F57C00; }
        .btn-cancel { background: #f44336; color: white; }
        .btn-cancel:hover { background: #D32F2F; }
        .btn-view { background: #2196F3; color: white; }
        .btn-view:hover { background: #1976D2; }
        .btn-delete { background: #9E9E9E; color: white; }
        .btn-delete:hover { background: #757575; }

        .filter-bar { display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; }
        .filter-bar select, .filter-bar input {
            padding: 10px 14px; border: 1px solid #ddd;
            border-radius: 8px; font-size: 14px; background: white;
        }

        .table-card {
            background: white; border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06); overflow: hidden;
        }
        table { width: 100%; border-collapse: collapse; }
        th {
            background: #f8f9fa; padding: 14px 16px; text-align: left;
            font-size: 13px; color: #666; font-weight: 600; border-bottom: 2px solid #e9ecef;
        }
        td { padding: 14px 16px; border-bottom: 1px solid #f0f0f0; font-size: 14px; }
        tr:hover { background: #f8f9ff; }

        .status-badge {
            display: inline-block; padding: 4px 12px;
            border-radius: 20px; font-size: 12px; font-weight: 600;
        }
        .status-draft { background: #E0E0E0; color: #616161; }
        .status-sent { background: #E3F2FD; color: #1565C0; }
        .status-viewed { background: #FFF3E0; color: #E65100; }
        .status-signed { background: #E8F5E9; color: #2E7D32; }
        .status-completed { background: #E8F5E9; color: #1B5E20; }
        .status-rejected { background: #FFEBEE; color: #C62828; }
        .status-expired { background: #F3E5F5; color: #6A1B9A; }

        .employee-info { display: flex; align-items: center; gap: 8px; }
        .employee-avatar {
            width: 36px; height: 36px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%; display: flex; align-items: center;
            justify-content: center; color: white; font-weight: 700; font-size: 14px;
        }
        .actions { display: flex; gap: 6px; flex-wrap: wrap; }

        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5); z-index: 200;
            justify-content: center; align-items: center;
        }
        .modal-overlay.show { display: flex; }
        .modal {
            background: white; border-radius: 16px; padding: 36px;
            width: 560px; max-width: 95vw; max-height: 90vh;
            overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        .modal h2 { font-size: 22px; margin-bottom: 24px; color: #1a1a1a; }

        .form-group { margin-bottom: 18px; }
        .form-group label {
            display: block; margin-bottom: 6px;
            font-size: 14px; font-weight: 600; color: #555;
        }
        .form-group select, .form-group input, .form-group textarea {
            width: 100%; padding: 11px 14px; border: 2px solid #e0e0e0;
            border-radius: 8px; font-size: 15px; transition: border-color 0.2s;
        }
        .form-group select:focus, .form-group input:focus { outline: none; border-color: #667eea; }

        .modal-buttons { display: flex; gap: 12px; margin-top: 24px; justify-content: flex-end; }
        .btn-outline {
            padding: 12px 24px; background: white; border: 2px solid #ddd;
            border-radius: 8px; font-size: 15px; cursor: pointer; color: #666;
        }
        .btn-outline:hover { border-color: #999; }

        .empty-state { text-align: center; padding: 80px 20px; color: #999; }
        .empty-state .icon { font-size: 64px; margin-bottom: 16px; }
        .empty-state p { font-size: 16px; margin-bottom: 20px; }

        .toast {
            position: fixed; top: 80px; right: 20px; padding: 14px 24px;
            border-radius: 10px; color: white; font-weight: 500; z-index: 300;
            transform: translateX(120%); transition: transform 0.3s;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }
        .toast.show { transform: translateX(0); }
        .toast.success { background: #4CAF50; }
        .toast.error { background: #f44336; }
        .toast.info { background: #2196F3; }

        .loading-spinner { text-align: center; padding: 60px; color: #999; }
        .spinner {
            width: 40px; height: 40px; border: 4px solid #e0e0e0;
            border-top-color: #667eea; border-radius: 50%;
            animation: spin 0.8s linear infinite; margin: 0 auto 16px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .detail-row { display: flex; padding: 10px 0; border-bottom: 1px solid #f0f0f0; }
        .detail-label { width: 120px; color: #888; font-size: 14px; flex-shrink: 0; }
        .detail-value { font-size: 14px; color: #333; }

        @media (max-width: 768px) {
            .navbar { padding: 0 16px; }
            .navbar-menu { gap: 16px; font-size: 13px; }
            .container { padding: 16px; }
            .stats-row { grid-template-columns: repeat(3, 1fr); }
            .page-header { flex-direction: column; gap: 12px; align-items: flex-start; }
            .modal { padding: 24px; }
            th, td { padding: 10px 8px; }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <a href="/dashboard.html" class="navbar-brand"><span>ğŸ¯</span><span>StaffManager</span></a>
        <div class="navbar-menu">
            <a href="/dashboard.html">ëŒ€ì‹œë³´ë“œ</a>
            <a href="/employees.html">ì§ì› ê´€ë¦¬</a>
            <a href="/attendances.html">ì¶œí‡´ê·¼</a>
            <a href="/calendar.html">íœ´ê°€</a>
            <a href="/salary.html">ê¸‰ì—¬</a>
            <a href="/contracts.html" class="active">ê³„ì•½</a>
            <a href="/settings.html">ì„¤ì •</a>
        </div>
        <div><button onclick="handleLogout()" style="padding:8px 16px;background:#667eea;color:white;border:none;border-radius:6px;cursor:pointer;font-weight:500;">ë¡œê·¸ì•„ì›ƒ</button></div>
    </nav>

    <div class="container">
        <div class="stats-row" id="statsRow">
            <div class="stat-card active" onclick="filterByStatus('', this)">
                <div class="stat-number" id="stat-total">-</div>
                <div class="stat-label">ì „ì²´</div>
            </div>
            <div class="stat-card" onclick="filterByStatus('draft', this)">
                <div class="stat-number" id="stat-draft">-</div>
                <div class="stat-label">ì‘ì„±ì¤‘</div>
            </div>
            <div class="stat-card" onclick="filterByStatus('sent', this)">
                <div class="stat-number" id="stat-sent">-</div>
                <div class="stat-label">ë°œì†¡ë¨</div>
            </div>
            <div class="stat-card" onclick="filterByStatus('viewed', this)">
                <div class="stat-number" id="stat-viewed">-</div>
                <div class="stat-label">ì—´ëŒë¨</div>
            </div>
            <div class="stat-card" onclick="filterByStatus('completed', this)">
                <div class="stat-number" id="stat-completed">-</div>
                <div class="stat-label">ì™„ë£Œ</div>
            </div>
            <div class="stat-card" onclick="filterByStatus('rejected', this)">
                <div class="stat-number" id="stat-rejected">-</div>
                <div class="stat-label">ê±°ì ˆ/ì·¨ì†Œ</div>
            </div>
        </div>

        <div class="page-header">
            <h1>ğŸ“„ ì „ìê³„ì•½ ê´€ë¦¬</h1>
            <button class="btn-primary" onclick="openCreateModal()">+ ìƒˆ ê³„ì•½ì„œ</button>
        </div>

        <div class="filter-bar">
            <select id="filterType" onchange="loadContracts()">
                <option value="">ê³„ì•½ ìœ í˜• ì „ì²´</option>
                <option value="ê·¼ë¡œê³„ì•½ì„œ">ê·¼ë¡œê³„ì•½ì„œ</option>
                <option value="ì—°ë´‰ê³„ì•½ì„œ">ì—°ë´‰ê³„ì•½ì„œ</option>
                <option value="ë¹„ë°€ìœ ì§€ê³„ì•½ì„œ">ë¹„ë°€ìœ ì§€ê³„ì•½ì„œ</option>
                <option value="ê²¸ì—…ê¸ˆì§€ê³„ì•½ì„œ">ê²¸ì—…ê¸ˆì§€ê³„ì•½ì„œ</option>
                <option value="í‡´ì§í•©ì˜ì„œ">í‡´ì§í•©ì˜ì„œ</option>
                <option value="ê¸°íƒ€">ê¸°íƒ€</option>
            </select>
            <input type="text" id="searchInput" placeholder="ì§ì› ì´ë¦„ ê²€ìƒ‰..." oninput="filterTable()" style="width:200px;">
        </div>

        <div class="table-card">
            <div id="loadingArea" class="loading-spinner">
                <div class="spinner"></div>
                <p>ê³„ì•½ì„œ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
            </div>
            <div id="emptyState" class="empty-state" style="display:none;">
                <div class="icon">ğŸ“„</div>
                <p>ë“±ë¡ëœ ê³„ì•½ì„œê°€ ì—†ìŠµë‹ˆë‹¤</p>
                <button class="btn-primary" onclick="openCreateModal()">ì²« ê³„ì•½ì„œ ë§Œë“¤ê¸°</button>
            </div>
            <table id="contractsTable" style="display:none;">
                <thead>
                    <tr>
                        <th>ì§ì›</th>
                        <th>ê³„ì•½ ìœ í˜•</th>
                        <th>ì œëª©</th>
                        <th>ìƒíƒœ</th>
                        <th>ìƒì„±ì¼</th>
                        <th>ì‘ì—…</th>
                    </tr>
                </thead>
                <tbody id="contractsBody"></tbody>
            </table>
        </div>
    </div>

    <!-- ìƒì„± ëª¨ë‹¬ -->
    <div class="modal-overlay" id="createModal">
        <div class="modal">
            <h2>ğŸ“ ìƒˆ ê³„ì•½ì„œ ë§Œë“¤ê¸°</h2>
            <div class="form-group">
                <label>ì§ì› ì„ íƒ *</label>
                <select id="createEmployee" required><option value="">ì§ì›ì„ ì„ íƒí•˜ì„¸ìš”</option></select>
            </div>
            <div class="form-group">
                <label>ê³„ì•½ ìœ í˜•</label>
                <select id="createType">
                    <option value="ê·¼ë¡œê³„ì•½ì„œ">ê·¼ë¡œê³„ì•½ì„œ</option>
                    <option value="ì—°ë´‰ê³„ì•½ì„œ">ì—°ë´‰ê³„ì•½ì„œ</option>
                    <option value="ë¹„ë°€ìœ ì§€ê³„ì•½ì„œ">ë¹„ë°€ìœ ì§€ê³„ì•½ì„œ (NDA)</option>
                    <option value="ê²¸ì—…ê¸ˆì§€ê³„ì•½ì„œ">ê²¸ì—…ê¸ˆì§€ê³„ì•½ì„œ</option>
                    <option value="í‡´ì§í•©ì˜ì„œ">í‡´ì§í•©ì˜ì„œ</option>
                    <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                </select>
            </div>
            <div class="form-group">
                <label>ê³„ì•½ì„œ ì œëª©</label>
                <input type="text" id="createTitle" placeholder="ìë™ ìƒì„±ë©ë‹ˆë‹¤ (ë¹ˆì¹¸ ê°€ëŠ¥)">
            </div>
            <div class="form-group">
                <label>ì„œëª…ì ì´ë©”ì¼</label>
                <input type="email" id="createEmail" placeholder="ì§ì› ì´ë©”ì¼ ìë™ ì…ë ¥">
            </div>
            <div class="form-group">
                <label>ì„œëª…ì ì „í™”ë²ˆí˜¸</label>
                <input type="tel" id="createPhone" placeholder="ì§ì› ì „í™”ë²ˆí˜¸ ìë™ ì…ë ¥">
            </div>
            <div class="form-group">
                <label>UCanSign í…œí”Œë¦¿ ID *</label>
                <input type="text" id="createTemplateId" placeholder="UCanSign í…œí”Œë¦¿ ë¬¸ì„œ ID" value="2023470348238950402">
                <small style="color:#888;font-size:11px;">UCanSignì—ì„œ ìƒì„±í•œ í…œí”Œë¦¿ì˜ ë¬¸ì„œ ID</small>
            </div>
            <div class="form-group" style="display:flex;align-items:center;gap:8px;">
                <input type="checkbox" id="createAutoSend" style="width:auto;">
                <label for="createAutoSend" style="margin:0;cursor:pointer;">ìƒì„± í›„ ë°”ë¡œ ë°œì†¡</label>
            </div>
            <div class="modal-buttons">
                <button class="btn-outline" onclick="closeCreateModal()">ì·¨ì†Œ</button>
                <button class="btn-primary" onclick="createContract()" id="createBtn">ê³„ì•½ì„œ ìƒì„±</button>
            </div>
        </div>
    </div>

    <!-- ìƒì„¸ ëª¨ë‹¬ -->
    <div class="modal-overlay" id="detailModal">
        <div class="modal">
            <h2>ğŸ“‹ ê³„ì•½ì„œ ìƒì„¸</h2>
            <div id="detailContent"></div>
            <div class="modal-buttons">
                <button class="btn-outline" onclick="closeDetailModal()">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        let authToken = null;
        let employees = [];
        let contracts = [];
        let currentFilter = '';

        async function init() {
            authToken = localStorage.getItem('authToken');
            if (!authToken) { window.location.href = '/login.html'; return; }
            await loadEmployees();
            await loadContracts();
        }

        async function apiCall(url, options = {}) {
            const headers = { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken };
            const response = await fetch(url, { ...options, headers });
            const data = await response.json();
            if (response.status === 401) {
                showToast('ì„¸ì…˜ ë§Œë£Œ. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.', 'error');
                setTimeout(function() { window.location.href = '/login.html'; }, 1500);
                throw new Error('Unauthorized');
            }
            return data;
        }

        async function loadEmployees() {
            try {
                const result = await apiCall('/.netlify/functions/employees-list');
                if (result.success) {
                    employees = (result.data && result.data.employees) ? result.data.employees : (Array.isArray(result.data) ? result.data : []);
                    populateEmployeeSelect();
                }
            } catch (err) { console.error('ì§ì› ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', err); }
        }

        function populateEmployeeSelect() {
            var select = document.getElementById('createEmployee');
            select.innerHTML = '<option value="">ì§ì›ì„ ì„ íƒí•˜ì„¸ìš”</option>';
            employees.forEach(function(emp) {
                var opt = document.createElement('option');
                opt.value = emp.id;
                opt.textContent = emp.name + ' (' + (emp.position || '') + ' ' + (emp.department || '') + ')';
                opt.dataset.email = emp.email || '';
                opt.dataset.phone = emp.phone || '';
                select.appendChild(opt);
            });
            select.addEventListener('change', function() {
                var selected = this.options[this.selectedIndex];
                if (selected.value) {
                    document.getElementById('createEmail').value = selected.dataset.email || '';
                    document.getElementById('createPhone').value = selected.dataset.phone || '';
                }
            });
        }

        async function loadContracts() {
            var loadingEl = document.getElementById('loadingArea');
            var tableEl = document.getElementById('contractsTable');
            var emptyEl = document.getElementById('emptyState');
            loadingEl.style.display = 'block'; tableEl.style.display = 'none'; emptyEl.style.display = 'none';

            try {
                var url = '/.netlify/functions/contracts-list';
                var params = [];
                if (currentFilter) params.push('status=' + currentFilter);
                var typeFilter = document.getElementById('filterType').value;
                if (typeFilter) params.push('contract_type=' + encodeURIComponent(typeFilter));
                if (params.length > 0) url += '?' + params.join('&');

                var result = await apiCall(url);
                if (result.success) {
                    contracts = result.data || [];
                    updateStats(result.stats || {});
                    renderContracts();
                } else { showToast(result.error || 'ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨', 'error'); }
            } catch (err) {
                if (err.message !== 'Unauthorized') showToast('ê³„ì•½ì„œ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨', 'error');
            } finally { loadingEl.style.display = 'none'; }
        }

        function updateStats(stats) {
            document.getElementById('stat-total').textContent = stats.total || 0;
            document.getElementById('stat-draft').textContent = stats.draft || 0;
            document.getElementById('stat-sent').textContent = stats.sent || 0;
            document.getElementById('stat-viewed').textContent = stats.viewed || 0;
            document.getElementById('stat-completed').textContent = (stats.signed || 0) + (stats.completed || 0);
            document.getElementById('stat-rejected').textContent = (stats.rejected || 0) + (stats.expired || 0);
        }

        function filterByStatus(status, el) {
            currentFilter = status;
            document.querySelectorAll('.stat-card').forEach(function(c) { c.classList.remove('active'); });
            if (el) el.classList.add('active');
            loadContracts();
        }


        // ê³„ì•½ ìœ í˜• í•œê¸€ ë³€í™˜
        function contractTypeLabel(t) {
            var map = {
                'standard_labor': 'ê·¼ë¡œê³„ì•½ì„œ',
                'part_time':      'ë‹¨ì‹œê°„ ê·¼ë¡œê³„ì•½ì„œ',
                'fixed_term':     'ê¸°ê°„ì œ ê·¼ë¡œê³„ì•½ì„œ',
                'freelance':      'í”„ë¦¬ëœì„œ ê³„ì•½ì„œ',
                'dispatch':       'íŒŒê²¬ê·¼ë¡œê³„ì•½ì„œ'
            };
            return map[t] || t;
        }

        function renderContracts() {
            var tableEl = document.getElementById('contractsTable');
            var emptyEl = document.getElementById('emptyState');
            var tbody = document.getElementById('contractsBody');
            if (contracts.length === 0) { tableEl.style.display = 'none'; emptyEl.style.display = 'block'; return; }
            tableEl.style.display = 'table'; emptyEl.style.display = 'none';

            tbody.innerHTML = contracts.map(function(c) {
                var empName = (c.employees && c.employees.name) || c.signer_name || '-';
                var initial = empName.charAt(0);
                var statusLabel = getStatusLabel(c.status);
                var createdDate = c.created_at ? new Date(c.created_at).toLocaleDateString('ko-KR') : '-';
                var empPos = (c.employees && c.employees.position) || '';
                var empDept = (c.employees && c.employees.department) || '';

                return '<tr data-name="' + empName + '">' +
                    '<td><div class="employee-info"><div class="employee-avatar">' + initial + '</div><div><div style="font-weight:600;">' + empName + '</div><div style="font-size:12px;color:#999;">' + empPos + ' ' + empDept + '</div></div></div></td>' +
                    '<td>' + contractTypeLabel(c.contract_type) + '</td>' +
                    '<td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">' + c.title + '</td>' +
                    '<td><span class="status-badge status-' + c.status + '">' + statusLabel + '</span></td>' +
                    '<td>' + createdDate + '</td>' +
                    '<td class="actions">' + getActionButtons(c) + '</td>' +
                    '</tr>';
            }).join('');
        }

        function getStatusLabel(status) {
            var labels = { draft:'ì‘ì„±ì¤‘', sent:'ë°œì†¡ë¨', viewed:'ì—´ëŒë¨', signed:'ì„œëª…ì™„ë£Œ', completed:'ì™„ë£Œ', rejected:'ê±°ì ˆ/ì·¨ì†Œ', expired:'ë§Œë£Œ' };
            return labels[status] || status;
        }

        function getActionButtons(c) {
            var btns = ['<button class="btn-sm btn-view" onclick="viewDetail(\'' + c.id + '\')">ìƒì„¸</button>'];
            if (c.status === 'draft') {
                btns.push('<button class="btn-sm btn-send" onclick="sendContract(\'' + c.id + '\')">ë°œì†¡</button>');
                btns.push('<button class="btn-sm btn-delete" onclick="deleteContract(\'' + c.id + '\')">ì‚­ì œ</button>');
            }
            if (c.status === 'sent' || c.status === 'viewed') {
                btns.push('<button class="btn-sm btn-resend" onclick="resendContract(\'' + c.id + '\')">ì¬ë°œì†¡</button>');
                btns.push('<button class="btn-sm btn-cancel" onclick="cancelContract(\'' + c.id + '\')">ì·¨ì†Œ</button>');
            }
            if (c.status === 'signed' || c.status === 'completed') {
                btns.push('<button class="btn-sm btn-view" onclick="downloadPdf(\'' + c.id + '\',\'pdf\')" style="background:#E8F5E9;color:#2E7D32;">ğŸ“¥ PDF</button>');
            }
            return btns.join('');
        }

        function filterTable() {
            var search = document.getElementById('searchInput').value.toLowerCase();
            document.querySelectorAll('#contractsBody tr').forEach(function(row) {
                row.style.display = row.dataset.name.toLowerCase().indexOf(search) >= 0 ? '' : 'none';
            });
        }

        function openCreateModal() { document.getElementById('createModal').classList.add('show'); }
        function closeCreateModal() { document.getElementById('createModal').classList.remove('show'); }

        async function createContract() {
            var empId = document.getElementById('createEmployee').value;
            if (!empId) { showToast('ì§ì›ì„ ì„ íƒí•´ì£¼ì„¸ìš”', 'error'); return; }
            var templateId = document.getElementById('createTemplateId').value;
            if (!templateId) { showToast('UCanSign í…œí”Œë¦¿ IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”', 'error'); return; }
            var btn = document.getElementById('createBtn');
            btn.disabled = true; btn.textContent = 'ìƒì„± ì¤‘...';
            try {
                var payload = {
                    employee_id: empId,
                    contract_type: document.getElementById('createType').value,
                    title: document.getElementById('createTitle').value || undefined,
                    template_id: templateId,
                    signer_email: document.getElementById('createEmail').value || undefined,
                    signer_phone: document.getElementById('createPhone').value || undefined,
                    auto_send: document.getElementById('createAutoSend').checked
                };
                var result = await apiCall('/.netlify/functions/contracts-create', { method: 'POST', body: JSON.stringify(payload) });
                if (result.success) {
                    showToast(payload.auto_send ? 'ê³„ì•½ì„œ ë°œì†¡ ì™„ë£Œ!' : 'ê³„ì•½ì„œ ìƒì„± ì™„ë£Œ!', 'success');
                    closeCreateModal(); await loadContracts();
                } else { showToast(result.error || 'ìƒì„± ì‹¤íŒ¨', 'error'); }
            } catch (err) { showToast('ìƒì„± ì‹¤íŒ¨: ' + err.message, 'error');
            } finally { btn.disabled = false; btn.textContent = 'ê³„ì•½ì„œ ìƒì„±'; }
        }

        async function sendContract(id) {
            if (!confirm('UCanSignìœ¼ë¡œ ë°œì†¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            try {
                var result = await apiCall('/.netlify/functions/contracts-create', { method: 'PUT', body: JSON.stringify({ id: id, action: 'send' }) });
                if (result.success) { showToast('ë°œì†¡ ì™„ë£Œ!', 'success'); await loadContracts(); }
                else { showToast(result.error || 'ë°œì†¡ ì‹¤íŒ¨', 'error'); }
            } catch (err) { showToast('ë°œì†¡ ì‹¤íŒ¨', 'error'); }
        }

        async function resendContract(id) {
            if (!confirm('ì¬ë°œì†¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            try {
                var result = await apiCall('/.netlify/functions/contracts-create', { method: 'PUT', body: JSON.stringify({ id: id, action: 'resend' }) });
                if (result.success) { showToast('ì¬ë°œì†¡ ì™„ë£Œ!', 'success'); await loadContracts(); }
                else { showToast(result.error || 'ì¬ë°œì†¡ ì‹¤íŒ¨', 'error'); }
            } catch (err) { showToast('ì¬ë°œì†¡ ì‹¤íŒ¨', 'error'); }
        }

        async function cancelContract(id) {
            if (!confirm('ì •ë§ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            try {
                var result = await apiCall('/.netlify/functions/contracts-create', { method: 'PUT', body: JSON.stringify({ id: id, action: 'cancel' }) });
                if (result.success) { showToast('ê³„ì•½ ì·¨ì†Œë¨', 'info'); await loadContracts(); }
                else { showToast(result.error || 'ì·¨ì†Œ ì‹¤íŒ¨', 'error'); }
            } catch (err) { showToast('ì·¨ì†Œ ì‹¤íŒ¨', 'error'); }
        }

        async function deleteContract(id) {
            if (!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            try {
                var result = await apiCall('/.netlify/functions/contracts-create', { method: 'DELETE', body: JSON.stringify({ id: id }) });
                if (result.success) { showToast('ì‚­ì œ ì™„ë£Œ', 'info'); await loadContracts(); }
                else { showToast(result.error || 'ì‚­ì œ ì‹¤íŒ¨', 'error'); }
            } catch (err) { showToast('ì‚­ì œ ì‹¤íŒ¨', 'error'); }
        }

        async function viewDetail(id) {
            try {
                // contracts-detail ì‚¬ìš© â†’ UCanSign ì‹¤ì‹œê°„ ìƒíƒœ ë™ê¸°í™”
                var result = await apiCall('/.netlify/functions/contracts-detail?contract_id=' + id);
                if (result.success && result.data) {
                    var c = result.data;
                    var empInfo = c.employee_info || {};
                    var empName = empInfo.name || c.signer_name || '-';
                    var empEmail = empInfo.email || c.signer_email || '-';
                    var empPhone = empInfo.phone || c.signer_phone || '-';
                    var empPosition = empInfo.position ? ' (' + empInfo.position + ')' : '';

                    var html = '<div class="detail-row"><div class="detail-label">ì œëª©</div><div class="detail-value">' + c.title + '</div></div>' +
                        '<div class="detail-row"><div class="detail-label">ìœ í˜•</div><div class="detail-value">' + contractTypeLabel(c.contract_type) + '</div></div>' +
                        '<div class="detail-row"><div class="detail-label">ì§ì›</div><div class="detail-value">' + empName + empPosition + '</div></div>' +
                        '<div class="detail-row"><div class="detail-label">ì´ë©”ì¼</div><div class="detail-value">' + empEmail + '</div></div>' +
                        '<div class="detail-row"><div class="detail-label">ì „í™”ë²ˆí˜¸</div><div class="detail-value">' + empPhone + '</div></div>' +
                        '<div class="detail-row"><div class="detail-label">ìƒíƒœ</div><div class="detail-value"><span class="status-badge status-' + c.status + '">' + getStatusLabel(c.status) + '</span>' +
                        ' <button onclick="syncStatus(\'' + id + '\')" style="font-size:12px;padding:2px 8px;border:1px solid #ddd;border-radius:4px;cursor:pointer;background:#f5f5f5;" title="UCanSignì—ì„œ ìµœì‹  ìƒíƒœ ë™ê¸°í™”">ğŸ”„ ë™ê¸°í™”</button></div></div>' +
                        '<div class="detail-row"><div class="detail-label">ìƒì„±ì¼</div><div class="detail-value">' + (c.created_at ? new Date(c.created_at).toLocaleString('ko-KR') : '-') + '</div></div>' +
                        '<div class="detail-row"><div class="detail-label">ë°œì†¡ì¼</div><div class="detail-value">' + (c.sent_at ? new Date(c.sent_at).toLocaleString('ko-KR') : '-') + '</div></div>' +
                        '<div class="detail-row"><div class="detail-label">ì„œëª…ì¼</div><div class="detail-value">' + (c.signed_at ? new Date(c.signed_at).toLocaleString('ko-KR') : '-') + '</div></div>' +
                        '<div class="detail-row"><div class="detail-label">ì™„ë£Œì¼</div><div class="detail-value">' + (c.completed_at ? new Date(c.completed_at).toLocaleString('ko-KR') : '-') + '</div></div>' +
                        '<div class="detail-row"><div class="detail-label">ë§Œë£Œì¼</div><div class="detail-value">' + (c.expires_at ? new Date(c.expires_at).toLocaleDateString('ko-KR') : '-') + '</div></div>';

                    // UCanSign ì°¸ì—¬ì ìƒíƒœ í‘œì‹œ
                    if (result.ucansign && result.ucansign.participants) {
                        html += '<div class="detail-row"><div class="detail-label">ì°¸ì—¬ì í˜„í™©</div><div class="detail-value">';
                        result.ucansign.participants.forEach(function(p) {
                            var icon = p.status === 'completed' ? 'âœ…' : p.status === 'viewed' ? 'ğŸ‘ï¸' : 'â³';
                            html += '<div style="margin-bottom:4px;">' + icon + ' ' + (p.name || 'ì°¸ì—¬ì') + ' â€” ' + (p.status || 'ëŒ€ê¸°ì¤‘') + '</div>';
                        });
                        html += '</div></div>';
                    }

                    if (c.ucansign_document_id) {
                        html += '<div class="detail-row"><div class="detail-label">ë¬¸ì„œ ID</div><div class="detail-value" style="font-size:12px;color:#999;">' + c.ucansign_document_id + '</div></div>';
                    }

                    // ì„œëª… ì™„ë£Œ ì‹œ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼
                    if (c.status === 'completed' || c.status === 'signed') {
                        html += '<div style="margin-top:20px;display:flex;gap:10px;flex-wrap:wrap;">';
                        html += '<button onclick="downloadPdf(\'' + id + '\',\'pdf\')" style="padding:10px 20px;background:#667eea;color:white;border:none;border-radius:8px;cursor:pointer;font-size:14px;">ğŸ“¥ ì„œëª… PDF ë‹¤ìš´ë¡œë“œ</button>';
                        html += '<button onclick="downloadPdf(\'' + id + '\',\'audit\')" style="padding:10px 20px;background:#764ba2;color:white;border:none;border-radius:8px;cursor:pointer;font-size:14px;">ğŸ“‹ ê°ì‚¬ì¶”ì  ì¸ì¦ì„œ</button>';
                        html += '</div>';
                    }

                    document.getElementById('detailContent').innerHTML = html;
                    document.getElementById('detailModal').classList.add('show');
                    // ëª©ë¡ë„ ìƒˆë¡œê³ ì¹¨ (ìƒíƒœ ë™ê¸°í™” ë°˜ì˜)
                    await loadContracts();
                }
            } catch (err) { showToast('ìƒì„¸ ì¡°íšŒ ì‹¤íŒ¨: ' + err.message, 'error'); }
        }

        // PDF / ê°ì‚¬ì¶”ì  ë‹¤ìš´ë¡œë“œ
        async function downloadPdf(contractId, type) {
            try {
                showToast('íŒŒì¼ URL ì¡°íšŒ ì¤‘...', 'info');
                var fileType = type || 'pdf';
                var result = await apiCall('/.netlify/functions/contracts-file?contract_id=' + contractId + '&type=' + fileType);
                if (result.success && result.data) {
                    var url = fileType === 'audit' ? result.data.audit_trail_url : result.data.pdf_url;
                    if (url) {
                        window.open(url, '_blank');
                        showToast('ë‹¤ìš´ë¡œë“œ URL ìƒì„± ì™„ë£Œ (3ë¶„ê°„ ìœ íš¨)', 'success');
                    } else {
                        showToast('íŒŒì¼ URLì„ ì•„ì§ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì„œëª… ì™„ë£Œ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.', 'error');
                    }
                } else {
                    showToast(result.error || 'íŒŒì¼ ì¡°íšŒ ì‹¤íŒ¨', 'error');
                }
            } catch (err) { showToast('íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: ' + err.message, 'error'); }
        }

        // ìƒíƒœ ë™ê¸°í™” (UCanSignì—ì„œ ìµœì‹  ìƒíƒœ ê°€ì ¸ì˜¤ê¸°)
        async function syncStatus(contractId) {
            try {
                showToast('UCanSign ìƒíƒœ ë™ê¸°í™” ì¤‘...', 'info');
                var result = await apiCall('/.netlify/functions/contracts-detail?contract_id=' + contractId);
                if (result.success) {
                    showToast('ìƒíƒœ ë™ê¸°í™” ì™„ë£Œ: ' + getStatusLabel(result.data.status), 'success');
                    await loadContracts();
                    viewDetail(contractId); // ìƒì„¸ ëª¨ë‹¬ ìƒˆë¡œê³ ì¹¨
                }
            } catch (err) { showToast('ë™ê¸°í™” ì‹¤íŒ¨: ' + err.message, 'error'); }
        }

        function closeDetailModal() { document.getElementById('detailModal').classList.remove('show'); }

        function showToast(message, type) {
            var t = document.getElementById('toast');
            t.textContent = message; t.className = 'toast ' + (type || 'info') + ' show';
            setTimeout(function() { t.classList.remove('show'); }, 3000);
        }

        function handleLogout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('userInfo');
            window.location.href = '/login.html';
        }

        document.getElementById('createModal').addEventListener('click', function(e) { if (e.target === this) closeCreateModal(); });
        document.getElementById('detailModal').addEventListener('click', function(e) { if (e.target === this) closeDetailModal(); });

        init();
    </script>
</body>
</html>
