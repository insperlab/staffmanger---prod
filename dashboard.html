<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê´€ë¦¬ - StaffManager</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','Roboto','Noto Sans KR',sans-serif;background:#f5f7fa;min-height:100vh}
        .navbar{background:#fff;box-shadow:0 2px 4px rgba(0,0,0,.1);padding:0 30px;height:70px;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:100}
        .navbar-brand{display:flex;align-items:center;gap:12px;font-size:24px;font-weight:700;color:#667eea;text-decoration:none}
        .navbar-menu{display:flex;gap:30px;align-items:center}
        .navbar-menu a{text-decoration:none;color:#666;font-weight:500;transition:color .3s}
        .navbar-menu a:hover,.navbar-menu a.active{color:#667eea;font-weight:600}
        .user-menu{display:flex;align-items:center;gap:15px}
        .user-info{text-align:right}
        .user-name{font-weight:600;color:#333;font-size:14px}
        .company-name{font-size:12px;color:#999}
        .logout-btn{padding:8px 20px;background:#f5f7fa;border:none;border-radius:6px;color:#666;cursor:pointer;font-weight:600;transition:all .3s}
        .logout-btn:hover{background:#667eea;color:#fff}
        .container{max-width:1400px;margin:0 auto;padding:40px 30px}
        .page-header{margin-bottom:20px}
        .page-title{font-size:32px;color:#333;margin-bottom:8px}
        .page-subtitle{color:#999;font-size:16px}
        .biz-filter-bar{background:#fff;border-radius:12px;padding:16px 20px;box-shadow:0 2px 8px rgba(0,0,0,.08);margin-bottom:30px;display:flex;align-items:center;gap:12px;flex-wrap:wrap}
        .biz-filter-label{font-size:14px;font-weight:600;color:#555;white-space:nowrap}
        .biz-filter-select{padding:9px 16px;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;cursor:pointer;background:#fff;min-width:180px;color:#333}
        .biz-filter-select:focus{outline:none;border-color:#667eea}
        .biz-filter-badge{font-size:12px;color:#667eea;background:#f0f0ff;padding:4px 10px;border-radius:10px;font-weight:500}
        .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:25px;margin-bottom:40px}
        .stat-card{background:#fff;border-radius:12px;padding:25px;box-shadow:0 2px 8px rgba(0,0,0,.08);transition:transform .3s,box-shadow .3s;cursor:pointer;text-decoration:none;color:inherit;display:block}
        .stat-card:hover{transform:translateY(-4px);box-shadow:0 8px 16px rgba(0,0,0,.12)}
        .stat-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:20px}
        .stat-icon{width:50px;height:50px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:24px}
        .stat-icon.blue{background:#e3f2fd}.stat-icon.green{background:#e8f5e9}.stat-icon.orange{background:#fff3e0}.stat-icon.purple{background:#f3e5f5}
        .stat-label{font-size:14px;color:#999;margin-bottom:8px}
        .stat-value{font-size:36px;font-weight:700;color:#333}
        .stat-change{font-size:13px;margin-top:10px;color:#999}
        .stat-change.positive{color:#27ae60}
        .stat-change.negative{color:#e74c3c}
        .quick-actions{background:#fff;border-radius:12px;padding:30px;box-shadow:0 2px 8px rgba(0,0,0,.08);margin-bottom:40px}
        .section-title{font-size:20px;font-weight:600;color:#333;margin-bottom:20px}
        .action-buttons{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:15px}
        .action-btn{padding:16px 24px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;border:none;border-radius:8px;font-size:15px;font-weight:600;cursor:pointer;transition:all .3s;display:flex;align-items:center;gap:10px;justify-content:center;text-decoration:none}
        .action-btn:hover{transform:translateY(-2px);box-shadow:0 8px 16px rgba(102,126,234,.3)}
        .action-btn.secondary{background:#fff;color:#667eea;border:2px solid #667eea}
        .action-btn.secondary:hover{background:#f5f7fa}
        .bottom-grid{display:grid;grid-template-columns:1fr 1fr;gap:25px}
        .recent-activity,.contract-summary{background:#fff;border-radius:12px;padding:30px;box-shadow:0 2px 8px rgba(0,0,0,.08)}
        .activity-list{list-style:none}
        .activity-item{padding:14px 0;border-bottom:1px solid #f0f0f0;display:flex;justify-content:space-between;align-items:center}
        .activity-item:last-child{border-bottom:none}
        .activity-content{display:flex;align-items:center;gap:12px}
        .activity-icon{width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0}
        .activity-icon.att{background:#e3f2fd}.activity-icon.vac{background:#e8f5e9}.activity-icon.con{background:#f3e5f5}.activity-icon.emp{background:#fff3e0}
        .activity-text{color:#333;font-size:14px}
        .activity-sub{color:#999;font-size:12px;margin-top:2px}
        .activity-time{color:#bbb;font-size:12px;white-space:nowrap;margin-left:10px}
        .summary-row{display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid #f0f0f0}
        .summary-row:last-child{border-bottom:none}
        .summary-label{color:#666;font-size:14px}
        .summary-value{font-weight:700;font-size:16px;color:#333}
        .summary-value.warn{color:#e67e22}
        .summary-value.ok{color:#27ae60}
        .loading{text-align:center;padding:60px 20px}
        .spinner{border:4px solid #f3f3f3;border-top:4px solid #667eea;border-radius:50%;width:50px;height:50px;animation:spin 1s linear infinite;margin:0 auto 20px}
        @keyframes spin{0%{transform:rotate(0)}to{transform:rotate(360deg)}}
        .empty-state{text-align:center;padding:40px 20px;color:#999}
        @media(max-width:768px){
            .container{padding:20px 15px}
            .bottom-grid{grid-template-columns:1fr}
            .navbar-menu{display:none}
            .biz-filter-bar{flex-direction:column;align-items:flex-start}
            .biz-filter-select{width:100%}
        }
    
        /* â”€â”€ ì•Œë¦¼ ì´ë ¥ íŒ¨ë„ â”€â”€ */
        .notif-panel{background:#fff;border-radius:12px;padding:30px;box-shadow:0 2px 8px rgba(0,0,0,.08);margin-top:25px}
        .notif-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
        .notif-tabs{display:flex;gap:8px;flex-wrap:wrap}
        .notif-tab{padding:5px 14px;border:1.5px solid #e0e0e0;border-radius:20px;font-size:13px;cursor:pointer;background:#fff;color:#666;font-weight:500;transition:all .2s}
        .notif-tab.active{background:#667eea;color:#fff;border-color:#667eea}
        .notif-mark-all{font-size:12px;color:#667eea;cursor:pointer;white-space:nowrap;padding:5px 0;font-weight:500}
        .notif-mark-all:hover{text-decoration:underline}
        .notif-badge{display:inline-flex;align-items:center;justify-content:center;min-width:18px;height:18px;background:#e74c3c;color:#fff;border-radius:9px;font-size:11px;font-weight:700;padding:0 4px;margin-left:5px;vertical-align:middle}
        .notif-list{list-style:none;max-height:380px;overflow-y:auto}
        .notif-item{display:flex;gap:12px;padding:13px 0;border-bottom:1px solid #f5f5f5;align-items:flex-start;cursor:pointer;transition:background .15s;border-radius:8px;padding-left:6px;padding-right:6px}
        .notif-item:hover{background:#f9f9ff}
        .notif-item:last-child{border-bottom:none}
        .notif-item.unread{background:#f7f7ff}
        .notif-dot{width:8px;height:8px;border-radius:50%;background:#667eea;margin-top:6px;flex-shrink:0}
        .notif-dot.read{background:transparent}
        .notif-icon{width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0}
        .notif-icon.payroll{background:#e8f5e9}.notif-icon.contract{background:#f3e5f5}.notif-icon.attendance{background:#e3f2fd}.notif-icon.vacation{background:#fff3e0}.notif-icon.default{background:#f5f5f5}
        .notif-body{flex:1;min-width:0}
        .notif-title{font-size:14px;font-weight:600;color:#333;margin-bottom:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .notif-msg{font-size:12px;color:#888;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .notif-meta{display:flex;justify-content:space-between;align-items:center;margin-top:3px}
        .notif-time{font-size:11px;color:#bbb;white-space:nowrap}
        .notif-channel{font-size:10px;padding:2px 7px;border-radius:10px;font-weight:500}
        .notif-channel.sms{background:#e3f2fd;color:#1565c0}
        .notif-channel.kakao{background:#fff9c4;color:#856404}
        .notif-channel.email{background:#f3e5f5;color:#6a1b9a}
        .notif-empty{text-align:center;padding:40px;color:#bbb;font-size:14px}
        .notif-load-more{text-align:center;padding:12px;color:#667eea;font-size:13px;cursor:pointer;font-weight:500}
        .notif-load-more:hover{text-decoration:underline}
    </style>
</head>
<body>
    <nav class="navbar">
        <a href="/dashboard.html" class="navbar-brand"><span>ğŸ‘‹</span><span>StaffManager</span></a>
        <div class="navbar-menu">
            <a href="/dashboard.html" class="active">ê´€ë¦¬</a>
            <a href="/employees.html">ì§ì› ê´€ë¦¬</a>
            <a href="/attendances.html">ì¶œí‡´ê·¼ ê´€ë¦¬</a>
            <a href="/calendar.html">íœ´ê°€ ê´€ë¦¬</a>
            <a href="/salary.html">ê¸‰ì—¬ ê´€ë¦¬</a>
            <a href="/contracts.html">ê³„ì•½ ê´€ë¦¬</a>
            <a href="/settings.html">ì„¤ì •</a>
        </div>
        <div class="user-menu">
            <div class="user-info">
                <div class="user-name" id="userName">ê´€ë¦¬</div>
                <div class="company-name" id="companyName">ì¸ìŠ¤í¼ë©</div>
            </div>
            <button class="logout-btn" onclick="handleLogout()">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </nav>

    <div class="container">
        <div class="page-header">
            <h1 class="page-title" id="greeting">ê´€ë¦¬</h1>
            <p class="page-subtitle" id="dateInfo">ë¡œë”©ì¤‘...</p>
        </div>

        <!-- ì‚¬ì—…ì¥ í•„í„° ë°” -->
        <div class="biz-filter-bar">
            <span class="biz-filter-label">ğŸ“ ì‚¬ì—…ì¥</span>
            <select class="biz-filter-select" id="bizFilterSelect" onchange="onBizFilterChange()">
                <option value="all">ì „ì²´ ì‚¬ì—…ì¥</option>
            </select>
            <span class="biz-filter-badge" id="bizFilterBadge" style="display:none"></span>
        </div>

        <div id="loadingState" class="loading">
            <div class="spinner"></div>
            <p style="color:#999">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
        </div>

        <div id="dashboardContent" style="display:none">
            <div class="stats-grid">
                <a class="stat-card" href="/employees.html">
                    <div class="stat-header">
                        <div>
                            <div class="stat-label">ì „ì²´ ì§ì›</div>
                            <div class="stat-value" id="totalEmployees">-</div>
                            <div class="stat-change" id="employeeChange"></div>
                        </div>
                        <div class="stat-icon blue">ğŸ§‘â€ğŸ¤â€ğŸ§‘</div>
                    </div>
                </a>
                <a class="stat-card" href="/salary.html">
                    <div class="stat-header">
                        <div>
                            <div class="stat-label">ì´ë²ˆ ë‹¬ ê¸‰ì—¬ ì˜ˆì •ì•¡</div>
                            <div class="stat-value" id="totalSalary">-</div>
                            <div class="stat-change" id="salaryInfo"></div>
                        </div>
                        <div class="stat-icon green">ğŸ’°</div>
                    </div>
                </a>
                <a class="stat-card" href="/attendances.html">
                    <div class="stat-header">
                        <div>
                            <div class="stat-label">ì˜¤ëŠ˜ ì¶œê·¼</div>
                            <div class="stat-value" id="todayAttendance">-</div>
                            <div class="stat-change" id="attendanceInfo"></div>
                        </div>
                        <div class="stat-icon orange">ğŸ•’</div>
                    </div>
                </a>
                <a class="stat-card" href="/contracts.html">
                    <div class="stat-header">
                        <div>
                            <div class="stat-label">ì „ì²´ ê³„ì•½ ê±´</div>
                            <div class="stat-value" id="contractSummary">-</div>
                            <div class="stat-change" id="contractInfo"></div>
                        </div>
                        <div class="stat-icon purple">ğŸ“œ</div>
                    </div>
                </a>
            </div>

            <div class="quick-actions">
                <h2 class="section-title">ë¹ ë¥¸ ì‹¤í–‰</h2>
                <div class="action-buttons">
                    <a class="action-btn" href="/employee-new.html"><span>â•</span><span>ì§ì› ë“±ë¡</span></a>
                    <a class="action-btn secondary" href="/attendances.html"><span>â°</span><span>ì¶œê·¼ ê¸°ë¡</span></a>
                    <a class="action-btn secondary" href="/contracts.html"><span>ğŸ“œ</span><span>ê³„ì•½ ì‘ì„±</span></a>
                    <a class="action-btn secondary" href="/calendar.html"><span>ğŸ—“ï¸</span><span>íœ´ê°€ ê´€ë¦¬</span></a>
                    <a class="action-btn secondary" href="/salary.html"><span>ğŸ’°</span><span>ê¸‰ì—¬ ì •ì‚°</span></a>
                    <a class="action-btn secondary" href="/company-settings.html"><span>âš™ï¸</span><span>íšŒì‚¬ ì„¤ì •</span></a>
                </div>
            </div>

            <div class="bottom-grid">
                <div class="recent-activity">
                    <h2 class="section-title">ìµœê·¼ í™œë™</h2>
                    <ul class="activity-list" id="activityList">
                        <li class="empty-state">ìµœê·¼ í™œë™ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</li>
                    </ul>
                </div>
                <div class="contract-summary">
                    <h2 class="section-title">ê³„ì•½ ìš”ì•½</h2>
                    <div id="summaryContent">
                        <div class="empty-state">ê³„ì•½ ìš”ì•½ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
                    </div>
                </div>
            </div>
        </div>

            <!-- â”€â”€ ì•Œë¦¼ ì´ë ¥ íŒ¨ë„ â”€â”€ -->
            <div class="notif-panel">
                <div class="notif-header">
                    <h2 class="section-title" style="margin-bottom:0">
                        ğŸ“¬ ì•Œë¦¼ ë°œì†¡ ì´ë ¥
                        <span class="notif-badge" id="notifUnreadBadge" style="display:none">0</span>
                    </h2>
                    <div style="display:flex;align-items:center;gap:16px">
                        <div class="notif-tabs">
                            <button class="notif-tab active" onclick="setNotifType('',this)">ì „ì²´</button>
                            <button class="notif-tab" onclick="setNotifType('payroll',this)">ğŸ’° ê¸‰ì—¬</button>
                            <button class="notif-tab" onclick="setNotifType('contract',this)">ğŸ“œ ê³„ì•½</button>
                            <button class="notif-tab" onclick="setNotifType('attendance',this)">â° ì¶œê·¼</button>
                            <button class="notif-tab" onclick="setNotifType('vacation',this)">ğŸ—“ï¸ íœ´ê°€</button>
                        </div>
                        <span class="notif-mark-all" onclick="markAllRead()">ëª¨ë‘ ì½ìŒ</span>
                    </div>
                </div>
                <ul class="notif-list" id="notifList">
                    <li class="notif-empty">ì•Œë¦¼ ì´ë ¥ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</li>
                </ul>
                <div class="notif-load-more" id="notifLoadMore" style="display:none" onclick="loadMoreNotifs()">ë” ë³´ê¸° â†“</div>
            </div>

        </div>
    </div>

<!-- âœ… [í•µì‹¬ìˆ˜ì •] businesses-filter.js (s ì¶”ê°€) - ì´ì „ì— business-filter.jsë¡œ ì˜ëª» ì‘ì„±ë˜ì–´ BusinessFilter ê°ì²´ ë¡œë“œ ì‹¤íŒ¨ -->
<script src="/businesses-filter.js"></script>
<script>
var authToken = null, userInfo = null;
var selectedBizId = 'all';
var businessList = [];

/* âœ… ì „ì²´ ë°ì´í„°ë¥¼ í•œ ë²ˆë§Œ ë¡œë“œí•´ì„œ ì €ì¥ (employees.htmlê³¼ ë™ì¼í•œ ë°©ì‹) */
var allEmployees = [];
var allAttendances = [];
var allVacations = [];
var allContracts = [];
var allConStats = {};

window.addEventListener('DOMContentLoaded', async function() {
    authToken = localStorage.getItem('authToken');
    var userInfoStr = localStorage.getItem('userInfo');
    if (!authToken || !userInfoStr) { window.location.href = '/login.html'; return; }
    try { userInfo = JSON.parse(userInfoStr); } catch (e) { window.location.href = '/login.html'; return; }

    document.getElementById('userName').textContent = userInfo.name || 'ê´€ë¦¬';
    document.getElementById('companyName').textContent = userInfo.companyName || '';

    var today = new Date();
    var days = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
    document.getElementById('greeting').textContent = 'ì•ˆë…•í•˜ì„¸ìš”, ' + (userInfo.name || 'ê´€ë¦¬') + '!';
    document.getElementById('dateInfo').textContent = today.getFullYear() + 'ë…„ ' + (today.getMonth()+1) + 'ì›” ' + today.getDate() + 'ì¼ (' + days[today.getDay()] + ')';

    await loadBusinesses();
    await loadAllData();      /* âœ… ì „ì²´ ë°ì´í„° í•œ ë²ˆë§Œ ë¡œë“œ */
    renderDashboard();        /* âœ… ë Œë”ë§ ë¶„ë¦¬ */
    loadNotifs(true);          /* ì•Œë¦¼ ì´ë ¥ ì´ˆê¸° ë¡œë“œ */
});

/* ì‚¬ì—…ì¥ ëª©ë¡ ë¡œë“œ */
async function loadBusinesses() {
    try {
        var r = await fetch('/.netlify/functions/businesses-list', {
            headers: { 'Authorization': 'Bearer ' + authToken }
        });
        var res = await r.json();
        if (res.success && res.businesses && res.businesses.length > 0) {
            businessList = res.businesses;
            var sel = document.getElementById('bizFilterSelect');
            businessList.forEach(function(b) {
                var opt = document.createElement('option');
                opt.value = b.id;
                opt.textContent = b.name + (b.is_headquarters ? ' (ë³¸ì )' : '');
                sel.appendChild(opt);
            });
            /* localStorageì—ì„œ ì´ì „ ì„ íƒê°’ ë³µì› */
            try {
                var saved = BusinessFilter.getSelected();
                if (saved && saved !== 'all') {
                    sel.value = saved;
                    selectedBizId = saved;
                    var biz = businessList.find(function(b) { return b.id === saved; });
                    if (biz) {
                        var badge = document.getElementById('bizFilterBadge');
                        badge.textContent = biz.name;
                        badge.style.display = 'inline-block';
                    }
                }
            } catch(e) { /* BusinessFilter ì—†ì–´ë„ ê³„ì† ë™ì‘ */ }
        }
    } catch (e) { console.error('ì‚¬ì—…ì¥ ëª©ë¡ ì˜¤ë¥˜:', e); }
}

/* âœ… ì „ì²´ ë°ì´í„° í•œ ë²ˆì— ë¡œë“œ (í•„í„° ì—†ì´ ì „ì²´) */
async function loadAllData() {
    var todayStr = new Date().toISOString().split('T')[0];
    var monthStart = todayStr.substring(0,8) + '01';

    var [empRes, attRes, vacRes, conRes] = await Promise.all([
        apiFetch('/.netlify/functions/employees-list'),                            /* ì „ì²´ ì§ì› */
        apiFetch('/.netlify/functions/attendances-list?startDate=' + todayStr + '&endDate=' + todayStr), /* ì˜¤ëŠ˜ ì¶œê·¼ */
        apiFetch('/.netlify/functions/vacations-list?start_date=' + monthStart + '&end_date=' + todayStr), /* ì´ë²ˆë‹¬ íœ´ê°€ */
        apiFetch('/.netlify/functions/contracts-list')                             /* ê³„ì•½ (í•„í„° ì—†ìŒ) */
    ]);

    allEmployees  = (empRes && empRes.success) ? (empRes.data.employees || []) : [];
    allAttendances = (attRes && attRes.success) ? (attRes.data.attendances || []) : [];
    allVacations  = (vacRes && vacRes.success) ? (vacRes.vacations || []) : [];
    allContracts  = (conRes && conRes.success) ? (conRes.data || []) : [];
    allConStats   = (conRes && conRes.success) ? (conRes.stats || {}) : {};
}

/* âœ… ì‚¬ì—…ì¥ ì„ íƒ ë³€ê²½ â†’ í´ë¼ì´ì–¸íŠ¸ í•„í„°ë§ë§Œ (API ì¬í˜¸ì¶œ ì—†ìŒ) */
function onBizFilterChange() {
    selectedBizId = document.getElementById('bizFilterSelect').value;

    /* BusinessFilterê°€ ë¡œë“œëì„ ë•Œë§Œ ì €ì¥ ì‹œë„ */
    try { BusinessFilter.setSelected(selectedBizId); } catch(e) {}

    var badge = document.getElementById('bizFilterBadge');
    if (selectedBizId === 'all') {
        badge.style.display = 'none';
    } else {
        var biz = businessList.find(function(b) { return b.id === selectedBizId; });
        badge.textContent = biz ? biz.name : '';
        badge.style.display = 'inline-block';
    }

    renderDashboard(); /* âœ… API ì¬í˜¸ì¶œ ì—†ì´ ë°”ë¡œ ë Œë”ë§ */
}

/* âœ… ë°ì´í„° ë Œë”ë§ (í´ë¼ì´ì–¸íŠ¸ í•„í„° ì ìš©) */
function renderDashboard() {
    /* ì§ì› í•„í„°ë§ */
    var employees = allEmployees;
    if (selectedBizId !== 'all') {
        employees = allEmployees.filter(function(e) {
            return (e.businessId || e.business_id) === selectedBizId;
        });
    }

    /* ì¶œê·¼ í•„í„°ë§ */
    var attendances = allAttendances;
    if (selectedBizId !== 'all') {
        attendances = allAttendances.filter(function(a) {
            var empBizId = a.employee && (a.employee.businessId || a.employee.business_id);
            /* ì¶œê·¼ ê¸°ë¡ì— business_id ì—†ìœ¼ë©´ ì§ì› ëª©ë¡ì—ì„œ ì¡°íšŒ */
            if (!empBizId && a.employee && a.employee.id) {
                var emp = allEmployees.find(function(e) { return e.id === a.employee.id; });
                empBizId = emp && (emp.businessId || emp.business_id);
            }
            return empBizId === selectedBizId;
        });
    }

    /* íœ´ê°€ í•„í„°ë§ */
    var vacations = allVacations;
    if (selectedBizId !== 'all') {
        vacations = allVacations.filter(function(v) {
            var empId = v.employee_id || (v.employee && v.employee.id);
            var emp = allEmployees.find(function(e) { return e.id === empId; });
            return emp && (emp.businessId || emp.business_id) === selectedBizId;
        });
    }

    var todayStr = new Date().toISOString().split('T')[0];

    /* ---- ì§ì› ì¹´ë“œ ---- */
    var activeEmps = employees.filter(function(e) { return e.status === 'active'; });
    document.getElementById('totalEmployees').textContent = activeEmps.length + 'ëª…';
    var thisMonth = todayStr.substring(0,7);
    var newThisMonth = employees.filter(function(e) {
        return e.hireDate && e.hireDate.substring(0,7) === thisMonth;
    }).length;
    var changeEl = document.getElementById('employeeChange');
    if (newThisMonth > 0) {
        changeEl.textContent = '+' + newThisMonth + 'ëª… ì´ë²ˆë‹¬ ì‹ ê·œ';
        changeEl.className = 'stat-change positive';
    } else {
        changeEl.textContent = 'í˜„ì¬ ' + activeEmps.length + ' / ' + employees.length + 'ëª… ì¬ì§';
        changeEl.className = 'stat-change';
    }

    /* ---- ê¸‰ì—¬ ì¹´ë“œ ---- */
    var totalWage = 0;
    activeEmps.forEach(function(e) { totalWage += (e.monthlyWage || e.baseSalary || 0); });
    document.getElementById('totalSalary').textContent = 'â‚©' + totalWage.toLocaleString('ko-KR');
    document.getElementById('salaryInfo').textContent = 'í˜„ì¬ ' + activeEmps.length + 'ëª… ê¸‰ì—¬';

    /* ---- ì¶œê·¼ ì¹´ë“œ ---- */
    var todayCheckins = attendances.length;
    document.getElementById('todayAttendance').textContent = todayCheckins + 'ëª…';
    var attInfo = document.getElementById('attendanceInfo');
    if (activeEmps.length > 0) {
        var rate = Math.round((todayCheckins / activeEmps.length) * 100);
        attInfo.textContent = 'ì¶œê·¼ìœ¨ ' + rate + '% (' + activeEmps.length + 'ëª…)';
        attInfo.className = rate >= 80 ? 'stat-change positive' : 'stat-change negative';
    } else {
        attInfo.textContent = 'ì•„ì§ ë“±ë¡ëœ ì§ì›ì´ ì—†ìŠµë‹ˆë‹¤';
        attInfo.className = 'stat-change';
    }

    /* ---- ê³„ì•½ ì¹´ë“œ (ì‚¬ì—…ì¥ í•„í„° ë¯¸ì ìš© - ê³„ì•½ì€ ì „ì‚¬ ê¸°ì¤€) ---- */
    var completed = allConStats.completed || allConStats.signed || 0;
    var pending = (allConStats.sent || 0) + (allConStats.viewed || 0);
    document.getElementById('contractSummary').textContent = (allConStats.total || 0) + 'ê±´';
    var conInfo = document.getElementById('contractInfo');
    var parts = [];
    if (completed > 0) parts.push('ì™„ë£Œ ' + completed);
    if (pending > 0) parts.push('ì§„í–‰ ' + pending);
    conInfo.textContent = parts.length > 0 ? parts.join('ê±´, ') + 'ê±´' : 'ê³„ì•½ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤';
    if (pending > 0) conInfo.className = 'stat-change negative';
    else conInfo.className = 'stat-change';

    /* ---- ê³„ì•½ ìš”ì•½ íŒ¨ë„ ---- */
    var summaryHtml = '';
    summaryHtml += '<div class="summary-row"><span class="summary-label">ì „ì²´ ì§ì›</span><span class="summary-value">' + activeEmps.length + 'ëª…</span></div>';
    summaryHtml += '<div class="summary-row"><span class="summary-label">ì´ë²ˆ ë‹¬ íœ´ê°€</span><span class="summary-value ' + (vacations.length > 0 ? 'warn' : '') + '">' + vacations.length + 'ê±´</span></div>';
    summaryHtml += '<div class="summary-row"><span class="summary-label">ì „ì²´ ê³„ì•½</span><span class="summary-value">' + (allConStats.total || 0) + 'ê±´</span></div>';
    summaryHtml += '<div class="summary-row"><span class="summary-label">ì™„ë£Œ ê³„ì•½</span><span class="summary-value ok">' + completed + 'ê±´</span></div>';
    summaryHtml += '<div class="summary-row"><span class="summary-label">ì§„í–‰ ê³„ì•½</span><span class="summary-value ' + (pending > 0 ? 'warn' : '') + '">' + pending + 'ê±´</span></div>';
    summaryHtml += '<div class="summary-row"><span class="summary-label">ì´ë²ˆë‹¬ ê¸‰ì—¬ ì˜ˆì •</span><span class="summary-value">â‚©' + totalWage.toLocaleString('ko-KR') + '</span></div>';
    document.getElementById('summaryContent').innerHTML = summaryHtml;

    /* ---- ìµœê·¼ í™œë™ ---- */
    var activities = [];
    attendances.forEach(function(a) {
        activities.push({ icon: 'â°', cls: 'att', text: (a.employee ? a.employee.name : 'ì§ì›') + ' ì¶œê·¼ ê¸°ë¡', sub: a.checkInTime ? new Date(a.checkInTime).toLocaleString('ko-KR', {hour:'2-digit',minute:'2-digit'}) : '', time: new Date(a.checkInTime) || new Date() });
    });
    allContracts.slice(0, 5).forEach(function(c) {
        var statusMap = { completed:'ê³„ì•½ ì™„ë£Œ', signed:'ê³„ì•½ ì™„ë£Œ', sent:'ë°œì†¡ ëŒ€ê¸°', viewed:'ì—´ëŒ', draft:'ì´ˆì•ˆ', rejected:'ê±°ì ˆ/ì·¨ì†Œ', expired:'ë§Œë£Œ' };
        var empName = c.employees ? c.employees.name : 'ì§ì›';
        activities.push({ icon: 'ğŸ“œ', cls: 'con', text: empName + 'ì˜ ê³„ì•½ ' + (statusMap[c.status] || c.status), sub: c.contract_type === 'standard_labor' ? 'í‘œì¤€ ê·¼ë¡œ ê³„ì•½' : (c.contract_type || ''), time: new Date(c.created_at) });
    });
    vacations.slice(0, 5).forEach(function(v) {
        var typeMap = { annual:'ì—°ì°¨', half_day_am:'ì˜¤ì „ ë°˜ì°¨', half_day_pm:'ì˜¤í›„ ë°˜ì°¨', sick:'ë³‘ê°€', special:'íŠ¹ë³„ íœ´ê°€' };
        var empName = v.employee ? (v.employee.name || 'ì§ì›') : 'ì§ì›';
        activities.push({ icon: 'ğŸ—“ï¸', cls: 'vac', text: empName + ' ' + (typeMap[v.vacation_type] || v.vacation_type || 'íœ´ê°€'), sub: v.start_date + (v.start_date !== v.end_date ? ' ~ ' + v.end_date : ''), time: new Date(v.created_at || v.start_date) });
    });
    activities.sort(function(a, b) { return b.time - a.time; });

    var listEl = document.getElementById('activityList');
    if (activities.length === 0) {
        listEl.innerHTML = '<li class="empty-state">ìµœê·¼ í™œë™ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
    } else {
        listEl.innerHTML = activities.slice(0, 10).map(function(a) {
            return '<li class="activity-item"><div class="activity-content"><div class="activity-icon ' + a.cls + '">' + a.icon + '</div><div><div class="activity-text">' + a.text + '</div>' + (a.sub ? '<div class="activity-sub">' + a.sub + '</div>' : '') + '</div></div><span class="activity-time">' + formatTimeAgo(a.time) + '</span></li>';
        }).join('');
    }

    document.getElementById('loadingState').style.display = 'none';
    document.getElementById('dashboardContent').style.display = 'block';
}

async function apiFetch(url) {
    try {
        var r = await fetch(url, { headers: { 'Authorization': 'Bearer ' + authToken, 'Content-Type': 'application/json' } });
        if (!r.ok) throw new Error('HTTP ' + r.status);
        return await r.json();
    } catch (e) { console.error('API ì—ëŸ¬ (' + url + '):', e); return null; }
}

function formatTimeAgo(date) {
    var now = new Date();
    var diff = Math.floor((now - date) / 1000);
    if (diff < 60) return 'ë°©ê¸ˆ ì „';
    if (diff < 3600) return Math.floor(diff/60) + 'ë¶„ ì „';
    if (diff < 86400) return Math.floor(diff/3600) + 'ì‹œê°„ ì „';
    if (diff < 604800) return Math.floor(diff/86400) + 'ì¼ ì „';
    return date.toLocaleDateString('ko-KR');
}


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ì•Œë¦¼ ì´ë ¥ ë·° ë¡œì§
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
var notifType = '';       // í˜„ì¬ í•„í„° íƒ€ì…
var notifOffset = 0;      // í˜ì´ì§€ë„¤ì´ì…˜ ì˜¤í”„ì…‹
var notifTotal = 0;       // ì „ì²´ ì•Œë¦¼ ìˆ˜
var NOTIF_LIMIT = 10;     // 1íšŒ ë¡œë”© ê±´ìˆ˜

/* íƒ€ì… ì•„ì´ì½˜ ë§¤í•‘ */
function notifIcon(type) {
    var map = { payroll: 'ğŸ’°', contract: 'ğŸ“œ', attendance: 'â°', vacation: 'ğŸ—“ï¸' };
    return map[type] || 'ğŸ””';
}

/* ì±„ë„ ë°°ì§€ */
function notifChannelBadge(n) {
    if (n.kakao_sent) return '<span class="notif-channel kakao">ì¹´ì¹´ì˜¤í†¡</span>';
    return '<span class="notif-channel sms">SMS</span>';
}

/* ì•Œë¦¼ íƒ­ ë³€ê²½ */
function setNotifType(type, el) {
    notifType = type;
    notifOffset = 0;
    document.querySelectorAll('.notif-tab').forEach(function(t){ t.classList.remove('active'); });
    if (el) el.classList.add('active');
    loadNotifs(true);
}

/* ë” ë³´ê¸° */
function loadMoreNotifs() {
    notifOffset += NOTIF_LIMIT;
    loadNotifs(false);
}

/* ì•Œë¦¼ ëª©ë¡ ë¡œë“œ */
async function loadNotifs(reset) {
    try {
        var url = '/.netlify/functions/notifications-list?limit=' + NOTIF_LIMIT + '&offset=' + notifOffset;
        if (notifType) url += '&type=' + notifType;

        var res = await apiFetch(url);
        if (!res || !res.success) return;

        notifTotal = res.pagination.total;

        /* ì½ì§€ ì•Šì€ ë°°ì§€ */
        var badge = document.getElementById('notifUnreadBadge');
        if (res.unread_count > 0) {
            badge.textContent = res.unread_count;
            badge.style.display = 'inline-flex';
        } else {
            badge.style.display = 'none';
        }

        var listEl = document.getElementById('notifList');
        var items = res.data || [];

        if (reset) {
            if (items.length === 0) {
                listEl.innerHTML = '<li class="notif-empty">ì•Œë¦¼ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
                document.getElementById('notifLoadMore').style.display = 'none';
                return;
            }
            listEl.innerHTML = '';
        }

        items.forEach(function(n) {
            var empName = (n.users && n.users.name) || 'ì§ì›';
            var li = document.createElement('li');
            li.className = 'notif-item' + (n.read ? '' : ' unread');
            li.dataset.id = n.id;
            li.innerHTML =
                '<div class="notif-dot' + (n.read ? ' read' : '') + '"></div>' +
                '<div class="notif-icon ' + (n.type || 'default') + '">' + notifIcon(n.type) + '</div>' +
                '<div class="notif-body">' +
                    '<div class="notif-title">' + (n.title || '') + '</div>' +
                    '<div class="notif-msg">' + empName + ' Â· ' + (n.message || '') + '</div>' +
                    '<div class="notif-meta">' +
                        '<span class="notif-time">' + formatTimeAgo(new Date(n.created_at)) + '</span>' +
                        notifChannelBadge(n) +
                    '</div>' +
                '</div>';
            li.onclick = function() { markRead([n.id], li); };
            listEl.appendChild(li);
        });

        /* ë” ë³´ê¸° ë²„íŠ¼ í‘œì‹œ ì—¬ë¶€ */
        var loaded = notifOffset + items.length;
        document.getElementById('notifLoadMore').style.display =
            loaded < notifTotal ? 'block' : 'none';

    } catch(e) { console.error('ì•Œë¦¼ ì´ë ¥ ë¡œë“œ ì‹¤íŒ¨:', e); }
}

/* ë‹¨ê±´ ì½ìŒ ì²˜ë¦¬ */
function markRead(ids, liEl) {
    apiFetchPatch('/.netlify/functions/notifications-list', { ids: ids });
    if (liEl) {
        liEl.classList.remove('unread');
        var dot = liEl.querySelector('.notif-dot');
        if (dot) dot.classList.add('read');
    }
    /* ë°°ì§€ ê°ì†Œ */
    var badge = document.getElementById('notifUnreadBadge');
    var cur = parseInt(badge.textContent) || 0;
    var next = Math.max(0, cur - ids.length);
    badge.textContent = next;
    badge.style.display = next > 0 ? 'inline-flex' : 'none';
}

/* ì „ì²´ ì½ìŒ ì²˜ë¦¬ */
function markAllRead() {
    apiFetchPatch('/.netlify/functions/notifications-list', {});
    document.querySelectorAll('.notif-item').forEach(function(li) {
        li.classList.remove('unread');
        var dot = li.querySelector('.notif-dot');
        if (dot) dot.classList.add('read');
    });
    var badge = document.getElementById('notifUnreadBadge');
    badge.style.display = 'none';
}

/* PATCH í—¬í¼ */
async function apiFetchPatch(url, body) {
    try {
        await fetch(url, {
            method: 'PATCH',
            headers: { 'Authorization': 'Bearer ' + authToken, 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });
    } catch(e) { console.error('PATCH ì‹¤íŒ¨:', e); }
}

function handleLogout() {
    if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        localStorage.removeItem('authToken');
        localStorage.removeItem('userInfo');
        try { localStorage.removeItem('sm_selected_business'); } catch(e) {}
        sessionStorage.clear();
        window.location.href = '/login.html';
    }
}
</script>
</body>
</html>