<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ëŒ€ì‹œë³´ë“œ - StaffManager</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','Roboto','Noto Sans KR',sans-serif;background:#f5f7fa;min-height:100vh}
        .navbar{background:#fff;box-shadow:0 2px 4px rgba(0,0,0,.1);padding:0 30px;height:70px;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:100}
        .navbar-brand{display:flex;align-items:center;gap:12px;font-size:24px;font-weight:700;color:#667eea;text-decoration:none}
        .navbar-menu{display:flex;gap:30px;align-items:center}
        .navbar-menu a{text-decoration:none;color:#666;font-weight:500;transition:color .3s}
        .navbar-menu a:hover,.navbar-menu a.active{color:#667eea;font-weight:600}
        .user-menu{display:flex;align-items:center;gap:15px}
        .user-info{text-align:right}
        .user-name{font-weight:600;color:#333;font-size:14px}
        .company-name{font-size:12px;color:#999}
        .logout-btn{padding:8px 20px;background:#f5f7fa;border:none;border-radius:6px;color:#666;cursor:pointer;font-weight:600;transition:all .3s}
        .logout-btn:hover{background:#667eea;color:#fff}
        .container{max-width:1400px;margin:0 auto;padding:40px 30px}
        .page-header{margin-bottom:40px}
        .page-title{font-size:32px;color:#333;margin-bottom:8px}
        .page-subtitle{color:#999;font-size:16px}
        .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:25px;margin-bottom:40px}
        .stat-card{background:#fff;border-radius:12px;padding:25px;box-shadow:0 2px 8px rgba(0,0,0,.08);transition:transform .3s,box-shadow .3s;cursor:pointer;text-decoration:none;color:inherit;display:block}
        .stat-card:hover{transform:translateY(-4px);box-shadow:0 8px 16px rgba(0,0,0,.12)}
        .stat-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:20px}
        .stat-icon{width:50px;height:50px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:24px}
        .stat-icon.blue{background:#e3f2fd}.stat-icon.green{background:#e8f5e9}.stat-icon.orange{background:#fff3e0}.stat-icon.purple{background:#f3e5f5}
        .stat-label{font-size:14px;color:#999;margin-bottom:8px}
        .stat-value{font-size:36px;font-weight:700;color:#333}
        .stat-change{font-size:13px;margin-top:10px;color:#999}
        .stat-change.positive{color:#27ae60}
        .stat-change.negative{color:#e74c3c}
        .quick-actions{background:#fff;border-radius:12px;padding:30px;box-shadow:0 2px 8px rgba(0,0,0,.08);margin-bottom:40px}
        .section-title{font-size:20px;font-weight:600;color:#333;margin-bottom:20px}
        .action-buttons{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:15px}
        .action-btn{padding:16px 24px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;border:none;border-radius:8px;font-size:15px;font-weight:600;cursor:pointer;transition:all .3s;display:flex;align-items:center;gap:10px;justify-content:center;text-decoration:none}
        .action-btn:hover{transform:translateY(-2px);box-shadow:0 8px 16px rgba(102,126,234,.3)}
        .action-btn.secondary{background:#fff;color:#667eea;border:2px solid #667eea}
        .action-btn.secondary:hover{background:#f5f7fa}
        .bottom-grid{display:grid;grid-template-columns:1fr 1fr;gap:25px}
        .recent-activity,.contract-summary{background:#fff;border-radius:12px;padding:30px;box-shadow:0 2px 8px rgba(0,0,0,.08)}
        .activity-list{list-style:none}
        .activity-item{padding:14px 0;border-bottom:1px solid #f0f0f0;display:flex;justify-content:space-between;align-items:center}
        .activity-item:last-child{border-bottom:none}
        .activity-content{display:flex;align-items:center;gap:12px}
        .activity-icon{width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0}
        .activity-icon.att{background:#e3f2fd}.activity-icon.vac{background:#e8f5e9}.activity-icon.con{background:#f3e5f5}.activity-icon.emp{background:#fff3e0}
        .activity-text{color:#333;font-size:14px}
        .activity-sub{color:#999;font-size:12px;margin-top:2px}
        .activity-time{color:#bbb;font-size:12px;white-space:nowrap;margin-left:10px}
        .summary-row{display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid #f0f0f0}
        .summary-row:last-child{border-bottom:none}
        .summary-label{color:#666;font-size:14px}
        .summary-value{font-weight:700;font-size:16px;color:#333}
        .summary-value.warn{color:#e67e22}
        .summary-value.ok{color:#27ae60}
        .loading{text-align:center;padding:60px 20px}
        .spinner{border:4px solid #f3f3f3;border-top:4px solid #667eea;border-radius:50%;width:50px;height:50px;animation:spin 1s linear infinite;margin:0 auto 20px}
        @keyframes spin{0%{transform:rotate(0)}to{transform:rotate(360deg)}}
        .empty-state{text-align:center;padding:40px 20px;color:#999}
        @media(max-width:768px){
            .container{padding:20px 15px}
            .bottom-grid{grid-template-columns:1fr}
            .navbar-menu{display:none}
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <a href="/dashboard.html" class="navbar-brand"><span>ğŸ¯</span><span>StaffManager</span></a>
        <div class="navbar-menu">
            <a href="/dashboard.html" class="active">ëŒ€ì‹œë³´ë“œ</a>
            <a href="/employees.html">ì§ì› ê´€ë¦¬</a>
            <a href="/attendances.html">ì¶œí‡´ê·¼ ê´€ë¦¬</a>
            <a href="/calendar.html">íœ´ê°€ ê´€ë¦¬</a>
            <a href="/salary.html">ê¸‰ì—¬ ê´€ë¦¬</a>
            <a href="/contracts.html">ê³„ì•½ ê´€ë¦¬</a>
            <a href="/settings.html">ì„¤ì •</a>
        </div>
        <div class="user-menu">
            <div class="user-info">
                <div class="user-name" id="userName">ì‚¬ìš©ì</div>
                <div class="company-name" id="companyName">íšŒì‚¬ëª…</div>
            </div>
            <button class="logout-btn" onclick="handleLogout()">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </nav>

    <div class="container">
        <div class="page-header">
            <h1 class="page-title" id="greeting">ëŒ€ì‹œë³´ë“œ</h1>
            <p class="page-subtitle" id="dateInfo">ì˜¤ëŠ˜ì˜ ì¸ì‚¬ í˜„í™©ì„ í•œëˆˆì— í™•ì¸í•˜ì„¸ìš”</p>
        </div>

        <div id="loadingState" class="loading">
            <div class="spinner"></div>
            <p style="color:#999">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        </div>

        <div id="dashboardContent" style="display:none">
            <div class="stats-grid">
                <a class="stat-card" href="/employees.html">
                    <div class="stat-header">
                        <div>
                            <div class="stat-label">ì „ì²´ ì§ì›</div>
                            <div class="stat-value" id="totalEmployees">-</div>
                            <div class="stat-change" id="employeeChange"></div>
                        </div>
                        <div class="stat-icon blue">ğŸ‘¥</div>
                    </div>
                </a>
                <a class="stat-card" href="/salary.html">
                    <div class="stat-header">
                        <div>
                            <div class="stat-label">ì´ë²ˆ ë‹¬ ê¸‰ì—¬ ì´ì•¡</div>
                            <div class="stat-value" id="totalSalary">-</div>
                            <div class="stat-change" id="salaryInfo"></div>
                        </div>
                        <div class="stat-icon green">ğŸ’°</div>
                    </div>
                </a>
                <a class="stat-card" href="/attendances.html">
                    <div class="stat-header">
                        <div>
                            <div class="stat-label">ì˜¤ëŠ˜ ì¶œê·¼</div>
                            <div class="stat-value" id="todayAttendance">-</div>
                            <div class="stat-change" id="attendanceInfo"></div>
                        </div>
                        <div class="stat-icon orange">ğŸ“…</div>
                    </div>
                </a>
                <a class="stat-card" href="/contracts.html">
                    <div class="stat-header">
                        <div>
                            <div class="stat-label">ì „ìê³„ì•½ í˜„í™©</div>
                            <div class="stat-value" id="contractSummary">-</div>
                            <div class="stat-change" id="contractInfo"></div>
                        </div>
                        <div class="stat-icon purple">ğŸ“„</div>
                    </div>
                </a>
            </div>

            <div class="quick-actions">
                <h2 class="section-title">ë¹ ë¥¸ ì‹¤í–‰</h2>
                <div class="action-buttons">
                    <a class="action-btn" href="/employee-new.html"><span>â•</span><span>ì§ì› ë“±ë¡</span></a>
                    <a class="action-btn secondary" href="/attendances.html"><span>â°</span><span>ì¶œí‡´ê·¼ ê¸°ë¡</span></a>
                    <a class="action-btn secondary" href="/contracts.html"><span>ğŸ“„</span><span>ê³„ì•½ì„œ ë°œì†¡</span></a>
                    <a class="action-btn secondary" href="/calendar.html"><span>ğŸ—“ï¸</span><span>íœ´ê°€ ê´€ë¦¬</span></a>
                    <a class="action-btn secondary" href="/salary.html"><span>ğŸ’°</span><span>ê¸‰ì—¬ ê³„ì‚°</span></a>
                    <a class="action-btn secondary" href="/company-settings.html"><span>ğŸ¢</span><span>ì‚¬ì—…ì¥ ì„¤ì •</span></a>
                </div>
            </div>

            <div class="bottom-grid">
                <div class="recent-activity">
                    <h2 class="section-title">ìµœê·¼ í™œë™</h2>
                    <ul class="activity-list" id="activityList">
                        <li class="empty-state">í™œë™ ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</li>
                    </ul>
                </div>
                <div class="contract-summary">
                    <h2 class="section-title">í˜„í™© ìš”ì•½</h2>
                    <div id="summaryContent">
                        <div class="empty-state">ìš”ì•½ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
var authToken = null, userInfo = null;

window.addEventListener('DOMContentLoaded', async function() {
    authToken = localStorage.getItem('authToken');
    var userInfoStr = localStorage.getItem('userInfo');
    if (!authToken || !userInfoStr) { window.location.href = '/login.html'; return; }
    try { userInfo = JSON.parse(userInfoStr); } catch(e) { window.location.href = '/login.html'; return; }

    document.getElementById('userName').textContent = userInfo.name || 'ì‚¬ìš©ì';
    document.getElementById('companyName').textContent = userInfo.companyName || '';

    var h = new Date().getHours();
    var greet = h < 12 ? 'ì¢‹ì€ ì•„ì¹¨ì´ì—ìš”' : h < 18 ? 'ì¢‹ì€ ì˜¤í›„ì˜ˆìš”' : 'ìˆ˜ê³ í•˜ì…¨ì–´ìš”';
    document.getElementById('greeting').textContent = greet + ', ' + (userInfo.name || 'ì‚¬ì¥ë‹˜') + '!';

    var today = new Date();
    var days = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
    document.getElementById('dateInfo').textContent = today.getFullYear() + 'ë…„ ' + (today.getMonth()+1) + 'ì›” ' + today.getDate() + 'ì¼ (' + days[today.getDay()] + ')';

    await loadDashboardData();
});

async function apiFetch(url) {
    try {
        var r = await fetch(url, { headers: { 'Authorization': 'Bearer ' + authToken, 'Content-Type': 'application/json' } });
        if (!r.ok) throw new Error('HTTP ' + r.status);
        return await r.json();
    } catch(e) { console.error('API error (' + url + '):', e); return null; }
}

async function loadDashboardData() {
    var todayStr = new Date().toISOString().split('T')[0];
    var monthStart = todayStr.substring(0,8) + '01';

    var [empRes, attRes, vacRes, conRes] = await Promise.all([
        apiFetch('/.netlify/functions/employees-list'),
        apiFetch('/.netlify/functions/attendances-list?startDate=' + todayStr + '&endDate=' + todayStr),
        apiFetch('/.netlify/functions/vacations-list?start_date=' + monthStart + '&end_date=' + todayStr),
        apiFetch('/.netlify/functions/contracts-list')
    ]);

    var employees = (empRes && empRes.success) ? (empRes.data.employees || []) : [];
    var activeEmps = employees.filter(function(e) { return e.status === 'active'; });
    document.getElementById('totalEmployees').textContent = activeEmps.length + 'ëª…';

    var thisMonth = todayStr.substring(0,7);
    var newThisMonth = employees.filter(function(e) {
        return e.hireDate && e.hireDate.substring(0,7) === thisMonth;
    }).length;
    var changeEl = document.getElementById('employeeChange');
    if (newThisMonth > 0) {
        changeEl.textContent = '+' + newThisMonth + 'ëª… ì´ë²ˆ ë‹¬ ì…ì‚¬';
        changeEl.className = 'stat-change positive';
    } else {
        changeEl.textContent = 'ì¬ì§ ' + activeEmps.length + ' Â· ì „ì²´ ' + employees.length;
    }

    var totalWage = 0;
    activeEmps.forEach(function(e) { totalWage += (e.monthlyWage || e.baseSalary || 0); });
    document.getElementById('totalSalary').textContent = '\u20A9' + totalWage.toLocaleString('ko-KR');
    document.getElementById('salaryInfo').textContent = 'ì¬ì§ ' + activeEmps.length + 'ëª… ê¸°ì¤€';

    var attendances = (attRes && attRes.success) ? (attRes.data.attendances || []) : [];
    var todayCheckins = attendances.length;
    document.getElementById('todayAttendance').textContent = todayCheckins + 'ëª…';
    var attInfo = document.getElementById('attendanceInfo');
    if (activeEmps.length > 0) {
        var rate = Math.round((todayCheckins / activeEmps.length) * 100);
        attInfo.textContent = 'ì¶œê·¼ìœ¨ ' + rate + '% (ì¬ì§ ' + activeEmps.length + 'ëª…)';
        attInfo.className = rate >= 80 ? 'stat-change positive' : 'stat-change negative';
    } else {
        attInfo.textContent = 'ë“±ë¡ëœ ì§ì›ì´ ì—†ìŠµë‹ˆë‹¤';
    }

    var contracts = (conRes && conRes.success) ? (conRes.data || []) : [];
    var conStats = (conRes && conRes.success) ? (conRes.stats || {}) : {};
    var completed = conStats.completed || conStats.signed || 0;
    var pending = (conStats.sent || 0) + (conStats.viewed || 0);
    document.getElementById('contractSummary').textContent = (conStats.total || 0) + 'ê±´';
    var conInfo = document.getElementById('contractInfo');
    var parts = [];
    if (completed > 0) parts.push('ì„œëª…ì™„ë£Œ ' + completed);
    if (pending > 0) parts.push('ëŒ€ê¸° ' + pending);
    conInfo.textContent = parts.length > 0 ? parts.join(' Â· ') : 'ê³„ì•½ ì—†ìŒ';
    if (pending > 0) conInfo.className = 'stat-change negative';

    var vacations = (vacRes && vacRes.success) ? (vacRes.vacations || []) : [];
    var summaryHtml = '';
    summaryHtml += '<div class="summary-row"><span class="summary-label">ì¬ì§ ì§ì›</span><span class="summary-value">' + activeEmps.length + 'ëª…</span></div>';
    summaryHtml += '<div class="summary-row"><span class="summary-label">ì´ë²ˆ ë‹¬ íœ´ê°€</span><span class="summary-value' + (vacations.length > 0 ? ' warn' : '') + '">' + vacations.length + 'ê±´</span></div>';
    summaryHtml += '<div class="summary-row"><span class="summary-label">ì „ìê³„ì•½ ì´</span><span class="summary-value">' + (conStats.total || 0) + 'ê±´</span></div>';
    summaryHtml += '<div class="summary-row"><span class="summary-label">ì„œëª… ì™„ë£Œ</span><span class="summary-value ok">' + completed + 'ê±´</span></div>';
    summaryHtml += '<div class="summary-row"><span class="summary-label">ì„œëª… ëŒ€ê¸°</span><span class="summary-value' + (pending > 0 ? ' warn' : '') + '">' + pending + 'ê±´</span></div>';
    summaryHtml += '<div class="summary-row"><span class="summary-label">ì´ë²ˆ ë‹¬ ê¸‰ì—¬ ì´ì•¡</span><span class="summary-value">\u20A9' + totalWage.toLocaleString('ko-KR') + '</span></div>';
    document.getElementById('summaryContent').innerHTML = summaryHtml;

    var activities = [];
    attendances.forEach(function(a) {
        activities.push({ icon: 'â°', cls: 'att', text: (a.employee ? a.employee.name : 'ì§ì›') + ' ì¶œê·¼', sub: a.checkInTime ? new Date(a.checkInTime).toLocaleTimeString('ko-KR', {hour:'2-digit',minute:'2-digit'}) : '', time: a.checkInTime ? new Date(a.checkInTime) : new Date() });
    });
    contracts.slice(0, 5).forEach(function(c) {
        var statusMap = { completed:'ì„œëª… ì™„ë£Œ', signed:'ì„œëª… ì™„ë£Œ', sent:'ë°œì†¡ë¨', viewed:'ì—´ëŒí•¨', draft:'ì‘ì„± ì¤‘' };
        var empName = c.employees ? c.employees.name : 'ì§ì›';
        activities.push({ icon: 'ğŸ“„', cls: 'con', text: empName + ' ê·¼ë¡œê³„ì•½ì„œ ' + (statusMap[c.status] || c.status), sub: c.contract_type === 'standard_labor' ? 'í‘œì¤€ ê·¼ë¡œê³„ì•½ì„œ' : (c.contract_type || ''), time: new Date(c.created_at) });
    });
    vacations.slice(0, 5).forEach(function(v) {
        var typeMap = { annual:'ì—°ì°¨', half_day_am:'ì˜¤ì „ë°˜ì°¨', half_day_pm:'ì˜¤í›„ë°˜ì°¨', sick:'ë³‘ê°€', special:'íŠ¹ë³„íœ´ê°€' };
        var empName = v.employee ? v.employee.name : 'ì§ì›';
        activities.push({ icon: 'ğŸ—“ï¸', cls: 'vac', text: empName + ' ' + (typeMap[v.vacation_type] || v.vacation_type || 'íœ´ê°€'), sub: v.start_date + (v.start_date !== v.end_date ? ' ~ ' + v.end_date : ''), time: new Date(v.created_at || v.start_date) });
    });
    activities.sort(function(a, b) { return b.time - a.time; });

    var listEl = document.getElementById('activityList');
    if (activities.length === 0) {
        listEl.innerHTML = '<li class="empty-state">ìµœê·¼ í™œë™ì´ ì—†ìŠµë‹ˆë‹¤</li>';
    } else {
        listEl.innerHTML = activities.slice(0, 10).map(function(a) {
            return '<li class="activity-item"><div class="activity-content"><div class="activity-icon ' + a.cls + '">' + a.icon + '</div><div><div class="activity-text">' + a.text + '</div>' + (a.sub ? '<div class="activity-sub">' + a.sub + '</div>' : '') + '</div></div><span class="activity-time">' + formatTimeAgo(a.time) + '</span></li>';
        }).join('');
    }

    document.getElementById('loadingState').style.display = 'none';
    document.getElementById('dashboardContent').style.display = 'block';
}

function formatTimeAgo(date) {
    var now = new Date();
    var diff = Math.floor((now - date) / 1000);
    if (diff < 60) return 'ë°©ê¸ˆ ì „';
    if (diff < 3600) return Math.floor(diff/60) + 'ë¶„ ì „';
    if (diff < 86400) return Math.floor(diff/3600) + 'ì‹œê°„ ì „';
    if (diff < 604800) return Math.floor(diff/86400) + 'ì¼ ì „';
    return date.toLocaleDateString('ko-KR');
}

function handleLogout() {
    if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        localStorage.removeItem('authToken');
        localStorage.removeItem('userInfo');
        window.location.href = '/login.html';
    }
}
</script>
</body>
</html>
