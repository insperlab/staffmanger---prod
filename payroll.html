<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ê¸‰ì—¬ ê´€ë¦¬ - StaffManager</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    h1 {
      font-size: 28px;
      margin-bottom: 30px;
      color: #333;
    }

    .filter-section {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr auto;
      gap: 15px;
      margin-bottom: 30px;
      padding: 20px;
      background: #f9f9f9;
      border-radius: 8px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    label {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 8px;
      color: #555;
    }

    select, input {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
    }

    button {
      padding: 10px 24px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      align-self: flex-end;
    }

    button:hover {
      background: #45a049;
    }

    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .payroll-detail {
      display: none;
      margin-top: 30px;
    }

    .payroll-detail.show {
      display: block;
    }

    .detail-header {
      background: #f0f0f0;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .detail-header h2 {
      font-size: 20px;
      margin-bottom: 10px;
    }

    .detail-header p {
      color: #666;
      font-size: 14px;
    }

    .detail-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin-bottom: 30px;
    }

    .detail-card {
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 20px;
    }

    .detail-card h3 {
      font-size: 14px;
      color: #666;
      margin-bottom: 15px;
      font-weight: 600;
    }

    .detail-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #f0f0f0;
    }

    .detail-row:last-child {
      border-bottom: none;
    }

    .detail-label {
      font-size: 14px;
      color: #666;
    }

    .detail-value {
      font-size: 14px;
      font-weight: 600;
      color: #333;
    }

    .total-section {
      background: #f0f7ff;
      border: 2px solid #2196F3;
      border-radius: 8px;
      padding: 30px;
      text-align: center;
    }

    .total-section h3 {
      font-size: 16px;
      color: #666;
      margin-bottom: 10px;
    }

    .total-amount {
      font-size: 36px;
      font-weight: 700;
      color: #2196F3;
    }

    .error-message {
      background: #ffebee;
      color: #c62828;
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 20px;
      display: none;
    }

    .error-message.show {
      display: block;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
      display: none;
    }

    .loading.show {
      display: block;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ’° ê¸‰ì—¬ ê´€ë¦¬</h1>

    <div class="error-message" id="errorMessage"></div>
    <div class="loading" id="loading">ê¸‰ì—¬ë¥¼ ê³„ì‚°í•˜ê³  ìˆìŠµë‹ˆë‹¤...</div>

    <div class="filter-section">
      <div class="form-group">
        <label>ì§ì› ì„ íƒ</label>
        <select id="employeeSelect">
          <option value="">ì§ì›ì„ ì„ íƒí•˜ì„¸ìš”</option>
        </select>
      </div>

      <div class="form-group">
        <label>ë…„ë„</label>
        <select id="yearSelect">
          <option value="2026">2026ë…„</option>
          <option value="2025">2025ë…„</option>
          <option value="2024">2024ë…„</option>
        </select>
      </div>

      <div class="form-group">
        <label>ì›”</label>
        <select id="monthSelect">
          <option value="1">1ì›”</option>
          <option value="2">2ì›”</option>
          <option value="3">3ì›”</option>
          <option value="4">4ì›”</option>
          <option value="5">5ì›”</option>
          <option value="6">6ì›”</option>
          <option value="7">7ì›”</option>
          <option value="8">8ì›”</option>
          <option value="9">9ì›”</option>
          <option value="10">10ì›”</option>
          <option value="11">11ì›”</option>
          <option value="12">12ì›”</option>
        </select>
      </div>

      <div class="form-group">
        <label>&nbsp;</label>
        <button id="calculateBtn">ê¸‰ì—¬ ê³„ì‚°</button>
      </div>
    </div>

    <div class="payroll-detail" id="payrollDetail">
      <div class="detail-header">
        <h2 id="employeeName"></h2>
        <p id="periodInfo"></p>
      </div>

      <div class="detail-grid">
        <div class="detail-card">
          <h3>ê·¼ë¬´ ì •ë³´</h3>
          <div class="detail-row">
            <span class="detail-label">ì´ ì¶œê·¼ì¼ìˆ˜</span>
            <span class="detail-value" id="totalDays">-</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">ì´ ê·¼ë¬´ì‹œê°„</span>
            <span class="detail-value" id="totalHours">-</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">ì •ê·œ ê·¼ë¬´</span>
            <span class="detail-value" id="regularHours">-</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">ì—°ì¥ ê·¼ë¬´</span>
            <span class="detail-value" id="overtimeHours">-</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">ì•¼ê°„ ê·¼ë¬´</span>
            <span class="detail-value" id="nightHours">-</span>
          </div>
        </div>

        <div class="detail-card">
          <h3>ì§€ê¸‰ ë‚´ì—­</h3>
          <div class="detail-row">
            <span class="detail-label">ê¸°ë³¸ê¸‰</span>
            <span class="detail-value" id="basicPay">-</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">ì£¼íœ´ìˆ˜ë‹¹</span>
            <span class="detail-value" id="weeklyPay">-</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">ì—°ì¥ìˆ˜ë‹¹</span>
            <span class="detail-value" id="overtimePay">-</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">ì•¼ê°„ìˆ˜ë‹¹</span>
            <span class="detail-value" id="nightPay">-</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">íœ´ì¼ìˆ˜ë‹¹</span>
            <span class="detail-value" id="holidayPay">-</span>
          </div>
        </div>

        <div class="detail-card">
          <h3>ê³µì œ ë‚´ì—­</h3>
          <div class="detail-row">
            <span class="detail-label">êµ­ë¯¼ì—°ê¸ˆ</span>
            <span class="detail-value" id="pension">-</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">ê±´ê°•ë³´í—˜</span>
            <span class="detail-value" id="health">-</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">ì¥ê¸°ìš”ì–‘</span>
            <span class="detail-value" id="longTerm">-</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">ê³ ìš©ë³´í—˜</span>
            <span class="detail-value" id="employment">-</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">ì†Œë“ì„¸</span>
            <span class="detail-value" id="incomeTax">-</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">ì§€ë°©ì†Œë“ì„¸</span>
            <span class="detail-value" id="localTax">-</span>
          </div>
        </div>
      </div>

      <div class="total-section">
        <h3>ì‹¤ìˆ˜ë ¹ì•¡</h3>
        <div class="total-amount" id="netPayment">0ì›</div>
        <p style="margin-top: 10px; color: #666;">ì´ ì§€ê¸‰ì•¡: <span id="totalPayment">0ì›</span> | ì´ ê³µì œì•¡: <span id="totalDeductions">0ì›</span></p>
      </div>
    </div>
  </div>

  <script>
    const authToken = localStorage.getItem('authToken');
    const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');

    if (!authToken || !userInfo.companyId) {
      alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
      window.location.href = '/login.html';
    }

    let employees = [];

    // ì§ì› ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    async function loadEmployees() {
      try {
        const response = await fetch('/.netlify/functions/employees-list', {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${authToken}`
          }
        });

        const result = await response.json();
        if (result.success && result.data && result.data.employees) {
          employees = result.data.employees;
          const select = document.getElementById('employeeSelect');
          employees.forEach(emp => {
            const option = document.createElement('option');
            option.value = emp.id;
            option.textContent = `${emp.name || 'ì´ë¦„ì—†ìŒ'} (${emp.phone || '-'})`;
            select.appendChild(option);
          });
        }
      } catch (error) {
        console.error('ì§ì› ëª©ë¡ ë¡œë”© ì‹¤íŒ¨:', error);
      }
    }

    // ê¸‰ì—¬ ê³„ì‚°
    async function calculatePayroll() {
      const employeeId = document.getElementById('employeeSelect').value;
      const year = parseInt(document.getElementById('yearSelect').value);
      const month = parseInt(document.getElementById('monthSelect').value);

      if (!employeeId) {
        showError('ì§ì›ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }

      const loading = document.getElementById('loading');
      const detail = document.getElementById('payrollDetail');
      const errorMsg = document.getElementById('errorMessage');
      const btn = document.getElementById('calculateBtn');

      loading.classList.add('show');
      detail.classList.remove('show');
      errorMsg.classList.remove('show');
      btn.disabled = true;

      try {
        const response = await fetch('/.netlify/functions/calculate-payroll', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${authToken}`
          },
          body: JSON.stringify({ employeeId, year, month })
        });

        const result = await response.json();
        
        if (result.success && result.data) {
          displayPayroll(result.data, employeeId, year, month);
        } else {
          showError(result.error || 'ê¸‰ì—¬ ê³„ì‚°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
      } catch (error) {
        console.error('ê¸‰ì—¬ ê³„ì‚° ì˜¤ë¥˜:', error);
        showError('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      } finally {
        loading.classList.remove('show');
        btn.disabled = false;
      }
    }

    // ê¸‰ì—¬ ìƒì„¸ í‘œì‹œ
    function displayPayroll(data, employeeId, year, month) {
      const employee = employees.find(e => e.id === employeeId);
      
      document.getElementById('employeeName').textContent = employee?.name || 'ì§ì›';
      document.getElementById('periodInfo').textContent = `${year}ë…„ ${month}ì›” ê¸‰ì—¬`;

      // ê·¼ë¬´ ì •ë³´
      document.getElementById('totalDays').textContent = `${data.total_work_days}ì¼`;
      document.getElementById('totalHours').textContent = `${data.total_work_hours.toFixed(1)}ì‹œê°„`;
      document.getElementById('regularHours').textContent = `${data.regular_work_hours.toFixed(1)}ì‹œê°„`;
      document.getElementById('overtimeHours').textContent = `${data.overtime_hours.toFixed(1)}ì‹œê°„`;
      document.getElementById('nightHours').textContent = `${data.night_work_hours.toFixed(1)}ì‹œê°„`;

      // ì§€ê¸‰ ë‚´ì—­
      document.getElementById('basicPay').textContent = formatMoney(data.basic_pay);
      document.getElementById('weeklyPay').textContent = formatMoney(data.weekly_holiday_pay);
      document.getElementById('overtimePay').textContent = formatMoney(data.overtime_pay);
      document.getElementById('nightPay').textContent = formatMoney(data.night_work_pay);
      document.getElementById('holidayPay').textContent = formatMoney(data.holiday_work_pay);

      // ê³µì œ ë‚´ì—­
      document.getElementById('pension').textContent = formatMoney(data.national_pension);
      document.getElementById('health').textContent = formatMoney(data.health_insurance);
      document.getElementById('longTerm').textContent = formatMoney(data.long_term_care);
      document.getElementById('employment').textContent = formatMoney(data.employment_insurance);
      document.getElementById('incomeTax').textContent = formatMoney(data.income_tax);
      document.getElementById('localTax').textContent = formatMoney(data.local_income_tax);

      // ì´ì•¡
      document.getElementById('totalPayment').textContent = formatMoney(data.total_payment);
      document.getElementById('totalDeductions').textContent = formatMoney(data.total_deductions);
      document.getElementById('netPayment').textContent = formatMoney(data.net_payment);

      document.getElementById('payrollDetail').classList.add('show');
    }

    function formatMoney(amount) {
      return new Intl.NumberFormat('ko-KR', {
        style: 'currency',
        currency: 'KRW'
      }).format(amount);
    }

    function showError(message) {
      const errorMsg = document.getElementById('errorMessage');
      errorMsg.textContent = message;
      errorMsg.classList.add('show');
    }

    // í˜„ì¬ ë…„ì›”ë¡œ ì´ˆê¸°í™”
    const now = new Date();
    document.getElementById('yearSelect').value = now.getFullYear();
    document.getElementById('monthSelect').value = now.getMonth() + 1;

    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    document.getElementById('calculateBtn').addEventListener('click', calculatePayroll);

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì§ì› ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    loadEmployees();
  </script>
</body>
</html>
