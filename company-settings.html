<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‚¬ì—…ì¥ ì„¤ì • - StaffManager</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif; background: #f5f7fa; min-height: 100vh; }
        .navbar { background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); padding: 0 30px; height: 70px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
        .navbar-brand { display: flex; align-items: center; gap: 12px; font-size: 24px; font-weight: 700; color: #667eea; text-decoration: none; }
        .back-btn { padding: 8px 20px; background: #f5f7fa; border: none; border-radius: 6px; color: #666; cursor: pointer; font-weight: 600; transition: all 0.3s; text-decoration: none; display: inline-flex; align-items: center; gap: 8px; }
        .back-btn:hover { background: #e0e0e0; }
        .container { max-width: 800px; margin: 0 auto; padding: 40px 30px; }
        .page-header { margin-bottom: 30px; }
        .page-title { font-size: 32px; color: #333; margin-bottom: 8px; }
        .page-subtitle { color: #999; font-size: 16px; }
        .form-card { background: white; border-radius: 12px; padding: 40px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .form-section { margin-bottom: 40px; }
        .form-section:last-child { margin-bottom: 0; }
        .section-title { font-size: 18px; font-weight: 600; color: #333; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #f0f0f0; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .form-row.single { grid-template-columns: 1fr; }
        .form-group { margin-bottom: 0; }
        label { display: block; margin-bottom: 8px; color: #333; font-weight: 600; font-size: 14px; }
        label .required { color: #e74c3c; margin-left: 4px; }
        input, select { width: 100%; padding: 12px 16px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 15px; transition: all 0.3s; }
        input:focus, select:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
        input::placeholder { color: #999; }
        input:read-only { background: #f9f9f9; color: #888; }
        .helper-text { color: #999; font-size: 13px; margin-top: 5px; }
        .input-row { display: flex; gap: 10px; }
        .input-row input { flex: 1; }
        .input-row .verify-btn { padding: 12px 20px; background: #667eea; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; white-space: nowrap; transition: all 0.3s; }
        .input-row .verify-btn:hover { background: #5a6fd6; }
        .input-row .verify-btn:disabled { background: #ccc; cursor: not-allowed; }
        .verify-result { font-size: 13px; margin-top: 5px; padding: 6px 10px; border-radius: 6px; display: none; }
        .verify-result.success { display: block; background: #d4edda; color: #155724; }
        .verify-result.error { display: block; background: #f8d7da; color: #721c24; }
        .form-actions { display: flex; gap: 15px; justify-content: flex-end; margin-top: 40px; padding-top: 30px; border-top: 2px solid #f0f0f0; }
        .btn { padding: 14px 32px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 16px rgba(102, 126, 234, 0.3); }
        .btn-primary:disabled { background: #ccc; cursor: not-allowed; transform: none; }
        .btn-secondary { background: white; color: #666; border: 2px solid #e0e0e0; }
        .btn-secondary:hover { background: #f5f7fa; }
        .toast { position: fixed; top: 90px; right: 30px; padding: 16px 24px; border-radius: 10px; color: white; font-weight: 600; z-index: 1000; transform: translateX(120%); transition: transform 0.3s; }
        .toast.show { transform: translateX(0); }
        .toast.success { background: #28a745; }
        .toast.error { background: #dc3545; }
        .loading-overlay { display: none; position: fixed; inset: 0; background: rgba(255,255,255,0.8); z-index: 200; align-items: center; justify-content: center; }
        .loading-overlay.show { display: flex; }
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #667eea; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .status-badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 13px; font-weight: 600; }
        .status-badge.active { background: #d4edda; color: #155724; }
        .status-badge.trial { background: #fff3cd; color: #856404; }
        .status-badge.none { background: #f0f0f0; color: #666; }
        @media (max-width: 768px) { .form-row { grid-template-columns: 1fr; } .container { padding: 20px 15px; } .form-card { padding: 25px; } }
    </style>
</head>
<body>
    <nav class="navbar">
        <a href="/dashboard.html" class="navbar-brand"><span>ğŸ¯</span><span>StaffManager</span></a>
        <a href="/dashboard.html" class="back-btn"><span>â†</span><span>ëŒ€ì‹œë³´ë“œ</span></a>
    </nav>

    <div class="loading-overlay" id="loadingOverlay"><div class="spinner"></div></div>
    <div class="toast" id="toast"></div>

    <div class="container">
        <div class="page-header">
            <h1 class="page-title">ğŸ¢ ì‚¬ì—…ì¥ ì„¤ì •</h1>
            <p class="page-subtitle">ì „ìê³„ì•½ì„œì™€ ê¸‰ì—¬ëª…ì„¸ì„œì— ìë™ìœ¼ë¡œ í‘œì‹œë˜ëŠ” ì‚¬ì—…ì¥ ì •ë³´ì…ë‹ˆë‹¤</p>
        </div>

        <div class="form-card">
            <form id="companyForm">
                <!-- ì‚¬ì—…ì ì •ë³´ -->
                <div class="form-section">
                    <h2 class="section-title">ğŸ“‹ ì‚¬ì—…ì ì •ë³´</h2>
                    <div class="form-row">
                        <div class="form-group">
                            <label>ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸<span class="required">*</span></label>
                            <div class="input-row">
                                <input type="text" id="businessNumber" placeholder="000-00-00000" maxlength="12">
                                <button type="button" class="verify-btn" id="verifyBtn" onclick="verifyBusiness()">í™•ì¸</button>
                            </div>
                            <div class="verify-result" id="verifyResult"></div>
                            <div class="helper-text">êµ­ì„¸ì²­ ì‚¬ì—…ì ìƒíƒœë¥¼ ìë™ í™•ì¸í•©ë‹ˆë‹¤</div>
                        </div>
                        <div class="form-group">
                            <label>ì‚¬ì—…ì¥ëª… (ìƒí˜¸)<span class="required">*</span></label>
                            <input type="text" id="companyName" placeholder="ì£¼ì‹íšŒì‚¬ OO">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>ëŒ€í‘œìëª…<span class="required">*</span></label>
                            <input type="text" id="representativeName" placeholder="í™ê¸¸ë™">
                        </div>
                        <div class="form-group">
                            <label>ëŒ€í‘œ ì „í™”ë²ˆí˜¸</label>
                            <input type="tel" id="businessPhone" placeholder="02-1234-5678">
                        </div>
                    </div>
                    <div class="form-row single">
                        <div class="form-group">
                            <label>ì‚¬ì—…ì¥ ì£¼ì†Œ<span class="required">*</span></label>
                            <input type="text" id="address" placeholder="ì„œìš¸ì‹œ ê°•ë‚¨êµ¬ í…Œí—¤ë€ë¡œ 123, 4ì¸µ">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>ì—…ì¢…</label>
                            <input type="text" id="businessType" placeholder="ì •ë³´í†µì‹ ì—…">
                        </div>
                        <div class="form-group">
                            <label>ì—…íƒœ</label>
                            <input type="text" id="businessCategory" placeholder="ì†Œí”„íŠ¸ì›¨ì–´ ê°œë°œ">
                        </div>
                    </div>
                </div>

                <!-- ê¸‰ì—¬ ì„¤ì • -->
                <div class="form-section">
                    <h2 class="section-title">ğŸ’° ê¸‰ì—¬ ì„¤ì •</h2>
                    <div class="form-row">
                        <div class="form-group">
                            <label>ê¸‰ì—¬ì¼</label>
                            <select id="payDay">
                                <option value="1">ë§¤ì›” 1ì¼</option>
                                <option value="5">ë§¤ì›” 5ì¼</option>
                                <option value="10" selected>ë§¤ì›” 10ì¼</option>
                                <option value="15">ë§¤ì›” 15ì¼</option>
                                <option value="20">ë§¤ì›” 20ì¼</option>
                                <option value="25">ë§¤ì›” 25ì¼</option>
                            </select>
                            <div class="helper-text">ì§ì› ê¸‰ì—¬ ì§€ê¸‰ì¼ (ê³„ì•½ì„œì— ìë™ í‘œì‹œ)</div>
                        </div>
                        <div class="form-group">
                            <label>êµ¬ë… ìƒíƒœ</label>
                            <div id="subscriptionInfo" style="padding:12px 16px; background:#f9f9f9; border-radius:8px; font-size:15px;">
                                <span class="status-badge none">ë¯¸ê°€ì…</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ì €ì¥ -->
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="window.location.href='/dashboard.html'">ì·¨ì†Œ</button>
                    <button type="submit" class="btn btn-primary" id="saveBtn">ì €ì¥</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let authToken = localStorage.getItem('authToken');
        const API = '/.netlify/functions/company-settings';

        // í† ìŠ¤íŠ¸ ë©”ì‹œì§€
        function showToast(msg, type = 'success') {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.className = 'toast show ' + type;
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        function setLoading(show) {
            document.getElementById('loadingOverlay').classList.toggle('show', show);
        }

        // ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸ ìë™ í¬ë§·íŒ…
        document.getElementById('businessNumber').addEventListener('input', (e) => {
            const v = e.target.value.replace(/[^0-9]/g, '');
            let f = '';
            if (v.length <= 3) f = v;
            else if (v.length <= 5) f = v.slice(0,3) + '-' + v.slice(3);
            else f = v.slice(0,3) + '-' + v.slice(3,5) + '-' + v.slice(5,10);
            e.target.value = f;
        });

        // ì „í™”ë²ˆí˜¸ ìë™ í¬ë§·íŒ…
        document.getElementById('businessPhone').addEventListener('input', (e) => {
            const v = e.target.value.replace(/[^0-9]/g, '');
            let f = '';
            if (v.startsWith('02')) {
                if (v.length <= 2) f = v;
                else if (v.length <= 6) f = v.slice(0,2) + '-' + v.slice(2);
                else f = v.slice(0,2) + '-' + v.slice(2,6) + '-' + v.slice(6,10);
            } else {
                if (v.length <= 3) f = v;
                else if (v.length <= 7) f = v.slice(0,3) + '-' + v.slice(3);
                else f = v.slice(0,3) + '-' + v.slice(3,7) + '-' + v.slice(7,11);
            }
            e.target.value = f;
        });

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
        window.addEventListener('DOMContentLoaded', async () => {
            if (!authToken) { window.location.href = '/login.html'; return; }
            setLoading(true);
            try {
                const res = await fetch(API, { headers: { 'Authorization': 'Bearer ' + authToken } });
                const data = await res.json();
                if (data.success && data.data.company) {
                    const c = data.data.company;
                    if (c.companyName) document.getElementById('companyName').value = c.companyName;
                    if (c.representativeName) document.getElementById('representativeName').value = c.representativeName;
                    if (c.businessNumber) {
                        const bn = c.businessNumber;
                        document.getElementById('businessNumber').value = bn.length === 10
                            ? bn.slice(0,3) + '-' + bn.slice(3,5) + '-' + bn.slice(5)
                            : bn;
                    }
                    if (c.address) document.getElementById('address').value = c.address;
                    if (c.businessPhone) document.getElementById('businessPhone').value = c.businessPhone;
                    if (c.businessType) document.getElementById('businessType').value = c.businessType;
                    if (c.businessCategory) document.getElementById('businessCategory').value = c.businessCategory;
                    if (c.payDay) document.getElementById('payDay').value = c.payDay;

                    // êµ¬ë… ìƒíƒœ í‘œì‹œ
                    const subInfo = document.getElementById('subscriptionInfo');
                    if (c.subscriptionPlan) {
                        const statusClass = c.subscriptionStatus === 'active' ? 'active' : 'trial';
                        subInfo.innerHTML = `<span class="status-badge ${statusClass}">${c.subscriptionPlan} (${c.subscriptionStatus || 'í™œì„±'})</span>`;
                    }
                }
            } catch (e) {
                console.error('Load error:', e);
            }
            setLoading(false);
        });

        // êµ­ì„¸ì²­ ì‚¬ì—…ìí™•ì¸ (ê³µê³µë°ì´í„° API)
        async function verifyBusiness() {
            const bn = document.getElementById('businessNumber').value.replace(/[^0-9]/g, '');
            const result = document.getElementById('verifyResult');
            const btn = document.getElementById('verifyBtn');

            if (bn.length !== 10) {
                result.className = 'verify-result error';
                result.textContent = 'ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸ 10ìë¦¬ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”';
                return;
            }

            btn.disabled = true;
            btn.textContent = 'í™•ì¸ ì¤‘...';
            result.className = 'verify-result';
            result.style.display = 'none';

            try {
                // êµ­ì„¸ì²­ API í˜¸ì¶œ (ê³µê³µë°ì´í„° í¬í„¸)
                const res = await fetch('https://api.odcloud.kr/api/nts-businessman/v1/status?serviceKey=data_default_key', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ b_no: [bn] })
                });
                const data = await res.json();

                if (data.data && data.data[0]) {
                    const biz = data.data[0];
                    if (biz.b_stt === 'ê³„ì†ì‚¬ì—…ì') {
                        result.className = 'verify-result success';
                        result.textContent = `âœ… ${biz.b_stt} | ${biz.tax_type || 'í™•ì¸ë¨'}`;
                    } else if (biz.b_stt) {
                        result.className = 'verify-result error';
                        result.textContent = `âš ï¸ ${biz.b_stt} ${biz.end_dt ? '(íì—…ì¼: '+biz.end_dt+')' : ''}`;
                    } else {
                        result.className = 'verify-result error';
                        result.textContent = 'âŒ ë“±ë¡ë˜ì§€ ì•Šì€ ì‚¬ì—…ìë²ˆí˜¸ì…ë‹ˆë‹¤';
                    }
                } else {
                    result.className = 'verify-result error';
                    result.textContent = 'í™•ì¸ ì‹¤íŒ¨ â€” ì§ì ‘ ì…ë ¥ì„ ì§„í–‰í•´ì£¼ì„¸ìš”';
                }
            } catch (e) {
                console.error('Verify error:', e);
                result.className = 'verify-result error';
                result.textContent = 'í™•ì¸ ì‹¤íŒ¨ â€” ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ (ì…ë ¥ì€ ê³„ì† ê°€ëŠ¥)';
            }

            btn.disabled = false;
            btn.textContent = 'í™•ì¸';
        }

        // í¼ ì €ì¥
        document.getElementById('companyForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const companyName = document.getElementById('companyName').value.trim();
            const representativeName = document.getElementById('representativeName').value.trim();
            const businessNumber = document.getElementById('businessNumber').value.trim();
            const address = document.getElementById('address').value.trim();

            if (!companyName) { showToast('ì‚¬ì—…ì¥ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”', 'error'); return; }
            if (!representativeName) { showToast('ëŒ€í‘œìëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”', 'error'); return; }

            setLoading(true);
            try {
                const res = await fetch(API, {
                    method: 'PUT',
                    headers: {
                        'Authorization': 'Bearer ' + authToken,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        companyName,
                        representativeName,
                        businessNumber,
                        address,
                        businessPhone: document.getElementById('businessPhone').value.trim(),
                        businessType: document.getElementById('businessType').value.trim(),
                        businessCategory: document.getElementById('businessCategory').value.trim(),
                        payDay: parseInt(document.getElementById('payDay').value)
                    })
                });
                const data = await res.json();
                if (data.success) {
                    showToast('ì‚¬ì—…ì¥ ì •ë³´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
                } else {
                    showToast(data.error || 'ì €ì¥ ì‹¤íŒ¨', 'error');
                }
            } catch (err) {
                showToast('ì„œë²„ í†µì‹  ì˜¤ë¥˜', 'error');
            }
            setLoading(false);
        });
    </script>
</body>
</html>
