<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê¸‰ì—¬ ê´€ë¦¬ - StaffManager</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','Roboto','Noto Sans KR',sans-serif;background:#f5f7fa;min-height:100vh}
        .navbar{background:#fff;box-shadow:0 2px 4px rgba(0,0,0,.1);padding:0 30px;height:70px;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:100}
        .navbar-brand{display:flex;align-items:center;gap:12px;font-size:24px;font-weight:700;color:#667eea;text-decoration:none}
        .navbar-menu{display:flex;gap:30px;align-items:center}
        .navbar-menu a{text-decoration:none;color:#666;font-weight:500;transition:color .3s}
        .navbar-menu a:hover,.navbar-menu a.active{color:#667eea;font-weight:600}
        .user-menu{display:flex;align-items:center;gap:15px}
        .user-info{text-align:right}
        .user-name{font-weight:600;color:#333;font-size:14px}
        .company-name{font-size:12px;color:#999}
        .logout-btn{padding:8px 20px;background:#f5f7fa;border:none;border-radius:6px;color:#666;cursor:pointer;font-weight:600;transition:all .3s}
        .logout-btn:hover{background:#667eea;color:#fff}
        .container{max-width:1000px;margin:0 auto;padding:30px 20px}
        .page-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:30px;flex-wrap:wrap;gap:15px}
        .page-title{font-size:28px;color:#333}
        .header-actions{display:flex;gap:10px}
        .header-actions a{padding:10px 20px;background:#fff;color:#667eea;border:2px solid #667eea;border-radius:8px;text-decoration:none;font-weight:600;font-size:14px;transition:all .3s}
        .header-actions a:hover{background:#667eea;color:#fff}
        .filter-bar{background:#fff;border-radius:12px;padding:20px 25px;box-shadow:0 2px 8px rgba(0,0,0,.08);margin-bottom:25px;display:flex;gap:15px;align-items:flex-end;flex-wrap:wrap}
        .filter-group{display:flex;flex-direction:column;gap:6px}
        .filter-group label{font-size:13px;font-weight:600;color:#666}
        .filter-group select,.filter-group input{padding:10px 14px;border:1px solid #ddd;border-radius:8px;font-size:14px;min-width:140px}
        .btn-primary{padding:10px 28px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;transition:all .3s;white-space:nowrap}
        .btn-primary:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(102,126,234,.4)}
        .btn-primary:disabled{opacity:.5;cursor:not-allowed;transform:none}
        .loading{text-align:center;padding:60px;color:#999;display:none}
        .spinner{border:4px solid #f3f3f3;border-top:4px solid #667eea;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;margin:0 auto 15px}
        @keyframes spin{to{transform:rotate(360deg)}}
        .empty-state{text-align:center;padding:80px 20px;color:#999;background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.08)}
        .empty-state .icon{font-size:60px;margin-bottom:15px}
        .empty-state p{font-size:16px}
        .warning-banner{background:#fff3cd;border:1px solid #ffc107;border-radius:10px;padding:15px 20px;margin-bottom:20px;display:none}
        .warning-banner.show{display:block}
        .warning-item{display:flex;align-items:center;gap:8px;padding:4px 0;font-size:14px}
        .warning-item.critical{color:#dc3545;font-weight:600}
        .warning-item.warning{color:#856404}
        .payslip{background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.08);overflow:hidden;display:none}
        .payslip.show{display:block}
        .payslip-header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:25px 30px;display:flex;justify-content:space-between;align-items:center}
        .payslip-title{font-size:22px;font-weight:700}
        .payslip-period{font-size:14px;opacity:.9}
        .payslip-actions{display:flex;gap:10px}
        .payslip-actions button{padding:8px 18px;border-radius:6px;font-size:13px;font-weight:600;cursor:pointer;transition:all .3s;border:none}
        .btn-pdf{background:rgba(255,255,255,.2);color:#fff;border:1px solid rgba(255,255,255,.5)!important}
        .btn-send{background:linear-gradient(135deg,#25D366,#128C7E);color:#fff;border:none;padding:10px 20px;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;transition:all .3s;display:inline-flex;align-items:center;gap:8px;}
        .btn-send:hover{transform:translateY(-2px);box-shadow:0 6px 12px rgba(37,211,102,.35)}
        .btn-send:disabled{opacity:.6;cursor:not-allowed;transform:none}
        .btn-pdf:hover{background:rgba(255,255,255,.3)}
        .payslip-body{padding:25px 30px}
        .payslip-info{display:flex;justify-content:space-between;margin-bottom:25px;padding-bottom:20px;border-bottom:2px solid #f0f0f0}
        .info-item{text-align:center}
        .info-label{font-size:12px;color:#999;margin-bottom:4px}
        .info-value{font-size:16px;font-weight:700;color:#333}
        .payslip-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:25px}
        .payslip-section{border:1px solid #e8e8e8;border-radius:10px;overflow:hidden}
        .section-header{padding:12px 18px;font-size:14px;font-weight:700;display:flex;justify-content:space-between;align-items:center}
        .section-header.payment{background:#e8f5e9;color:#2e7d32}
        .section-header.nontax{background:#e3f2fd;color:#1565c0}
        .section-header.deduction{background:#fce4ec;color:#c62828}
        .section-header.employer{background:#f3e5f5;color:#7b1fa2}
        .section-body{padding:12px 18px}
        .section-row{display:flex;justify-content:space-between;padding:7px 0;border-bottom:1px solid #f5f5f5;font-size:14px}
        .section-row:last-child{border-bottom:none}
        .section-row .label{color:#666}
        .section-row .value{font-weight:600;color:#333}
        .section-row.section-total{font-weight:700;font-size:15px;color:#333;padding:10px 0;border-top:2px solid #e0e0e0;margin-top:5px}
        .net-payment-box{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);border-radius:12px;padding:30px;text-align:center;color:#fff}
        .net-label{font-size:14px;opacity:.9;margin-bottom:8px}
        .net-amount{font-size:42px;font-weight:800}
        .net-sub{font-size:13px;opacity:.7;margin-top:8px}
        /* â”€â”€ íƒ­ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .tab-bar{display:flex;gap:4px;margin-bottom:25px;background:#fff;border-radius:12px;padding:6px;box-shadow:0 2px 8px rgba(0,0,0,.08)}
        .tab-btn{flex:1;padding:12px;border:none;background:transparent;border-radius:8px;font-size:15px;font-weight:600;color:#999;cursor:pointer;transition:all .3s}
        .tab-btn.active{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;box-shadow:0 4px 12px rgba(102,126,234,.3)}
        .tab-content{display:none}
        .tab-content.active{display:block}
        /* â”€â”€ í‡´ì§ê¸ˆ ì¹´ë“œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .sev-card{background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.08);overflow:hidden;margin-bottom:20px}
        .sev-header{background:linear-gradient(135deg,#e67e22 0%,#d35400 100%);color:#fff;padding:20px 25px}
        .sev-header-title{font-size:20px;font-weight:700}
        .sev-header-sub{font-size:13px;opacity:.85;margin-top:4px}
        .sev-body{padding:25px}
        .sev-amount-box{background:linear-gradient(135deg,#e67e22 0%,#d35400 100%);border-radius:12px;padding:28px;text-align:center;color:#fff;margin-bottom:20px}
        .sev-amount-label{font-size:14px;opacity:.9;margin-bottom:6px}
        .sev-amount{font-size:40px;font-weight:800}
        .sev-amount-sub{font-size:13px;opacity:.75;margin-top:6px}
        .sev-grid{display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:20px}
        .sev-info-item{background:#f8f9fa;border-radius:10px;padding:16px}
        .sev-info-label{font-size:12px;color:#999;margin-bottom:6px}
        .sev-info-value{font-size:18px;font-weight:700;color:#333}
        .sev-info-sub{font-size:12px;color:#999;margin-top:3px}
        .sev-wage-box{background:#f8f9fa;border-radius:10px;padding:16px;margin-bottom:20px}
        .sev-wage-title{font-size:13px;font-weight:700;color:#666;margin-bottom:12px}
        .sev-wage-row{display:flex;justify-content:space-between;padding:7px 0;border-bottom:1px solid #eee;font-size:14px}
        .sev-wage-row:last-child{border-bottom:none}
        .sev-wage-row.highlight{font-weight:700;color:#e67e22;padding-top:10px;margin-top:5px;border-top:2px solid #e0e0e0;border-bottom:none}
        .sev-breakdown{margin-bottom:20px}
        .sev-breakdown-title{font-size:13px;font-weight:700;color:#666;margin-bottom:10px}
        .sev-breakdown-row{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid #f0f0f0;font-size:14px}
        .sev-breakdown-row:last-child{border-bottom:none}
        .sev-ineligible{text-align:center;padding:60px 20px;background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.08)}
        .sev-notice{background:#fff3cd;border:1px solid #ffc107;border-radius:10px;padding:14px 18px;font-size:13px;color:#856404;line-height:1.6}
        .badge-estimated{background:#fff3e0;color:#e67e22;font-size:11px;padding:2px 8px;border-radius:10px;font-weight:600}
        @media(max-width:768px){
            .container{padding:20px 10px}
            .filter-bar{flex-direction:column;align-items:stretch}
            .payslip-grid{grid-template-columns:1fr}
            .payslip-header{flex-direction:column;gap:15px;text-align:center}
            .payslip-info{flex-wrap:wrap;gap:15px}
            .navbar-menu{display:none}
            .sev-grid{grid-template-columns:1fr}
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <a href="/dashboard.html" class="navbar-brand"><span>ğŸ¯</span><span>StaffManager</span></a>
        <div class="navbar-menu">
            <a href="/dashboard.html">ëŒ€ì‹œë³´ë“œ</a>
            <a href="/employees.html">ì§ì› ê´€ë¦¬</a>
            <a href="/attendances.html">ì¶œí‡´ê·¼ ê´€ë¦¬</a>
            <a href="/calendar.html">íœ´ê°€ ê´€ë¦¬</a>
            <a href="/salary.html" class="active">ê¸‰ì—¬ ê´€ë¦¬</a>
            <a href="/contracts.html">ê³„ì•½ ê´€ë¦¬</a>
            <a href="/settings.html">ì„¤ì •</a>
        </div>
        <div class="user-menu">
            <div class="user-info">
                <div class="user-name" id="userName">ì‚¬ìš©ì</div>
                <div class="company-name" id="companyName">íšŒì‚¬ëª…</div>
            </div>
            <button class="logout-btn" onclick="handleLogout()">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </nav>

    <div class="container">
        <div class="page-header">
            <h1 class="page-title">ğŸ’° ê¸‰ì—¬ ê´€ë¦¬</h1>
            <div class="header-actions">
                <a href="/payroll-register.html">ğŸ“‹ ê¸‰ì—¬ëŒ€ì¥</a>
            </div>
        </div>

        <!-- â”€â”€ íƒ­ ì „í™˜ ë°” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <div class="tab-bar">
            <button class="tab-btn active" id="tab1Btn" onclick="switchTab('salary')">ğŸ’µ ê¸‰ì—¬ ê³„ì‚°</button>
            <button class="tab-btn" id="tab2Btn" onclick="switchTab('severance')">ğŸ“¦ í‡´ì§ê¸ˆ ê³„ì‚°</button>
        </div>

        <!-- â•â•â•â•â•â•â•â•â•â• TAB 1: ê¸‰ì—¬ ê³„ì‚° â•â•â•â•â•â•â•â•â•â• -->
        <div class="tab-content active" id="tabSalary">
            <!-- ì‚¬ì—…ì²´ í•„í„°: ì„ íƒ ì‹œ ì§ì› ë“œë¡­ë‹¤ìš´ ìë™ ê°±ì‹  -->
            <div class="filter-group">
                <label>ì‚¬ì—…ì²´</label>
                <select id="businessFilter" onchange="onBizFilter()">
                    <option value="all">ì „ì²´ ì‚¬ì—…ì²´</option>
                </select>
            </div>
            <div class="filter-group">
                <label>ì§ì› ì„ íƒ</label>
                <select id="employeeSelect"><option value="">ì§ì›ì„ ì„ íƒí•˜ì„¸ìš”</option></select>
            </div>
            <div class="filter-group">
                <label>ë…„ë„</label>
                <select id="yearSelect"></select>
            </div>
            <div class="filter-group">
                <label>ì›”</label>
                <select id="monthSelect">
                    <option value="1">1ì›”</option><option value="2">2ì›”</option><option value="3">3ì›”</option>
                    <option value="4">4ì›”</option><option value="5">5ì›”</option><option value="6">6ì›”</option>
                    <option value="7">7ì›”</option><option value="8">8ì›”</option><option value="9">9ì›”</option>
                    <option value="10">10ì›”</option><option value="11">11ì›”</option><option value="12">12ì›”</option>
                </select>
            </div>
            <button class="btn-primary" id="calculateBtn" onclick="calculatePayroll()">ê¸‰ì—¬ ê³„ì‚°</button>
        </div>

        <div class="loading" id="loading"><div class="spinner"></div><p>ê¸‰ì—¬ë¥¼ ê³„ì‚°í•˜ëŠ” ì¤‘...</p></div>

        <div class="empty-state" id="emptyState">
            <div class="icon">ğŸ“Š</div>
            <p>ì§ì›ì„ ì„ íƒí•˜ê³  ê¸‰ì—¬ ê³„ì‚°ì„ ì‹¤í–‰í•˜ì„¸ìš”</p>
        </div>

        <div class="warning-banner" id="warningBanner"></div>

        <div class="payslip" id="payslip">
            <div class="payslip-header">
                <div>
                    <div class="payslip-title" id="slipName">ê¸‰ì—¬ëª…ì„¸ì„œ</div>
                    <div class="payslip-period" id="slipPeriod"></div>
                </div>
                <div class="payslip-actions">
                    <button class="btn-pdf" onclick="downloadPDF()">ğŸ“¥ PDF ë‹¤ìš´ë¡œë“œ</button>
                    <button class="btn-send" id="sendNotifyBtn" onclick="sendPayrollNotification()" style="display:none">ğŸ“± ì¹´ì¹´ì˜¤/SMS ë°œì†¡</button>
                </div>
            </div>

            <div class="payslip-body">
                <div class="payslip-info">
                    <div class="info-item"><div class="info-label">ê·¼ë¬´ì¼ìˆ˜</div><div class="info-value" id="infoWorkDays">-</div></div>
                    <div class="info-item"><div class="info-label">ì •ê·œ ì‹œê°„</div><div class="info-value" id="infoRegularHours">-</div></div>
                    <div class="info-item"><div class="info-label">ì—°ì¥ ì‹œê°„</div><div class="info-value" id="infoOvertimeHours">-</div></div>
                    <div class="info-item"><div class="info-label">ì•¼ê°„ ì‹œê°„</div><div class="info-value" id="infoNightHours">-</div></div>
                    <div class="info-item"><div class="info-label">ê¸‰ì—¬ ìœ í˜•</div><div class="info-value" id="infoSalaryType">-</div></div>
                </div>

                <div class="payslip-grid">
                    <div class="payslip-section">
                        <div class="section-header payment"><span>ğŸ’µ ì§€ê¸‰í•­ëª©</span><span id="totalPaymentBadge">-</span></div>
                        <div class="section-body" id="paymentSection"></div>
                    </div>
                    <div class="payslip-section">
                        <div class="section-header nontax"><span>ğŸ›¡ï¸ ë¹„ê³¼ì„¸ ìˆ˜ë‹¹</span><span id="totalNontaxBadge">-</span></div>
                        <div class="section-body" id="nontaxSection"></div>
                    </div>
                    <div class="payslip-section">
                        <div class="section-header deduction"><span>ğŸ“‰ ê³µì œí•­ëª©</span><span id="totalDeductionBadge">-</span></div>
                        <div class="section-body" id="deductionSection"></div>
                    </div>
                    <div class="payslip-section">
                        <div class="section-header employer"><span>ğŸ¢ ì‚¬ì—…ì£¼ ë¶€ë‹´ë¶„</span><span id="totalEmployerBadge">-</span></div>
                        <div class="section-body" id="employerSection"></div>
                    </div>
                </div>

                <div class="net-payment-box">
                    <div class="net-label">ì‹¤ìˆ˜ë ¹ì•¡</div>
                    <div class="net-amount" id="netPayment">â‚©0</div>
                    <div class="net-sub" id="netSub">ì´ ì§€ê¸‰ì•¡ â‚©0 - ì´ ê³µì œì•¡ â‚©0</div>
                </div>
            </div>
        </div><!-- end payslip -->
        </div><!-- end tabSalary -->

        <!-- â•â•â•â•â•â•â•â•â•â• TAB 2: í‡´ì§ê¸ˆ ê³„ì‚° â•â•â•â•â•â•â•â•â•â• -->
        <div class="tab-content" id="tabSeverance">

            <!-- í‡´ì§ê¸ˆ í•„í„° ë°” -->
            <div class="filter-bar">
                <div class="filter-group">
                    <label>ì‚¬ì—…ì²´</label>
                    <select id="sevBizFilter" onchange="onSevBizFilter()">
                        <option value="all">ì „ì²´ ì‚¬ì—…ì²´</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>ì§ì› ì„ íƒ</label>
                    <select id="sevEmployeeSelect"><option value="">ì§ì›ì„ ì„ íƒí•˜ì„¸ìš”</option></select>
                </div>
                <div class="filter-group">
                    <label>í‡´ì§ì¼ (ë¹ˆì¹¸ = ì˜¤ëŠ˜, ì‹œë®¬ë ˆì´ì…˜ ê°€ëŠ¥)</label>
                    <input type="date" id="sevRetireDate" />
                </div>
                <button class="btn-primary" id="sevCalcBtn" onclick="calculateSeverance()">í‡´ì§ê¸ˆ ê³„ì‚°</button>
            </div>

            <div class="loading" id="sevLoading"><div class="spinner"></div><p>í‡´ì§ê¸ˆì„ ê³„ì‚°í•˜ëŠ” ì¤‘...</p></div>

            <div class="empty-state" id="sevEmptyState">
                <div class="icon">ğŸ“¦</div>
                <p>ì§ì›ì„ ì„ íƒí•˜ê³  í‡´ì§ê¸ˆ ê³„ì‚°ì„ ì‹¤í–‰í•˜ì„¸ìš”</p>
                <p style="font-size:13px;margin-top:8px;color:#bbb">í‡´ì§ ì „ ì‹œë®¬ë ˆì´ì…˜ë„ ê°€ëŠ¥í•©ë‹ˆë‹¤</p>
            </div>

            <!-- í‡´ì§ê¸ˆ ê²°ê³¼ ì¹´ë“œ -->
            <div id="sevResult" style="display:none">

                <div class="sev-amount-box">
                    <div class="sev-amount-label">ì˜ˆìƒ í‡´ì§ê¸ˆ</div>
                    <div class="sev-amount" id="sevFinalAmount">â‚©0</div>
                    <div class="sev-amount-sub" id="sevAmountSub"></div>
                </div>

                <!-- ê·¼ì† ì •ë³´ + ì ìš© ì„ê¸ˆ ê·¸ë¦¬ë“œ -->
                <div class="sev-grid">
                    <div class="sev-info-item">
                        <div class="sev-info-label">ğŸ‘¤ ì§ì›</div>
                        <div class="sev-info-value" id="sevEmpName">-</div>
                        <div class="sev-info-sub" id="sevEmpHireDate"></div>
                    </div>
                    <div class="sev-info-item">
                        <div class="sev-info-label">ğŸ“… ê·¼ì†ê¸°ê°„</div>
                        <div class="sev-info-value" id="sevServicePeriod">-</div>
                        <div class="sev-info-sub" id="sevServiceDays"></div>
                    </div>
                    <div class="sev-info-item">
                        <div class="sev-info-label">ğŸ“† ê¸°ì¤€ì¼</div>
                        <div class="sev-info-value" id="sevRetireDateDisplay">-</div>
                        <div class="sev-info-sub" id="sevRetireDateSub"></div>
                    </div>
                    <div class="sev-info-item">
                        <div class="sev-info-label">ğŸ’µ ì ìš© ì„ê¸ˆ/ì¼</div>
                        <div class="sev-info-value" id="sevWagePerDay">-</div>
                        <div class="sev-info-sub" id="sevWageType"></div>
                    </div>
                </div>

                <!-- ì„ê¸ˆ ì‚°ì • ë‚´ì—­ -->
                <div class="sev-card">
                    <div class="sev-header">
                        <div class="sev-header-title">ğŸ“Š ì„ê¸ˆ ì‚°ì • ë‚´ì—­</div>
                        <div class="sev-header-sub">í‰ê· ì„ê¸ˆ vs í†µìƒì„ê¸ˆ ë¹„êµ (ë†’ì€ ê°’ ìë™ ì ìš©)</div>
                    </div>
                    <div class="sev-body">
                        <div class="sev-wage-box">
                            <div class="sev-wage-title">í‰ê· ì„ê¸ˆ ì‚°ì •</div>
                            <div class="sev-wage-row"><span>ìµœê·¼ 3ê°œì›” ì„ê¸ˆ ì´ì•¡</span><span id="sevTotal3m">-</span></div>
                            <div class="sev-wage-row"><span>ìµœê·¼ 3ê°œì›” ì´ ì¼ìˆ˜</span><span id="sevDays3m">91ì¼</span></div>
                            <div class="sev-wage-row"><span>í‰ê· ì„ê¸ˆ/ì¼</span><span id="sevAvgWage">-</span></div>
                            <div class="sev-wage-row"><span>í†µìƒì„ê¸ˆ/ì¼</span><span id="sevNormalWage">-</span></div>
                            <div class="sev-wage-row highlight"><span>âœ… ìµœì¢… ì ìš© ì„ê¸ˆ/ì¼</span><span id="sevFinalWage">-</span></div>
                        </div>
                        <div class="sev-notice" id="sevDataNotice"></div>
                    </div>
                </div>

                <!-- ì—°ë„ë³„ í‡´ì§ê¸ˆ ë‚´ì—­ -->
                <div class="sev-card">
                    <div class="sev-header">
                        <div class="sev-header-title">ğŸ“‹ ì—°ë„ë³„ í‡´ì§ê¸ˆ ë‚´ì—­</div>
                        <div class="sev-header-sub">í‡´ì§ê¸ˆ = ì ìš©ì„ê¸ˆ/ì¼ Ã— 30ì¼ Ã— (ê·¼ì†ì¼ìˆ˜ Ã· 365)</div>
                    </div>
                    <div class="sev-body">
                        <div class="sev-breakdown" id="sevBreakdown"></div>
                    </div>
                </div>

                <div class="sev-notice" style="background:#e8f5e9;border-color:#4caf50;color:#2e7d32">
                    âš–ï¸ <strong>ë²•ì  ê³ ì§€:</strong> ë³¸ ê³„ì‚°ì€ ê·¼ë¡œê¸°ì¤€ë²• ì œ34ì¡° ê¸°ì¤€ì…ë‹ˆë‹¤.
                    ì‹¤ì œ í‡´ì§ê¸ˆì€ ì„¸ê¸ˆÂ·í¬ìƒê¸ˆÂ·íŠ¹ë³„ê¸‰ì—¬ í¬í•¨ ì—¬ë¶€ì— ë”°ë¼ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆìœ¼ë©°,
                    ë¶„ìŸ ì‹œ ê³ ìš©ë…¸ë™ë¶€ í‡´ì§ê¸ˆ ê³„ì‚°ê¸° ë˜ëŠ” ë…¸ë¬´ì‚¬ ê²€í† ë¥¼ ê¶Œì¥í•©ë‹ˆë‹¤.
                </div>

            </div><!-- end sevResult -->

            <!-- ì§€ê¸‰ ë¶ˆê°€ ë©”ì‹œì§€ -->
            <div class="sev-ineligible" id="sevIneligible" style="display:none">
                <div style="font-size:60px;margin-bottom:15px">ğŸ“¦</div>
                <p id="sevIneligibleMsg" style="font-size:16px;color:#666"></p>
            </div>

        </div><!-- end tabSeverance -->
    </div><!-- end container -->

<script>
var authToken = null, userInfo = null, employees = [], currentData = null, currentEmployee = null;
var allEmployees = [], businessMap = {}; // ì‚¬ì—…ì²´ í•„í„°ìš©

window.addEventListener('DOMContentLoaded', async function() {
    authToken = localStorage.getItem('authToken');
    var ui = localStorage.getItem('userInfo');
    if (!authToken || !ui) { window.location.href = '/login.html'; return; }
    try { userInfo = JSON.parse(ui); } catch(e) { window.location.href = '/login.html'; return; }

    document.getElementById('userName').textContent = userInfo.name || 'ì‚¬ìš©ì';
    document.getElementById('companyName').textContent = userInfo.companyName || '';

    var yearSel = document.getElementById('yearSelect');
    var curYear = new Date().getFullYear();
    for (var y = curYear + 1; y >= curYear - 3; y--) {
        var opt = document.createElement('option');
        opt.value = y; opt.textContent = y + 'ë…„';
        if (y === curYear) opt.selected = true;
        yearSel.appendChild(opt);
    }
    document.getElementById('monthSelect').value = new Date().getMonth() + 1;

    await Promise.all([loadBusinesses(), loadEmployees()]);
});

/* íƒ­ ì „í™˜ */
function switchTab(tab) {
    document.getElementById('tabSalary').classList.toggle('active', tab === 'salary');
    document.getElementById('tabSeverance').classList.toggle('active', tab === 'severance');
    document.getElementById('tab1Btn').classList.toggle('active', tab === 'salary');
    document.getElementById('tab2Btn').classList.toggle('active', tab === 'severance');
}

/* ì‚¬ì—…ì²´ ëª©ë¡ ë¡œë“œ */
async function loadBusinesses() {
    try {
        var r = await fetch('/.netlify/functions/businesses-manage', {
            headers: { 'Authorization': 'Bearer ' + authToken }
        });
        var res = await r.json();
        if (res.success && res.data && res.data.businesses) {
            var sel = document.getElementById('businessFilter');
            var sevSel = document.getElementById('sevBizFilter'); // í‡´ì§ê¸ˆ íƒ­ìš©
            res.data.businesses.forEach(function(b) {
                businessMap[b.id] = b.name;
                // ê¸‰ì—¬ íƒ­ ë“œë¡­ë‹¤ìš´
                var opt = document.createElement('option');
                opt.value = b.id;
                opt.textContent = b.name;
                sel.appendChild(opt);
                // í‡´ì§ê¸ˆ íƒ­ ë“œë¡­ë‹¤ìš´
                var opt2 = document.createElement('option');
                opt2.value = b.id;
                opt2.textContent = b.name;
                sevSel.appendChild(opt2);
            });
        }
    } catch(e) { console.error('ì‚¬ì—…ì²´ ë¡œë“œ ì‹¤íŒ¨:', e); }
}

async function loadEmployees() {
    try {
        var r = await fetch('/.netlify/functions/employees-list', {
            headers: { 'Authorization': 'Bearer ' + authToken, 'Content-Type': 'application/json' }
        });
        var res = await r.json();
        if (res.success && res.data && res.data.employees) {
            /* allEmployees: ì¬ì§ì + í‡´ì§ì ëª¨ë‘ í¬í•¨ (í‡´ì§ê¸ˆ íƒ­ìš©) */
            allEmployees = res.data.employees;
            /* ê¸‰ì—¬ ê³„ì‚° íƒ­ì€ ì¬ì§ìë§Œ */
            var active = allEmployees.filter(function(e) { return e.status === 'active'; });
            renderEmployeeSelect(active);
        }
    } catch(e) { console.error('ì§ì› ë¡œë“œ ì‹¤íŒ¨:', e); }
}

/* ì‚¬ì—…ì²´ í•„í„° ë³€ê²½ ì‹œ ì§ì› ë“œë¡­ë‹¤ìš´ ê°±ì‹  */
function onBizFilter() {
    var bizId = document.getElementById('businessFilter').value;
    var filtered = bizId === 'all'
        ? allEmployees
        : allEmployees.filter(function(e) {
            return (e.businessId || e.business_id) === bizId;
        });
    renderEmployeeSelect(filtered);
    /* ì§ì› ì„ íƒ ì´ˆê¸°í™” â†’ ê²°ê³¼ì°½ ìˆ¨ê¸°ê¸° */
    document.getElementById('emptyState').style.display = 'block';
    document.getElementById('loading').style.display = 'none';
    var resultEl = document.getElementById('payrollResult');
    if (resultEl) resultEl.style.display = 'none';
}

/* ì§ì› ì…€ë ‰íŠ¸ë°•ìŠ¤ ë Œë”ë§ ê³µí†µ í•¨ìˆ˜ */
function renderEmployeeSelect(list) {
    employees = list;
    var sel = document.getElementById('employeeSelect');
    sel.innerHTML = '<option value="">ì§ì›ì„ ì„ íƒí•˜ì„¸ìš”</option>';
    list.forEach(function(emp) {
        var opt = document.createElement('option');
        opt.value = emp.id;
        /* ì‚¬ì—…ì²´ëª… í‘œì‹œ (ì „ì²´ ë³´ê¸°ì¼ ë•Œ ìœ ìš©) */
        var bizName = businessMap[emp.businessId || emp.business_id];
        opt.textContent = emp.name + ' (' + (emp.position || 'ì§ì›') + (bizName ? ' Â· ' + bizName : '') + ')';
        sel.appendChild(opt);
    });

    /* í‡´ì§ê¸ˆ íƒ­ ì§ì› ë“œë¡­ë‹¤ìš´ë„ ë™ì¼í•˜ê²Œ ì±„ì›€ (ëª¨ë“  ì¬ì§ì + í‡´ì§ì í¬í•¨) */
    var sevSel = document.getElementById('sevEmployeeSelect');
    sevSel.innerHTML = '<option value="">ì§ì›ì„ ì„ íƒí•˜ì„¸ìš”</option>';
    /* í‡´ì§ê¸ˆ íƒ­ì€ í‡´ì§ìë„ ê³„ì‚° ê°€ëŠ¥ â†’ allEmployees ì „ì²´ ì‚¬ìš© */
    allEmployees.forEach(function(emp) {
        var opt = document.createElement('option');
        opt.value = emp.id;
        var bizName = businessMap[emp.businessId || emp.business_id];
        var statusLabel = emp.status === 'resigned' ? ' [í‡´ì‚¬]' : '';
        opt.textContent = emp.name + ' (' + (emp.position || 'ì§ì›') + (bizName ? ' Â· ' + bizName : '') + ')' + statusLabel;
        sevSel.appendChild(opt);
    });
}

/* â”€â”€ í‡´ì§ê¸ˆ íƒ­: ì‚¬ì—…ì²´ í•„í„° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function onSevBizFilter() {
    var bizId = document.getElementById('sevBizFilter').value;
    var filtered = bizId === 'all'
        ? allEmployees
        : allEmployees.filter(function(e) {
            return (e.businessId || e.business_id) === bizId;
        });
    var sevSel = document.getElementById('sevEmployeeSelect');
    sevSel.innerHTML = '<option value="">ì§ì›ì„ ì„ íƒí•˜ì„¸ìš”</option>';
    filtered.forEach(function(emp) {
        var opt = document.createElement('option');
        opt.value = emp.id;
        var bizName = businessMap[emp.businessId || emp.business_id];
        var statusLabel = emp.status === 'resigned' ? ' [í‡´ì‚¬]' : '';
        opt.textContent = emp.name + ' (' + (emp.position || 'ì§ì›') + (bizName ? ' Â· ' + bizName : '') + ')' + statusLabel;
        sevSel.appendChild(opt);
    });
    /* ê²°ê³¼ ì´ˆê¸°í™” */
    document.getElementById('sevResult').style.display = 'none';
    document.getElementById('sevIneligible').style.display = 'none';
    document.getElementById('sevEmptyState').style.display = 'block';
}

/* â”€â”€ í‡´ì§ê¸ˆ ê³„ì‚° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function calculateSeverance() {
    var empId = document.getElementById('sevEmployeeSelect').value;
    if (!empId) { alert('ì§ì›ì„ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }

    var retireDate = document.getElementById('sevRetireDate').value; // '' í—ˆìš©
    var btn = document.getElementById('sevCalcBtn');

    document.getElementById('sevLoading').style.display = 'block';
    document.getElementById('sevEmptyState').style.display = 'none';
    document.getElementById('sevResult').style.display = 'none';
    document.getElementById('sevIneligible').style.display = 'none';
    btn.disabled = true;

    try {
        var url = '/.netlify/functions/severance-calculate?employeeId=' + empId;
        if (retireDate) url += '&retireDate=' + retireDate;

        var r = await fetch(url, {
            headers: { 'Authorization': 'Bearer ' + authToken }
        });
        var res = await r.json();

        if (!res.success) {
            alert(res.error || 'í‡´ì§ê¸ˆ ê³„ì‚° ì‹¤íŒ¨');
            document.getElementById('sevEmptyState').style.display = 'block';
            return;
        }

        if (!res.eligible) {
            /* 1ë…„ ë¯¸ë§Œ â€” ì§€ê¸‰ ë¶ˆê°€ */
            document.getElementById('sevIneligibleMsg').textContent = res.reason;
            document.getElementById('sevIneligible').style.display = 'block';
            return;
        }

        /* â”€â”€ ê²°ê³¼ í‘œì‹œ â”€â”€ */
        displaySeveranceResult(res);

    } catch(e) {
        console.error('í‡´ì§ê¸ˆ ê³„ì‚° ì˜¤ë¥˜:', e);
        alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ' + e.message);
        document.getElementById('sevEmptyState').style.display = 'block';
    } finally {
        document.getElementById('sevLoading').style.display = 'none';
        btn.disabled = false;
    }
}

/* â”€â”€ í‡´ì§ê¸ˆ ê²°ê³¼ ë Œë”ë§ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function displaySeveranceResult(res) {
    var fmt = function(n) { return 'â‚©' + Math.round(n).toLocaleString('ko-KR'); };
    var si = res.serviceInfo;
    var wi = res.wageInfo;

    /* ë©”ì¸ ê¸ˆì•¡ */
    document.getElementById('sevFinalAmount').textContent = fmt(res.severancePay);
    var isSimul = !document.getElementById('sevRetireDate').value;
    document.getElementById('sevAmountSub').textContent =
        (isSimul ? 'ì˜¤ëŠ˜ ê¸°ì¤€ ì‹œë®¬ë ˆì´ì…˜ Â· ' : '') +
        'ê·¼ì† ' + si.displayText + ' ê¸°ì¤€';

    /* ì§ì› ì •ë³´ */
    document.getElementById('sevEmpName').textContent = res.employee.name;
    document.getElementById('sevEmpHireDate').textContent = 'ì…ì‚¬ì¼: ' + res.employee.hireDate;

    /* ê·¼ì† ê¸°ê°„ */
    document.getElementById('sevServicePeriod').textContent = si.displayText;
    document.getElementById('sevServiceDays').textContent = 'ì´ ' + si.days.toLocaleString() + 'ì¼';

    /* ê¸°ì¤€ì¼ */
    document.getElementById('sevRetireDateDisplay').textContent = res.employee.retireDate;
    document.getElementById('sevRetireDateSub').textContent = isSimul ? '(ì˜¤ëŠ˜ ê¸°ì¤€)' : '(ì§€ì • í‡´ì§ì¼)';

    /* ì ìš© ì„ê¸ˆ/ì¼ */
    document.getElementById('sevWagePerDay').textContent = fmt(wi.finalWagePerDay) + '/ì¼';
    document.getElementById('sevWageType').textContent = wi.usedNormalWage ? 'í†µìƒì„ê¸ˆ ì ìš©' : 'í‰ê· ì„ê¸ˆ ì ìš©';

    /* ì„ê¸ˆ ì‚°ì • ë‚´ì—­ */
    var total3mEl = document.getElementById('sevTotal3m');
    total3mEl.innerHTML = fmt(wi.totalWage3m) +
        (wi.usedPayrollMonths === 0 ? ' <span class="badge-estimated">ì¶”ì‚°</span>' : '');
    document.getElementById('sevDays3m').textContent = '91ì¼ (3ê°œì›”)';
    document.getElementById('sevAvgWage').textContent = fmt(wi.avgWagePerDay) + '/ì¼';
    document.getElementById('sevNormalWage').textContent = fmt(wi.normalWagePerDay) + '/ì¼';
    document.getElementById('sevFinalWage').textContent = fmt(wi.finalWagePerDay) + '/ì¼';

    /* ë°ì´í„° ì†ŒìŠ¤ ì•ˆë‚´ */
    document.getElementById('sevDataNotice').textContent =
        'ğŸ’¡ ' + wi.dataSource + ' â€” ' +
        (wi.usedNormalWage
            ? 'í‰ê· ì„ê¸ˆì´ í†µìƒì„ê¸ˆë³´ë‹¤ ë‚®ì•„ í†µìƒì„ê¸ˆìœ¼ë¡œ ìë™ ëŒ€ì²´ë©ë‹ˆë‹¤.'
            : 'í‰ê· ì„ê¸ˆ â‰¥ í†µìƒì„ê¸ˆì´ë¯€ë¡œ í‰ê· ì„ê¸ˆì„ ì ìš©í•©ë‹ˆë‹¤.');

    /* ì—°ë„ë³„ ë‚´ì—­ */
    var breakdown = document.getElementById('sevBreakdown');
    breakdown.innerHTML = '';
    res.yearlyBreakdown.forEach(function(item) {
        var row = document.createElement('div');
        row.className = 'sev-breakdown-row';
        row.innerHTML = '<span>' + item.label + '</span><span style="font-weight:600">' + fmt(item.pay) + '</span>';
        breakdown.appendChild(row);
    });
    /* í•©ê³„ í–‰ */
    var totalRow = document.createElement('div');
    totalRow.className = 'sev-breakdown-row';
    totalRow.style.cssText = 'font-weight:800;font-size:16px;border-top:2px solid #e67e22;margin-top:8px;padding-top:12px;color:#e67e22';
    totalRow.innerHTML = '<span>í•©ê³„</span><span>' + fmt(res.severancePay) + '</span>';
    breakdown.appendChild(totalRow);

    document.getElementById('sevResult').style.display = 'block';
}

async function calculatePayroll() {
    var empId = document.getElementById('employeeSelect').value;
    if (!empId) { alert('ì§ì›ì„ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }

    var year = parseInt(document.getElementById('yearSelect').value);
    var month = parseInt(document.getElementById('monthSelect').value);
    var btn = document.getElementById('calculateBtn');

    document.getElementById('loading').style.display = 'block';
    document.getElementById('emptyState').style.display = 'none';
    document.getElementById('payslip').classList.remove('show');
    document.getElementById('warningBanner').classList.remove('show');
    btn.disabled = true;

    try {
        var r = await fetch('/.netlify/functions/calculate-payroll', {
            method: 'POST',
            headers: { 'Authorization': 'Bearer ' + authToken, 'Content-Type': 'application/json' },
            body: JSON.stringify({ employeeId: empId, year: year, month: month, recalculate: true })
        });
        var res = await r.json();
        if (res.success && res.data) {
            currentData = res.data;
            currentEmployee = employees.find(function(e) { return e.id === empId; });
            displayPayslip(res.data, empId, year, month);
        } else {
            alert(res.error || 'ê¸‰ì—¬ ê³„ì‚° ì‹¤íŒ¨');
            document.getElementById('emptyState').style.display = 'block';
        }
    } catch(e) {
        console.error(e);
        alert('ê¸‰ì—¬ ê³„ì‚° ì¤‘ ì˜¤ë¥˜ ë°œìƒ');
        document.getElementById('emptyState').style.display = 'block';
    } finally {
        document.getElementById('loading').style.display = 'none';
        btn.disabled = false;
    }
}

function displayPayslip(d, empId, year, month) {
    var emp = employees.find(function(e) { return e.id === empId; });
    var typeMap = { hourly: 'ì‹œê¸‰ì œ', monthly: 'ì›”ê¸‰ì œ', daily: 'ì¼ê¸‰ì œ' };

    document.getElementById('slipName').textContent = (emp ? emp.name : 'ì§ì›') + ' ê¸‰ì—¬ëª…ì„¸ì„œ';
    document.getElementById('slipPeriod').textContent = year + 'ë…„ ' + month + 'ì›”';

    document.getElementById('infoWorkDays').textContent = (d.total_work_days || 0) + 'ì¼';
    document.getElementById('infoRegularHours').textContent = (d.regular_work_hours || 0).toFixed(1) + 'h';
    document.getElementById('infoOvertimeHours').textContent = (d.overtime_hours || 0).toFixed(1) + 'h';
    document.getElementById('infoNightHours').textContent = (d.night_work_hours || 0).toFixed(1) + 'h';
    document.getElementById('infoSalaryType').textContent = typeMap[d.salary_type] || d.salary_type || '-';

    var payItems = [
        { label: 'ê¸°ë³¸ê¸‰', value: d.basic_pay || 0 },
        { label: 'ì£¼íœ´ìˆ˜ë‹¹', value: d.weekly_holiday_pay || 0 },
        { label: 'ì—°ì¥ê·¼ë¡œìˆ˜ë‹¹', value: d.overtime_pay || 0 },
        { label: 'ì•¼ê°„ê·¼ë¡œìˆ˜ë‹¹', value: d.night_pay || 0 },
        { label: 'íœ´ì¼ê·¼ë¡œìˆ˜ë‹¹', value: d.holiday_pay || 0 }
    ].filter(function(i) { return i.value > 0; });
    var totalPayment = d.total_payment || 0;
    renderSection('paymentSection', payItems, totalPayment);
    document.getElementById('totalPaymentBadge').textContent = fmt(totalPayment);

    var nontaxItems = [
        { label: 'ì‹ëŒ€', value: d.meal_allowance || 0 },
        { label: 'ì°¨ëŸ‰ìœ ì§€ë¹„', value: d.car_allowance || 0 },
        { label: 'ë³´ìœ¡ìˆ˜ë‹¹', value: d.childcare_allowance || 0 }
    ].filter(function(i) { return i.value > 0; });
    var totalNontax = d.non_taxable_amount || 0;
    renderSection('nontaxSection', nontaxItems, totalNontax);
    document.getElementById('totalNontaxBadge').textContent = fmt(totalNontax);
    if (nontaxItems.length === 0) {
        document.getElementById('nontaxSection').innerHTML = '<div style="padding:10px 0;color:#999;font-size:13px;">ë¹„ê³¼ì„¸ ìˆ˜ë‹¹ ì—†ìŒ</div>';
    }

    var dedItems = [
        { label: 'êµ­ë¯¼ì—°ê¸ˆ', value: d.national_pension || 0 },
        { label: 'ê±´ê°•ë³´í—˜', value: d.health_insurance || 0 },
        { label: 'ì¥ê¸°ìš”ì–‘ë³´í—˜', value: d.long_term_care || 0 },
        { label: 'ê³ ìš©ë³´í—˜', value: d.employment_insurance || 0 },
        { label: 'ì†Œë“ì„¸', value: d.income_tax || 0 },
        { label: 'ì§€ë°©ì†Œë“ì„¸', value: d.local_tax || 0 }
    ].filter(function(i) { return i.value > 0; });
    var totalDed = d.total_deductions || 0;
    renderSection('deductionSection', dedItems, totalDed);
    document.getElementById('totalDeductionBadge').textContent = '-' + fmt(totalDed);

    var empItems = [
        { label: 'êµ­ë¯¼ì—°ê¸ˆ', value: d.employer_national_pension || 0 },
        { label: 'ê±´ê°•ë³´í—˜', value: d.employer_health_insurance || 0 },
        { label: 'ì¥ê¸°ìš”ì–‘ë³´í—˜', value: d.employer_long_term_care || 0 },
        { label: 'ê³ ìš©ë³´í—˜', value: d.employer_employment_insurance || 0 },
        { label: 'ì‚°ì¬ë³´í—˜', value: d.employer_industrial_accident || 0 }
    ].filter(function(i) { return i.value > 0; });
    var totalEmp = empItems.reduce(function(s, i) { return s + i.value; }, 0);
    renderSection('employerSection', empItems, totalEmp);
    document.getElementById('totalEmployerBadge').textContent = fmt(totalEmp);
    if (empItems.length === 0) {
        document.getElementById('employerSection').innerHTML = '<div style="padding:10px 0;color:#999;font-size:13px;">ì‚¬ì—…ì£¼ ë¶€ë‹´ë¶„ ì—†ìŒ</div>';
    }

    var net = d.net_payment || 0;
    document.getElementById('netPayment').textContent = fmt(net);
    document.getElementById('netSub').textContent = 'ì´ ì§€ê¸‰ì•¡ ' + fmt(totalPayment) + ' - ì´ ê³µì œì•¡ ' + fmt(totalDed);

    var warnings = d.warnings || [];
    if (warnings.length > 0) {
        var banner = document.getElementById('warningBanner');
        banner.innerHTML = '<div style="font-weight:700;margin-bottom:8px">âš ï¸ ì´ìƒíƒì§€ ê²½ê³ </div>' +
            warnings.map(function(w) {
                var cls = w.level === 'critical' ? 'critical' : 'warning';
                var icon = w.level === 'critical' ? 'ğŸ”´' : 'ğŸŸ¡';
                return '<div class="warning-item ' + cls + '">' + icon + ' ' + w.message + '</div>';
            }).join('');
        banner.classList.add('show');
    }

    document.getElementById('payslip').classList.add('show');
    document.getElementById('sendNotifyBtn').style.display = 'inline-flex';
}

function renderSection(containerId, items, total) {
    var html = items.map(function(i) {
        return '<div class="section-row"><span class="label">' + i.label + '</span><span class="value">' + fmt(i.value) + '</span></div>';
    }).join('');
    html += '<div class="section-row section-total"><span class="label">í•©ê³„</span><span class="value">' + fmt(total) + '</span></div>';
    document.getElementById(containerId).innerHTML = html;
}

function fmt(n) {
    return 'â‚©' + Math.round(n || 0).toLocaleString('ko-KR');
}

/* â”€â”€ ê¸‰ì—¬ëª…ì„¸ì„œ ì¹´ì¹´ì˜¤/SMS ë°œì†¡ â”€â”€ */
async function sendPayrollNotification() {
    if (!currentData || !currentEmployee) { alert('ë¨¼ì € ê¸‰ì—¬ë¥¼ ê³„ì‚°í•´ì£¼ì„¸ìš”.'); return; }
    var btn = document.getElementById('sendNotifyBtn');
    var year = document.getElementById('yearSelect').value;
    var month = document.getElementById('monthSelect').value;
    var payMonth = year + 'ë…„ ' + month + 'ì›”';
    var netPay = currentData.net_payment || 0;
    if (!confirm(currentEmployee.name + 'ë‹˜ì—ê²Œ ' + payMonth + ' ê¸‰ì—¬ëª…ì„¸ì„œ ì•Œë¦¼ì„ ë°œì†¡í• ê¹Œìš”?\nì‹¤ìˆ˜ë ¹ì•¡: â‚©' + netPay.toLocaleString('ko-KR'))) return;
    btn.disabled = true;
    btn.textContent = 'ğŸ“¤ ë°œì†¡ ì¤‘...';
    try {
        var r = await fetch('/.netlify/functions/solapi-send', {
            method: 'POST',
            headers: { 'Authorization': 'Bearer ' + authToken, 'Content-Type': 'application/json' },
            body: JSON.stringify({
                type: 'payroll',
                employeeId: currentEmployee.id,
                data: { payMonth: payMonth, netPay: netPay, link: 'https://staffmanager.io/salary.html' }
            })
        });
        var res = await r.json();
        if (res.success) {
            var chMap = { alimtalk: 'ì¹´ì¹´ì˜¤ ì•Œë¦¼í†¡', sms: 'SMS', sms_fallback: 'SMS(í´ë°±)' };
            alert('âœ… ë°œì†¡ ì™„ë£Œ!\nì±„ë„: ' + (chMap[res.channel] || res.channel));
            btn.textContent = 'âœ… ë°œì†¡ ì™„ë£Œ';
            setTimeout(function() { btn.textContent = 'ğŸ“± ì¹´ì¹´ì˜¤/SMS ë°œì†¡'; btn.disabled = false; }, 3000);
        } else {
            alert('ë°œì†¡ ì‹¤íŒ¨: ' + (res.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
            btn.textContent = 'ğŸ“± ì¹´ì¹´ì˜¤/SMS ë°œì†¡';
            btn.disabled = false;
        }
    } catch(e) {
        alert('ë°œì†¡ ì¤‘ ì˜¤ë¥˜: ' + e.message);
        btn.textContent = 'ğŸ“± ì¹´ì¹´ì˜¤/SMS ë°œì†¡';
        btn.disabled = false;
    }
}

/* â”€â”€ PDF ë‹¤ìš´ë¡œë“œ (ì„œë²„ ìƒì„± - í•œê¸€ ì™„ë²½ ì§€ì›) â”€â”€ */
async function downloadPDF() {
    // ê¸‰ì—¬ ê³„ì‚° í›„ì—ë§Œ ì‚¬ìš© ê°€ëŠ¥ (currentData.id í•„ìš”)
    if (!currentData || !currentData.id) { alert('ë¨¼ì € ê¸‰ì—¬ë¥¼ ê³„ì‚°í•´ì£¼ì„¸ìš”.'); return; }

    var btn = document.querySelector('.btn-pdf');
    if (btn) { btn.textContent = 'â³ ìƒì„± ì¤‘...'; btn.disabled = true; }

    try {
        // ì„œë²„ì—ì„œ í•œê¸€ í°íŠ¸ í¬í•¨ PDF ìƒì„± (pdf-lib + NotoSansKR)
        var r = await fetch('/.netlify/functions/payroll-pdf?payrollId=' + currentData.id, {
            headers: { 'Authorization': 'Bearer ' + authToken }
        });

        if (r.status === 401) {
            alert('ì¸ì¦ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
            window.location.href = '/login.html';
            return;
        }
        if (!r.ok) {
            var errData = await r.json().catch(function() { return {}; });
            throw new Error(errData.error || 'PDF ìƒì„± ì‹¤íŒ¨ (' + r.status + ')');
        }

        // Blobìœ¼ë¡œ ë°›ì•„ì„œ ë¸Œë¼ìš°ì € ë‹¤ìš´ë¡œë“œ íŠ¸ë¦¬ê±°
        var blob = await r.blob();
        var url = URL.createObjectURL(blob);
        var a = document.createElement('a');
        var year = document.getElementById('yearSelect').value;
        var month = document.getElementById('monthSelect').value;
        var empName = currentEmployee ? currentEmployee.name : 'ì§ì›';
        a.href = url;
        a.download = 'ê¸‰ì—¬ëª…ì„¸ì„œ_' + year + 'ë…„' + month + 'ì›”_' + empName + '.pdf';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

    } catch(e) {
        console.error('PDF ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜:', e);
        alert('PDF ìƒì„± ì¤‘ ì˜¤ë¥˜: ' + e.message);
    } finally {
        if (btn) { btn.textContent = 'ğŸ“¥ PDF ë‹¤ìš´ë¡œë“œ'; btn.disabled = false; }
    }
}

function handleLogout() {
    if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        localStorage.removeItem('authToken');
        localStorage.removeItem('userInfo');
        window.location.href = '/login.html';
    }
}
</script>
</body>
</html>
