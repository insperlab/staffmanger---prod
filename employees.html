<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì§ì› ê´€ë¦¬ - StaffManager</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','Roboto','Noto Sans KR',sans-serif;background:#f5f7fa;min-height:100vh}
        .navbar{background:#fff;box-shadow:0 2px 4px rgba(0,0,0,.1);padding:0 30px;height:70px;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:100}
        .navbar-brand{display:flex;align-items:center;gap:12px;font-size:24px;font-weight:700;color:#667eea;text-decoration:none}
        .navbar-menu{display:flex;gap:30px;align-items:center}
        .navbar-menu a{text-decoration:none;color:#666;font-weight:500;transition:color .3s}
        .navbar-menu a:hover,.navbar-menu a.active{color:#667eea;font-weight:600}
        .user-menu{display:flex;align-items:center;gap:15px}
        .user-info{text-align:right}
        .user-name{font-weight:600;color:#333;font-size:14px}
        .company-name{font-size:12px;color:#999}
        .logout-btn{padding:8px 20px;background:#f5f7fa;border:none;border-radius:6px;color:#666;cursor:pointer;font-weight:600;transition:all .3s}
        .logout-btn:hover{background:#667eea;color:#fff}
        .container{max-width:1400px;margin:0 auto;padding:40px 30px}
        .page-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:30px;flex-wrap:wrap;gap:15px}
        .page-title{font-size:32px;color:#333;margin-bottom:8px}
        .page-subtitle{color:#999;font-size:16px}
        .btn-primary{padding:12px 24px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;border:none;border-radius:8px;font-size:15px;font-weight:600;cursor:pointer;transition:all .3s;text-decoration:none;display:inline-flex;align-items:center;gap:8px}
        .btn-primary:hover{transform:translateY(-2px);box-shadow:0 8px 16px rgba(102,126,234,.3)}
        .stats-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:20px;margin-bottom:30px}
        .stat-card{background:#fff;padding:20px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.08)}
        .stat-label{font-size:13px;color:#999;margin-bottom:8px}
        .stat-value{font-size:28px;font-weight:700;color:#333}
        .controls{background:#fff;padding:20px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.08);margin-bottom:20px;display:flex;gap:15px;align-items:center;flex-wrap:wrap}
        .search-box{flex:1;min-width:200px}
        .search-box input{width:100%;padding:10px 16px;border:2px solid #e0e0e0;border-radius:8px;font-size:14px}
        .search-box input:focus{outline:none;border-color:#667eea}
        .filter-select{padding:10px 16px;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;cursor:pointer;background:#fff}
        .filter-select:focus{outline:none;border-color:#667eea}
        .table-container{background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.08);overflow:hidden}
        table{width:100%;border-collapse:collapse}
        thead{background:#f8f9fa}
        th{padding:16px 20px;text-align:left;font-weight:600;color:#333;font-size:14px;border-bottom:2px solid #e0e0e0;white-space:nowrap}
        tbody tr{border-bottom:1px solid #f0f0f0;transition:background .2s;cursor:pointer}
        tbody tr:hover{background:#f8f9fa}
        td{padding:16px 20px;color:#666;font-size:14px}
        .employee-name{font-weight:600;color:#333}
        .status-badge{display:inline-block;padding:4px 12px;border-radius:12px;font-size:12px;font-weight:600}
        .status-active{background:#d4edda;color:#155724}
        .status-on_leave{background:#fff3cd;color:#856404}
        .status-resigned{background:#f8d7da;color:#721c24}
        .biz-badge{display:inline-block;padding:3px 10px;border-radius:10px;font-size:12px;font-weight:500;background:#e8eaf6;color:#3949ab}
        .biz-unassigned{background:#fff3e0;color:#e65100}
        .loading{text-align:center;padding:60px 20px}
        .spinner{border:4px solid #f3f3f3;border-top:4px solid #667eea;border-radius:50%;width:50px;height:50px;animation:spin 1s linear infinite;margin:0 auto 15px}
        @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
        .empty-state{text-align:center;padding:80px 20px}
        .empty-state-icon{font-size:80px;margin-bottom:15px}
        .empty-state-text{font-size:18px;color:#999;margin-bottom:20px}
        .result-count{font-size:13px;color:#999;padding:8px 0}
        @media(max-width:768px){.navbar-menu{display:none}.controls{flex-direction:column}.search-box{min-width:100%}.stats-row{grid-template-columns:1fr 1fr}th,td{padding:12px 10px;font-size:13px}}
    </style>
</head>
<body>
    <nav class="navbar">
        <a href="/dashboard.html" class="navbar-brand"><span>ğŸ‘‹</span><span>StaffManager</span></a>
        <div class="navbar-menu">
            <a href="/dashboard.html">ëŒ€ì‹œë³´ë“œ</a>
            <a href="/employees.html" class="active">ì§ì› ê´€ë¦¬</a>
            <a href="/attendances.html">ê·¼íƒœ ê´€ë¦¬</a>
            <a href="/calendar.html">ë‹¬ë ¥ ê´€ë¦¬</a>
            <a href="/salary.html">ê¸‰ì—¬ ê´€ë¦¬</a>
            <a href="/contracts.html">ê³„ì•½ ê´€ë¦¬</a>
            <a href="/businesses.html">ì‚¬ì—…ì¥ ê´€ë¦¬</a>
            <a href="/settings.html">í™˜ê²½ì„¤ì •</a>
        </div>
        <div class="user-menu">
            <div class="user-info">
                <div class="user-name" id="userName">ê¹€ì¸ìŠ¤</div>
                <div class="company-name" id="companyName">ì¸ìŠ¤í¼ë© ê´€ë¦¬</div>
            </div>
            <button class="logout-btn" onclick="handleLogout()">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </nav>
    <div class="container">
        <div class="page-header">
            <div>
                <h1 class="page-title">âœ¨ğŸ‘¥ ì§ì› ê´€ë¦¬</h1>
                <p class="page-subtitle">í˜„ì¬ ì¬ì§ ì¤‘ì¸ ì§ì› ì •ë³´ë¥¼ ê´€ë¦¬í•˜ê³  ì¡°íšŒí•©ë‹ˆë‹¤.</p>
            </div>
            <div style="display:flex;gap:10px">
                <a href="/employees-import.html" class="btn-primary" style="background:#27ae60"><span>ğŸ“¥</span> <span>ì§ì› ì¼ê´„ ì¶”ê°€</span></a>
                <a href="/employee-new.html" class="btn-primary"><span>â•</span> <span>ìƒˆ ì§ì› ì¶”ê°€</span></a>
            </div>
        </div>
        <div class="stats-row">
            <div class="stat-card"><div class="stat-label">ì „ì²´ ì§ì›</div><div class="stat-value" id="totalEmployees">0</div></div>
            <div class="stat-card"><div class="stat-label">í˜„ì¬ ì¬ì§ì¤‘ì¸ ì§ì›</div><div class="stat-value" id="activeEmployees">0</div></div>
            <div class="stat-card"><div class="stat-label">íœ´ê°€ì¤‘</div><div class="stat-value" id="onLeaveEmployees">0</div></div>
            <div class="stat-card"><div class="stat-label">í‡´ì‚¬ì</div><div class="stat-value" id="resignedEmployees">0</div></div>
        </div>
        <div class="controls">
            <div class="search-box"><input type="text" id="searchInput" placeholder="ğŸ” ì´ë¦„, íœ´ëŒ€í°, ë¶€ì„œ, ì§ì±…..."></div>
            <!-- âœ… [ë³€ê²½1] ì‚¬ì—…ì¥ í•„í„° select â€” onchangeì— BusinessFilter.setSelected() ì—°ë™ -->
            <select class="filter-select" id="businessFilter" onchange="onBizSelectChange()">
                <option value="all">ì „ì²´ ì‚¬ì—…ì¥</option>
                <option value="unassigned">ë¯¸ë°°ì •</option>
            </select>
            <select class="filter-select" id="statusFilter"><option value="all">ì „ì²´ ìƒíƒœ</option><option value="active">ì¬ì§ì¤‘</option><option value="on_leave">íœ´ê°€ì¤‘</option><option value="resigned">í‡´ì‚¬ì</option></select>
            <select class="filter-select" id="sortBy"><option value="name">ì´ë¦„ìˆœ</option><option value="hireDate">ê³ ìš©ì¼ìˆœ</option><option value="department">ë¶€ì„œìˆœ</option><option value="business">ì‚¬ì—…ì¥ìˆœ</option></select>
        </div>
        <div class="result-count" id="resultCount"></div>
        <div id="loadingState" class="table-container">
            <div class="loading"><div class="spinner"></div><p style="color:#999">ì§ì› ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p></div>
        </div>
        <div id="employeesTable" class="table-container" style="display:none">
            <table><thead><tr><th>ì´ë¦„</th><th>íœ´ëŒ€í°</th><th>ë¶€ì„œ</th><th>ì§ì±…</th><th>ì‚¬ì—…ì¥</th><th>ê³ ìš©ì¼</th><th>ìƒíƒœ</th></tr></thead><tbody id="employeesBody"></tbody></table>
        </div>
        <div id="emptyState" class="table-container" style="display:none"><div class="empty-state"><div class="empty-state-icon">ğŸš«</div><p class="empty-state-text">ì•„ì§ ë“±ë¡ëœ ì§ì›ì´ ì—†ìŠµë‹ˆë‹¤.</p><a href="/employee-new.html" class="btn-primary"><span>â•</span><span>ìƒˆ ì§ì› ì¶”ê°€</span></a></div></div>
    </div>

<!-- âœ… [ë³€ê²½2] business-filter.js ê³µí†µ ëª¨ë“ˆ ë¡œë“œ -->
<script src="/business-filter.js"></script>
<script>
var authToken=null,userInfo=null,allEmployees=[],filteredEmployees=[],businessMap={};

window.addEventListener('DOMContentLoaded',async function(){
    authToken=localStorage.getItem('authToken');
    var ui=localStorage.getItem('userInfo');
    if(!authToken||!ui){window.location.href='/login.html';return}
    try{userInfo=JSON.parse(ui)}catch(e){window.location.href='/login.html';return}
    document.getElementById('userName').textContent=userInfo.name||'ê¹€ì¸ìŠ¤';
    document.getElementById('companyName').textContent=userInfo.companyName||'';
    document.getElementById('searchInput').addEventListener('input',filterEmployees);
    document.getElementById('businessFilter').addEventListener('change',filterEmployees);
    document.getElementById('statusFilter').addEventListener('change',filterEmployees);
    document.getElementById('sortBy').addEventListener('change',filterEmployees);
    await Promise.all([loadBusinesses(),loadEmployees()]);
});

/* âœ… [ë³€ê²½3] businesses-list ì‚¬ìš© + localStorage ë³µì› */
async function loadBusinesses(){
    try{
        var r=await fetch('/.netlify/functions/businesses-list',{headers:{'Authorization':'Bearer '+authToken}});
        var res=await r.json();
        if(res.success&&res.businesses){
            var sel=document.getElementById('businessFilter');
            res.businesses.forEach(function(b){
                businessMap[b.id]=b.name;
                var opt=document.createElement('option');
                opt.value=b.id;
                opt.textContent=b.name+(b.is_headquarters?' (ë³¸ì )':'');
                sel.appendChild(opt);
            });
            /* localStorageì—ì„œ ì´ì „ ì„ íƒê°’ ë³µì› */
            var saved=BusinessFilter.getSelected();
            if(saved){sel.value=saved;}
        }
    }catch(e){console.error('ì‚¬ì—…ì¥ ì •ë³´ ì˜¤ë¥˜:',e)}
}

/* âœ… [ë³€ê²½4] ì‚¬ì—…ì¥ select ë³€ê²½ ì‹œ BusinessFilter.setSelected() í˜¸ì¶œ */
function onBizSelectChange(){
    var val=document.getElementById('businessFilter').value;
    BusinessFilter.setSelected(val);
    filterEmployees();
}

async function loadEmployees(){
    try{
        var response=await fetch('/.netlify/functions/employees-list',{headers:{'Authorization':'Bearer '+authToken,'Content-Type':'application/json'}});
        var data=await response.json();
        if(data.success){
            allEmployees=data.data.employees||[];filteredEmployees=allEmployees.slice();
            updateStats();renderEmployees();
            document.getElementById('loadingState').style.display='none';
            if(allEmployees.length===0){document.getElementById('emptyState').style.display='block'}
            else{document.getElementById('employeesTable').style.display='block'}
        }else{throw new Error(data.error)}
    }catch(e){console.error('ì§ì› ì •ë³´ ì˜¤ë¥˜:',e);document.getElementById('loadingState').style.display='none';document.getElementById('emptyState').style.display='block'}
}

function updateStats(){
    document.getElementById('totalEmployees').textContent=allEmployees.length;
    document.getElementById('activeEmployees').textContent=allEmployees.filter(function(e){return e.status==='active'}).length;
    document.getElementById('onLeaveEmployees').textContent=allEmployees.filter(function(e){return e.status==='on_leave'}).length;
    document.getElementById('resignedEmployees').textContent=allEmployees.filter(function(e){return e.status==='resigned'}).length;
}

function renderEmployees(){
    var tbody=document.getElementById('employeesBody');tbody.innerHTML='';
    filteredEmployees.forEach(function(emp){
        var row=document.createElement('tr');
        row.onclick=function(){viewEmployeeDetail(emp.id)};
        var statusText='',statusClass='';
        switch(emp.status){case 'active':statusText='ì¬ì§ì¤‘';statusClass='status-active';break;case 'on_leave':statusText='íœ´ê°€ì¤‘';statusClass='status-on_leave';break;case 'resigned':statusText='í‡´ì‚¬ì';statusClass='status-resigned';break;default:statusText=emp.status||'-';statusClass='status-active'}
        var hireDate=emp.hireDate?new Date(emp.hireDate).toISOString().split('T')[0]:'-';
        var bizId=emp.businessId||emp.business_id||null;
        var bizName=bizId?(businessMap[bizId]||'ë¯¸ë°°ì •'):'';
        var bizHtml=bizName?'<span class="biz-badge">'+escapeHtml(bizName)+'</span>':'<span class="biz-badge biz-unassigned">ë¯¸ë°°ì •</span>';
        row.innerHTML='<td class="employee-name">'+escapeHtml(emp.name)+'</td><td>'+escapeHtml(emp.phone||'-')+'</td><td>'+escapeHtml(emp.department||'-')+'</td><td>'+escapeHtml(emp.position||'-')+'</td><td>'+bizHtml+'</td><td>'+hireDate+'</td><td><span class="status-badge '+statusClass+'">'+statusText+'</span></td>';
        tbody.appendChild(row);
    });
    var countEl=document.getElementById('resultCount');
    if(filteredEmployees.length<allEmployees.length){countEl.textContent='ì´ '+filteredEmployees.length+'ëª… / ì „ì²´ '+allEmployees.length+'ëª…'}else{countEl.textContent=''}
}

function filterEmployees(){
    var searchTerm=document.getElementById('searchInput').value.toLowerCase();
    var bizFilter=document.getElementById('businessFilter').value;
    var statusFilter=document.getElementById('statusFilter').value;
    var sortBy=document.getElementById('sortBy').value;
    filteredEmployees=allEmployees.filter(function(emp){
        var matchSearch=!searchTerm||(emp.name&&emp.name.toLowerCase().indexOf(searchTerm)>=0)||(emp.phone&&emp.phone.toLowerCase().indexOf(searchTerm)>=0)||(emp.department&&emp.department.toLowerCase().indexOf(searchTerm)>=0);
        var empBizId=emp.businessId||emp.business_id||null;
        var matchBiz=bizFilter==='all'||(bizFilter==='unassigned'&&!empBizId)||empBizId===bizFilter;
        var matchStatus=statusFilter==='all'||emp.status===statusFilter;
        return matchSearch&&matchBiz&&matchStatus;
    });
    filteredEmployees.sort(function(a,b){
        switch(sortBy){
            case 'name':return (a.name||'').localeCompare(b.name||'','ko');
            case 'hireDate':return new Date(b.hireDate||0)-new Date(a.hireDate||0);
            case 'department':return (a.department||'').localeCompare(b.department||'','ko');
            case 'business':var aBiz=businessMap[a.businessId||a.business_id]||'zzz';var bBiz=businessMap[b.businessId||b.business_id]||'zzz';return aBiz.localeCompare(bBiz,'ko');
            default:return 0;
        }
    });
    renderEmployees();
}

function viewEmployeeDetail(employeeId){window.location.href='/employee-detail.html?id='+employeeId}
function escapeHtml(str){if(!str)return'';return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');}

function handleLogout(){
    if(confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')){
        localStorage.removeItem('authToken');
        localStorage.removeItem('userInfo');
        localStorage.removeItem('sm_selected_business');
        sessionStorage.clear();
        window.location.href='/login.html';
    }
}
</script>
</body>
</html>
