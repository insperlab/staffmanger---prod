<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¶œí‡´ê·¼ ê¸°ë¡ - StaffManager</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        /* 
         * ë©”ì¸ ì»¨í…Œì´ë„ˆ
         * ëª¨ë°”ì¼ì—ì„œ ë³´ê¸° ì¢‹ë„ë¡ ìµœëŒ€ ë„ˆë¹„ë¥¼ ì œí•œí•˜ê³ 
         * ê·¸ë¦¼ì íš¨ê³¼ë¡œ ì…ì²´ê°ì„ ì¤ë‹ˆë‹¤
         */
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 450px;
            width: 100%;
            padding: 40px 30px;
        }

        /* ë¡œê³  ë° í—¤ë” */
        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .logo {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .company-name {
            font-size: 24px;
            font-weight: 700;
            color: #333;
            margin-bottom: 8px;
        }

        .page-subtitle {
            color: #999;
            font-size: 15px;
        }

        /* 
         * í˜„ì¬ ì‹œê° í‘œì‹œ
         * ì§ì›ì´ ì •í™•íˆ ëª‡ ì‹œì— ì°ì—ˆëŠ”ì§€ ë°”ë¡œ í™•ì¸í•  ìˆ˜ ìˆê²Œ
         * í° ê¸€ì”¨ë¡œ ëˆˆì— ì˜ ë„ê²Œ í‘œì‹œí•©ë‹ˆë‹¤
         */
        .current-time {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 30px;
            border: 2px solid #e0e0e0;
        }

        .time-label {
            font-size: 13px;
            color: #999;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .time-display {
            font-size: 36px;
            font-weight: 700;
            color: #667eea;
            font-variant-numeric: tabular-nums;
        }

        .date-display {
            font-size: 16px;
            color: #666;
            margin-top: 8px;
        }

        /* í¼ ìš”ì†Œ */
        .form-group {
            margin-bottom: 24px;
        }

        label {
            display: block;
            margin-bottom: 10px;
            color: #333;
            font-weight: 600;
            font-size: 15px;
        }

        /*
         * ì „í™”ë²ˆí˜¸ ì…ë ¥ í•„ë“œ
         * ëª¨ë°”ì¼ì—ì„œ ìˆ«ì í‚¤íŒ¨ë“œê°€ ìë™ìœ¼ë¡œ ë‚˜íƒ€ë‚˜ë„ë¡
         * type="tel"ì„ ì‚¬ìš©í•©ë‹ˆë‹¤
         * í„°ì¹˜í•˜ê¸° ì‰½ë„ë¡ paddingì„ ë„‰ë„‰í•˜ê²Œ ì¤ë‹ˆë‹¤
         */
        input[type="tel"] {
            width: 100%;
            padding: 16px 18px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 17px;
            transition: all 0.3s;
        }

        input[type="tel"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
        }

        input[type="tel"]::placeholder {
            color: #bbb;
        }

        /* 
         * ì¶œê·¼/í‡´ê·¼ ë²„íŠ¼
         * ì†ê°€ë½ìœ¼ë¡œ ì‰½ê²Œ ëˆ„ë¥¼ ìˆ˜ ìˆë„ë¡ ìµœì†Œ ë†’ì´ 56px ì´ìƒ
         * (iOS Human Interface Guidelines ê¶Œì¥ì‚¬í•­)
         */
        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 24px;
        }

        .btn {
            padding: 18px 24px;
            border: none;
            border-radius: 12px;
            font-size: 17px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-height: 60px;
        }

        .btn-check-in {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-check-in:active {
            transform: scale(0.98);
        }

        .btn-check-out {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
        }

        .btn-check-out:active {
            transform: scale(0.98);
            background: #f5f7fa;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* ìƒíƒœ ë©”ì‹œì§€ */
        .status-message {
            padding: 16px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
            text-align: center;
            font-size: 15px;
        }

        .status-message.show {
            display: block;
        }

        .status-message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-message.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        /* ë¡œë”© ìƒíƒœ */
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ì•ˆë‚´ ì •ë³´ */
        .info-box {
            background: #f8f9fa;
            padding: 16px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .info-box p {
            color: #666;
            font-size: 14px;
            line-height: 1.6;
            margin: 0;
        }

        /* í‘¸í„° */
        .footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }

        .footer p {
            color: #999;
            font-size: 13px;
        }

        /* ë°˜ì‘í˜•: ì‘ì€ í™”ë©´ì—ì„œëŠ” ë²„íŠ¼ì„ ì„¸ë¡œë¡œ ë°°ì¹˜ */
        @media (max-width: 400px) {
            .action-buttons {
                grid-template-columns: 1fr;
            }
        }
    
  /* WiFi ì¸ì¦ ë±ƒì§€ (M7) */
  .wifi-badge {
    display: inline-flex; align-items: center; gap: 5px;
    font-size: 12px; font-weight: 600; padding: 4px 10px;
    border-radius: 20px; margin-top: 8px;
  }
  .wifi-badge.matched  { background: #F0FDF4; color: #16A34A; border: 1px solid #BBF7D0; }
  .wifi-badge.unmatched{ background: #FFF7ED; color: #EA580C; border: 1px solid #FED7AA; }
  .wifi-badge.unused   { display: none; }

  /* GPS ìƒíƒœ í‘œì‹œ ë°” */
  .gps-status-bar {
    display: flex; align-items: center; gap: 8px;
    font-size: 12px; padding: 8px 12px; border-radius: 8px;
    margin-bottom: 12px; transition: all 0.3s;
  }
  .gps-status-bar.searching {
    background: #EFF6FF; color: #1D4ED8; border: 1px solid #BFDBFE;
  }
  .gps-status-bar.good {
    background: #F0FDF4; color: #15803D; border: 1px solid #BBF7D0;
  }
  .gps-status-bar.poor {
    background: #FFF7ED; color: #C2410C; border: 1px solid #FED7AA;
  }
  .gps-status-bar.failed {
    background: #FEF2F2; color: #B91C1C; border: 1px solid #FECACA;
  }
  .gps-status-bar.hidden { display: none; }
  /* GPS ë°°ì§€ (ê²°ê³¼ í‘œì‹œìš©) */
  .gps-badge {
    display: inline-flex; align-items: center; gap: 5px;
    font-size: 12px; font-weight: 600; padding: 4px 10px;
    border-radius: 20px; margin-top: 4px;
  }
  .gps-badge.matched   { background: #F0FDF4; color: #16A34A; border: 1px solid #BBF7D0; }
  .gps-badge.unmatched { background: #FEF2F2; color: #B91C1C; border: 1px solid #FECACA; }
  .gps-badge.unused    { display: none; }

</style>
</head>
<body>
    <div class="container">
        <!-- í—¤ë” -->
        <div class="header">
            <div class="logo">ğŸ¯</div>
            <h1 class="company-name" id="companyName">StaffManager</h1>
            <p class="page-subtitle">ì¶œí‡´ê·¼ ê¸°ë¡ ì‹œìŠ¤í…œ</p>
        </div>

        <!-- í˜„ì¬ ì‹œê° í‘œì‹œ -->
        <div class="current-time">
            <div class="time-label">í˜„ì¬ ì‹œê°</div>
            <div class="time-display" id="currentTime">--:--</div>
            <div class="date-display" id="currentDate">----ë…„ --ì›” --ì¼</div>
        </div>

        <!-- GPS ìœ„ì¹˜ ìƒíƒœ í‘œì‹œ ë°” (ë°©ì‹ì´ GPSì¼ ë•Œ ë…¸ì¶œ) -->
        <div id="gpsStatusBar" class="gps-status-bar searching">
          <span id="gpsStatusIcon">ğŸ“¡</span>
          <span id="gpsStatusText">ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘... (ê¶Œí•œ í—ˆìš© í•„ìš”)</span>
        </div>

        <!-- ìƒíƒœ ë©”ì‹œì§€ -->
        <div id="statusMessage" class="status-message"></div>

        <!-- ë¡œë”© ìƒíƒœ -->
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p style="color: #666;">ì²˜ë¦¬ ì¤‘...</p>
        </div>

        <!-- ì¶œí‡´ê·¼ í¼ -->
        <div id="attendanceForm">
            <form id="checkInOutForm">
                <div class="form-group">
                    <label for="phoneNumber">íœ´ëŒ€ì „í™”ë²ˆí˜¸</label>
                    <input 
                        type="tel" 
                        id="phoneNumber" 
                        name="phoneNumber"
                        placeholder="010-1234-5678" 
                        required
                        autocomplete="tel"
                        pattern="[0-9]{3}-[0-9]{4}-[0-9]{4}"
                    >
                </div>

                <div class="action-buttons">
                    <button type="button" class="btn btn-check-in" onclick="handleCheckIn()">
                        <span>ğŸŒ…</span>
                        <span>ì¶œê·¼</span>
                    </button>
                    <button type="button" class="btn btn-check-out" onclick="handleCheckOut()">
                        <span>ğŸŒ†</span>
                        <span>í‡´ê·¼</span>
                    </button>
                </div>
            </form>

            <div class="info-box">
                <p>
                    ğŸ“± ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ê³  ì¶œê·¼ ë˜ëŠ” í‡´ê·¼ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”. 
                    ì¶œí‡´ê·¼ ê¸°ë¡ì€ ìë™ìœ¼ë¡œ ì €ì¥ë˜ë©°, ì¹´ì¹´ì˜¤í†¡ìœ¼ë¡œ í™•ì¸ ì•Œë¦¼ì„ ë°›ìœ¼ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </p>
            </div>
        </div>

        <!-- í‘¸í„° -->
        <div class="footer">
            <p>Powered by <strong>StaffManager</strong></p>
        </div>
    </div>

    <script>
        // ====================================
        // ì „ì—­ ë³€ìˆ˜
        // ====================================
        
        /*
         * URLì—ì„œ ë°›ì€ ì¶œí‡´ê·¼ í† í°
         * ì˜ˆ: https://staffmanager.io/attendance-checkin.html?token=ATT_abc123
         * ì´ í† í°ìœ¼ë¡œ ì–´ëŠ íšŒì‚¬ì˜ QRì½”ë“œì¸ì§€ ì‹ë³„í•©ë‹ˆë‹¤
         */
        let attendanceToken = null;
        let companyInfo = null;
        let currentLocation = { latitude: null, longitude: null };

        // ====================================
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
        // ====================================

        window.addEventListener('DOMContentLoaded', async () => {
            // URL íŒŒë¼ë¯¸í„°ì—ì„œ í† í° ì¶”ì¶œ
            const urlParams = new URLSearchParams(window.location.search);
            attendanceToken = urlParams.get('token');

            // í† í°ì´ ì—†ìœ¼ë©´ ì—ëŸ¬ í‘œì‹œ
            if (!attendanceToken) {
                showStatus('ìœ íš¨í•˜ì§€ ì•Šì€ QRì½”ë“œì…ë‹ˆë‹¤. ë‹¤ì‹œ ì´¬ì˜í•´ì£¼ì„¸ìš”.', 'error');
                disableForm();
                return;
            }

            // í˜„ì¬ ì‹œê° í‘œì‹œ ì‹œì‘
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);  // 1ì´ˆë§ˆë‹¤ ê°±ì‹ 

            // â”€â”€ GPS ìœ„ì¹˜ ì •ë³´ ì·¨ë“ (ì •í™•ë„ ê²€ì¦ í¬í•¨) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // ë¹„ìœ : GPS = ìœ„ì„± ì‹ í˜¸ ì¡ê¸°. ë„ì‹¬/ì‹¤ë‚´ì—ì„œëŠ” ì•½í•  ìˆ˜ ìˆìŒ
            //   - ì •í™•ë„ 100m ì´ë‚´ë§Œ ìœ íš¨ë¡œ ì²˜ë¦¬
            //   - ì·¨ë“ ìƒíƒœë¥¼ ì§ì›ì—ê²Œ ì‹¤ì‹œê°„ìœ¼ë¡œ í‘œì‹œ
            //   - PC ë¸Œë¼ìš°ì € ë“± GPS ì—†ëŠ” í™˜ê²½ë„ ì¹œì ˆí•˜ê²Œ ì•ˆë‚´
            fetchGpsLocation();

            // ì „í™”ë²ˆí˜¸ ì…ë ¥ í•„ë“œì— ìë™ í¬ë§·íŒ… ì ìš©
            setupPhoneNumberFormatting();
        });

        // ====================================
        // í˜„ì¬ ì‹œê° ì—…ë°ì´íŠ¸
        // ====================================

        function updateCurrentTime() {
            const now = new Date();
            
            // ì‹œê° í‘œì‹œ (HH:MM:SS í˜•ì‹)
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            document.getElementById('currentTime').textContent = `${hours}:${minutes}:${seconds}`;

            // ë‚ ì§œ í‘œì‹œ
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const date = String(now.getDate()).padStart(2, '0');
            const dayNames = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
            const dayName = dayNames[now.getDay()];
            document.getElementById('currentDate').textContent = 
                `${year}ë…„ ${month}ì›” ${date}ì¼ (${dayName})`;
        }

        // ====================================
        // ì „í™”ë²ˆí˜¸ ìë™ í¬ë§·íŒ…
        // ====================================

        function setupPhoneNumberFormatting() {
            const phoneInput = document.getElementById('phoneNumber');
            
            phoneInput.addEventListener('input', (e) => {
                // ìˆ«ìë§Œ ì¶”ì¶œ
                let value = e.target.value.replace(/[^0-9]/g, '');
                
                // 11ìë¦¬ë¡œ ì œí•œ
                if (value.length > 11) {
                    value = value.slice(0, 11);
                }
                
                // ìë™ìœ¼ë¡œ í•˜ì´í”ˆ ì¶”ê°€
                // ì˜ˆ: 01012345678 â†’ 010-1234-5678
                if (value.length <= 3) {
                    e.target.value = value;
                } else if (value.length <= 7) {
                    e.target.value = `${value.slice(0, 3)}-${value.slice(3)}`;
                } else {
                    e.target.value = `${value.slice(0, 3)}-${value.slice(3, 7)}-${value.slice(7)}`;
                }
            });
        }

        // ====================================
        // ì¶œê·¼ ì²˜ë¦¬
        // ====================================

        async function handleCheckIn() {
            const phoneNumber = document.getElementById('phoneNumber').value.trim();
            
            // ì „í™”ë²ˆí˜¸ ìœ íš¨ì„± ê²€ì‚¬
            if (!phoneNumber) {
                showStatus('ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            // ì „í™”ë²ˆí˜¸ í˜•ì‹ ê²€ì¦ (010-1234-5678)
            const phoneRegex = /^010-\d{4}-\d{4}$/;
            if (!phoneRegex.test(phoneNumber)) {
                showStatus('ì „í™”ë²ˆí˜¸ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. (ì˜ˆ: 010-1234-5678)', 'error');
                return;
            }

            // â”€â”€ GPS ì‚¬ì „ ê²€ì¦: í”„ë¡ íŠ¸ëŠ” ì°¨ë‹¨ ì•ˆ í•¨, ì„œë²„ê°€ ë°©ì‹ ê¸°ì¤€ìœ¼ë¡œ íŒë‹¨
            // GPS ìƒíƒœ ë°”ëŠ” ìˆœìˆ˜ ì •ë³´ í‘œì‹œìš© â€” ìœ„ì¹˜ ì—†ì–´ë„ ì œì¶œ í—ˆìš©
            // (WiFi ë°©ì‹ì´ë©´ ì„œë²„ê°€ GPS ì—†ì–´ë„ í†µê³¼ì‹œí‚´)

            // ì¶œê·¼ API í˜¸ì¶œ
            await submitAttendance('check-in', phoneNumber);
        }

        // ====================================
        // í‡´ê·¼ ì²˜ë¦¬
        // ====================================

        async function handleCheckOut() {
            const phoneNumber = document.getElementById('phoneNumber').value.trim();
            
            // ì „í™”ë²ˆí˜¸ ìœ íš¨ì„± ê²€ì‚¬
            if (!phoneNumber) {
                showStatus('ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            // ì „í™”ë²ˆí˜¸ í˜•ì‹ ê²€ì¦
            const phoneRegex = /^010-\d{4}-\d{4}$/;
            if (!phoneRegex.test(phoneNumber)) {
                showStatus('ì „í™”ë²ˆí˜¸ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. (ì˜ˆ: 010-1234-5678)', 'error');
                return;
            }

            // í‡´ê·¼ API í˜¸ì¶œ
            await submitAttendance('check-out', phoneNumber);
        }

        // ====================================
        // ì¶œí‡´ê·¼ API í˜¸ì¶œ
        // ====================================

        // â”€â”€ GPS ìƒíƒœ í‘œì‹œ í—¬í¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function setGpsStatus(state, text) {
            const bar  = document.getElementById('gpsStatusBar');
            const icon = document.getElementById('gpsStatusIcon');
            const msg  = document.getElementById('gpsStatusText');
            const icons = {
                searching : 'ğŸ“¡',
                good      : 'âœ…',
                poor      : 'âš ï¸',
                failed    : 'âŒ',
                hidden    : '',
            };
            bar.className = `gps-status-bar ${state}`;
            icon.textContent = icons[state] || 'ğŸ“';
            msg.textContent  = text;
        }

        // â”€â”€ GPS ì·¨ë“ í•¨ìˆ˜ (ì •í™•ë„ ê²€ì¦ í¬í•¨) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì¦‰ì‹œ í˜¸ì¶œ â†’ ë²„íŠ¼ í´ë¦­ ì „ì— ë¯¸ë¦¬ ìœ„ì¹˜ í™•ë³´
        function fetchGpsLocation() {
            // GPS ë¯¸ì§€ì› ë¸Œë¼ìš°ì € (ë“œë¬¼ì§€ë§Œ ëŒ€ë¹„)
            if (!navigator.geolocation) {
                setGpsStatus('failed', 'GPSë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤. ëª¨ë°”ì¼ í¬ë¡¬ì„ ì‚¬ìš©í•´ì£¼ì„¸ìš”.');
                return;
            }

            setGpsStatus('searching', 'ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘... (ìµœì´ˆ 1íšŒ ê¶Œí•œ í—ˆìš© í•„ìš”)');

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const accuracy = position.coords.accuracy; // ì˜¤ì°¨ ë°˜ê²½(m)

                    if (accuracy <= 100) {
                        // âœ… ì •í™•ë„ 100m ì´ë‚´: ìš°ìˆ˜
                        currentLocation.latitude  = position.coords.latitude;
                        currentLocation.longitude = position.coords.longitude;
                        currentLocation.accuracy  = accuracy;
                        setGpsStatus('good', `ğŸ“ ìœ„ì¹˜ í™•ì¸ë¨ (ì˜¤ì°¨ Â±${Math.round(accuracy)}m)`);
                    } else if (accuracy <= 2000) {
                        // âš ï¸ ì •í™•ë„ 100~2000m: ì €ì •í™•ë„ â€” ìœ„ì¹˜ëŠ” ì „ì†¡, ì„œë²„ê°€ ë°˜ê²½ìœ¼ë¡œ íŒë‹¨
                        // ì‹¤ë‚´Â·ì§€í•˜Â·ì˜¤ë˜ëœ í°ì—ì„œ í”í•œ í˜„ìƒ (ì…€íƒ€ì›Œ/WiFi ê¸°ë°˜ ìœ„ì¹˜)
                        currentLocation.latitude  = position.coords.latitude;
                        currentLocation.longitude = position.coords.longitude;
                        currentLocation.accuracy  = accuracy;
                        setGpsStatus('poor',
                            `âš ï¸ GPS ì‹ í˜¸ ì•½í•¨ (ì˜¤ì°¨ Â±${Math.round(accuracy)}m) â€” ` +
                            'ì‹¤ì™¸Â·ì°½ê°€ì—ì„œ ë” ì •í™•í•©ë‹ˆë‹¤. ì„œë²„ ê²€ì¦ì€ ê³„ì† ì§„í–‰ë©ë‹ˆë‹¤.'
                        );
                    } else {
                        // âŒ 2000m ì´ˆê³¼: ì‚¬ì‹¤ìƒ ìœ„ì¹˜ ëª¨ë¦„ â†’ ë¯¸ì „ì†¡
                        currentLocation.latitude  = null;
                        currentLocation.longitude = null;
                        setGpsStatus('failed',
                            `GPS ì •í™•ë„ê°€ ë„ˆë¬´ ë‚®ìŠµë‹ˆë‹¤ (ì˜¤ì°¨ Â±${Math.round(accuracy)}m). ` +
                            'ì‹¤ì™¸ë¡œ ì´ë™í•˜ê±°ë‚˜ ëª¨ë°”ì¼ ë°ì´í„°ë¥¼ ì¼œê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.'
                        );
                    }
                },
                (error) => {
                    // GeolocationPositionError ì½”ë“œë³„ ì•ˆë‚´
                    const messages = {
                        1: 'ìœ„ì¹˜ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì£¼ì†Œì°½ ğŸ”’ â†’ ìœ„ì¹˜ â†’ í—ˆìš© í›„ ìƒˆë¡œê³ ì¹¨í•˜ì„¸ìš”.',
                        2: 'PC/ì‹¤ë‚´ì—ì„œëŠ” GPSë¥¼ ë°›ì§€ ëª»í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ëª¨ë°”ì¼ ê¸°ê¸°ë¡œ ì‹œë„í•´ì£¼ì„¸ìš”.',
                        3: 'GPS ì‹ í˜¸ ìˆ˜ì‹  ì‹œê°„ì´ ì´ˆê³¼ëìŠµë‹ˆë‹¤. ì°½ê°€ë¡œ ì´ë™ í›„ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.',
                    };
                    setGpsStatus('failed', messages[error.code] || `ìœ„ì¹˜ ì˜¤ë¥˜: ${error.message}`);
                    currentLocation.latitude  = null;
                    currentLocation.longitude = null;
                },
                {
                    enableHighAccuracy : true,   // ê³ ì •ë°€ ëª¨ë“œ (GPS ìš°ì„ )
                    timeout            : 15000,  // 15ì´ˆ ë‚´ ì‘ë‹µ ì—†ìœ¼ë©´ ì—ëŸ¬
                    maximumAge         : 30000,  // 30ì´ˆ ë‚´ ìºì‹œ ìœ„ì¹˜ ì¬ì‚¬ìš© í—ˆìš©
                }
            );
        }

        async function submitAttendance(type, phoneNumber) {
            try {
                // ë¡œë”© ìƒíƒœ í‘œì‹œ
                showLoading(true);
                hideStatus();

                // í˜„ì¬ ì‹œê° ìº¡ì²˜
                const now = new Date();

                /*
                 * API ì—”ë“œí¬ì¸íŠ¸ë¡œ POST ìš”ì²­
                 * ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” Netlify Functionsë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤
                 * 
                 * ì „ì†¡ ë°ì´í„°:
                 * - token: QRì½”ë“œì—ì„œ ë°›ì€ íšŒì‚¬ ì‹ë³„ í† í°
                 * - phoneNumber: ì§ì› ì „í™”ë²ˆí˜¸ (ì§ì› ì‹ë³„ìš©)
                 * - type: 'check-in' ë˜ëŠ” 'check-out'
                 * - timestamp: ì¶œí‡´ê·¼ ê¸°ë¡ ì‹œê°
                 * - location: GPS ì¢Œí‘œ (ì„ íƒì‚¬í•­)
                 */
                const response = await fetch('/.netlify/functions/attendance-checkin', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        token: attendanceToken,
                        phoneNumber: phoneNumber,
                        type: type,  // 'check-in' or 'check-out'
                        timestamp: now.toISOString(),
                        location: currentLocation.latitude ? {
                            latitude: currentLocation.latitude,
                            longitude: currentLocation.longitude
                        } : null
                    })
                });

                const data = await response.json();

                // ë¡œë”© ìƒíƒœ ìˆ¨ê¹€
                showLoading(false);

                if (data.success) {
                    // ì„±ê³µ ë©”ì‹œì§€
                    const actionName = type === 'check-in' ? 'ì¶œê·¼' : 'í‡´ê·¼';
                    const timeStr = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
                    
                    // WiFi ë°°ì§€
                    let wifiBadge = '';
                    if (data.wifiMatched === true) {
                        wifiBadge = '<div class="wifi-badge matched">âœ… WiFi ì¸ì¦ë¨</div>';
                    } else if (data.wifiMatched === false) {
                        wifiBadge = '<div class="wifi-badge unmatched">âš ï¸ WiFi ì™¸ë¶€ì ‘ì† (ê¸°ë¡ ì™„ë£Œ)</div>';
                    }

                    // GPS ë°°ì§€ (gpsMatched: null=ë¯¸ì‚¬ìš©, true=ë°˜ê²½ë‚´, false=ë°˜ê²½ì™¸)
                    let gpsBadge = '';
                    if (data.gpsMatched === true) {
                        const dist = data.gpsDistance ? ` (${data.gpsDistance}m)` : '';
                        gpsBadge = `<div class="gps-badge matched">ğŸ“ GPS ì¸ì¦ë¨${dist}</div>`;
                    } else if (data.gpsMatched === false) {
                        const dist = data.gpsDistance ? ` (${data.gpsDistance}m)` : '';
                        gpsBadge = `<div class="gps-badge unmatched">ğŸ“ GPS ë²”ìœ„ ì™¸${dist}</div>`;
                    }

                    // GPS ìƒíƒœ ë°” ìˆ¨ê¸°ê¸° (ì„±ê³µ í›„)
                    setGpsStatus('hidden', '');

                    showStatus(
                        `${actionName}ì´ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤. (${timeStr})${wifiBadge}${gpsBadge}`,
                        'success',
                        true  // HTML í—ˆìš©
                    );

                    // ì „í™”ë²ˆí˜¸ ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                    document.getElementById('phoneNumber').value = '';

                } else {
                    // ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
                    showStatus(data.error || `${type === 'check-in' ? 'ì¶œê·¼' : 'í‡´ê·¼'} ê¸°ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.`, 'error');
                }

            } catch (error) {
                console.error('ì¶œí‡´ê·¼ ê¸°ë¡ ì˜¤ë¥˜:', error);
                showLoading(false);
                showStatus('ì„œë²„ì™€ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'error');
            }
        }

        // ====================================
        // ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ
        // ====================================

        function showStatus(message, type = 'info', isHtml = false) {
            const statusEl = document.getElementById('statusMessage');
            if (isHtml) { statusEl.innerHTML = message; } else { statusEl.textContent = message; }
            statusEl.className = `status-message ${type} show`;

            // ì„±ê³µ ë©”ì‹œì§€ëŠ” 5ì´ˆ í›„ ìë™ìœ¼ë¡œ ìˆ¨ê¹€
            if (type === 'success') {
                setTimeout(() => {
                    statusEl.classList.remove('show');
                }, 5000);
            }
        }

        function hideStatus() {
            const statusEl = document.getElementById('statusMessage');
            statusEl.classList.remove('show');
        }

        // ====================================
        // ë¡œë”© ìƒíƒœ í‘œì‹œ
        // ====================================

        function showLoading(show) {
            const loadingEl = document.getElementById('loading');
            const formEl = document.getElementById('attendanceForm');
            
            if (show) {
                loadingEl.classList.add('show');
                formEl.style.display = 'none';
            } else {
                loadingEl.classList.remove('show');
                formEl.style.display = 'block';
            }
        }

        // ====================================
        // í¼ ë¹„í™œì„±í™”
        // ====================================

        function disableForm() {
            const buttons = document.querySelectorAll('.btn');
            buttons.forEach(btn => {
                btn.disabled = true;
            });
        }
    </script>
</body>
</html>
