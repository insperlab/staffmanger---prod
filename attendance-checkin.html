<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¶œí‡´ê·¼ ê¸°ë¡ - StaffManager</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        /* 
         * ë©”ì¸ ì»¨í…Œì´ë„ˆ
         * ëª¨ë°”ì¼ì—ì„œ ë³´ê¸° ì¢‹ë„ë¡ ìµœëŒ€ ë„ˆë¹„ë¥¼ ì œí•œí•˜ê³ 
         * ê·¸ë¦¼ì íš¨ê³¼ë¡œ ì…ì²´ê°ì„ ì¤ë‹ˆë‹¤
         */
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 450px;
            width: 100%;
            padding: 40px 30px;
        }

        /* ë¡œê³  ë° í—¤ë” */
        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .logo {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .company-name {
            font-size: 24px;
            font-weight: 700;
            color: #333;
            margin-bottom: 8px;
        }

        .page-subtitle {
            color: #999;
            font-size: 15px;
        }

        /* 
         * í˜„ì¬ ì‹œê° í‘œì‹œ
         * ì§ì›ì´ ì •í™•íˆ ëª‡ ì‹œì— ì°ì—ˆëŠ”ì§€ ë°”ë¡œ í™•ì¸í•  ìˆ˜ ìˆê²Œ
         * í° ê¸€ì”¨ë¡œ ëˆˆì— ì˜ ë„ê²Œ í‘œì‹œí•©ë‹ˆë‹¤
         */
        .current-time {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 30px;
            border: 2px solid #e0e0e0;
        }

        .time-label {
            font-size: 13px;
            color: #999;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .time-display {
            font-size: 36px;
            font-weight: 700;
            color: #667eea;
            font-variant-numeric: tabular-nums;
        }

        .date-display {
            font-size: 16px;
            color: #666;
            margin-top: 8px;
        }

        /* í¼ ìš”ì†Œ */
        .form-group {
            margin-bottom: 24px;
        }

        label {
            display: block;
            margin-bottom: 10px;
            color: #333;
            font-weight: 600;
            font-size: 15px;
        }

        /*
         * ì „í™”ë²ˆí˜¸ ì…ë ¥ í•„ë“œ
         * ëª¨ë°”ì¼ì—ì„œ ìˆ«ì í‚¤íŒ¨ë“œê°€ ìë™ìœ¼ë¡œ ë‚˜íƒ€ë‚˜ë„ë¡
         * type="tel"ì„ ì‚¬ìš©í•©ë‹ˆë‹¤
         * í„°ì¹˜í•˜ê¸° ì‰½ë„ë¡ paddingì„ ë„‰ë„‰í•˜ê²Œ ì¤ë‹ˆë‹¤
         */
        input[type="tel"] {
            width: 100%;
            padding: 16px 18px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 17px;
            transition: all 0.3s;
        }

        input[type="tel"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
        }

        input[type="tel"]::placeholder {
            color: #bbb;
        }

        /* 
         * ì¶œê·¼/í‡´ê·¼ ë²„íŠ¼
         * ì†ê°€ë½ìœ¼ë¡œ ì‰½ê²Œ ëˆ„ë¥¼ ìˆ˜ ìˆë„ë¡ ìµœì†Œ ë†’ì´ 56px ì´ìƒ
         * (iOS Human Interface Guidelines ê¶Œì¥ì‚¬í•­)
         */
        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 24px;
        }

        .btn {
            padding: 18px 24px;
            border: none;
            border-radius: 12px;
            font-size: 17px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-height: 60px;
        }

        .btn-check-in {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-check-in:active {
            transform: scale(0.98);
        }

        .btn-check-out {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
        }

        .btn-check-out:active {
            transform: scale(0.98);
            background: #f5f7fa;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* ìƒíƒœ ë©”ì‹œì§€ */
        .status-message {
            padding: 16px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
            text-align: center;
            font-size: 15px;
        }

        .status-message.show {
            display: block;
        }

        .status-message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-message.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        /* ë¡œë”© ìƒíƒœ */
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ì•ˆë‚´ ì •ë³´ */
        .info-box {
            background: #f8f9fa;
            padding: 16px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .info-box p {
            color: #666;
            font-size: 14px;
            line-height: 1.6;
            margin: 0;
        }

        /* í‘¸í„° */
        .footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }

        .footer p {
            color: #999;
            font-size: 13px;
        }

        /* ë°˜ì‘í˜•: ì‘ì€ í™”ë©´ì—ì„œëŠ” ë²„íŠ¼ì„ ì„¸ë¡œë¡œ ë°°ì¹˜ */
        @media (max-width: 400px) {
            .action-buttons {
                grid-template-columns: 1fr;
            }
        }
    
  /* WiFi ì¸ì¦ ë±ƒì§€ (M7) */
  .wifi-badge {
    display: inline-flex; align-items: center; gap: 5px;
    font-size: 12px; font-weight: 600; padding: 4px 10px;
    border-radius: 20px; margin-top: 8px;
  }
  .wifi-badge.matched  { background: #F0FDF4; color: #16A34A; border: 1px solid #BBF7D0; }
  .wifi-badge.unmatched{ background: #FFF7ED; color: #EA580C; border: 1px solid #FED7AA; }
  .wifi-badge.unused   { display: none; }

</style>
</head>
<body>
    <div class="container">
        <!-- í—¤ë” -->
        <div class="header">
            <div class="logo">ğŸ¯</div>
            <h1 class="company-name" id="companyName">StaffManager</h1>
            <p class="page-subtitle">ì¶œí‡´ê·¼ ê¸°ë¡ ì‹œìŠ¤í…œ</p>
        </div>

        <!-- í˜„ì¬ ì‹œê° í‘œì‹œ -->
        <div class="current-time">
            <div class="time-label">í˜„ì¬ ì‹œê°</div>
            <div class="time-display" id="currentTime">--:--</div>
            <div class="date-display" id="currentDate">----ë…„ --ì›” --ì¼</div>
        </div>

        <!-- ìƒíƒœ ë©”ì‹œì§€ -->
        <div id="statusMessage" class="status-message"></div>

        <!-- ë¡œë”© ìƒíƒœ -->
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p style="color: #666;">ì²˜ë¦¬ ì¤‘...</p>
        </div>

        <!-- ì¶œí‡´ê·¼ í¼ -->
        <div id="attendanceForm">
            <form id="checkInOutForm">
                <div class="form-group">
                    <label for="phoneNumber">íœ´ëŒ€ì „í™”ë²ˆí˜¸</label>
                    <input 
                        type="tel" 
                        id="phoneNumber" 
                        name="phoneNumber"
                        placeholder="010-1234-5678" 
                        required
                        autocomplete="tel"
                        pattern="[0-9]{3}-[0-9]{4}-[0-9]{4}"
                    >
                </div>

                <div class="action-buttons">
                    <button type="button" class="btn btn-check-in" onclick="handleCheckIn()">
                        <span>ğŸŒ…</span>
                        <span>ì¶œê·¼</span>
                    </button>
                    <button type="button" class="btn btn-check-out" onclick="handleCheckOut()">
                        <span>ğŸŒ†</span>
                        <span>í‡´ê·¼</span>
                    </button>
                </div>
            </form>

            <div class="info-box">
                <p>
                    ğŸ“± ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ê³  ì¶œê·¼ ë˜ëŠ” í‡´ê·¼ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”. 
                    ì¶œí‡´ê·¼ ê¸°ë¡ì€ ìë™ìœ¼ë¡œ ì €ì¥ë˜ë©°, ì¹´ì¹´ì˜¤í†¡ìœ¼ë¡œ í™•ì¸ ì•Œë¦¼ì„ ë°›ìœ¼ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </p>
            </div>
        </div>

        <!-- í‘¸í„° -->
        <div class="footer">
            <p>Powered by <strong>StaffManager</strong></p>
        </div>
    </div>

    <script>
        // ====================================
        // ì „ì—­ ë³€ìˆ˜
        // ====================================
        
        /*
         * URLì—ì„œ ë°›ì€ ì¶œí‡´ê·¼ í† í°
         * ì˜ˆ: https://staffmanager.io/attendance-checkin.html?token=ATT_abc123
         * ì´ í† í°ìœ¼ë¡œ ì–´ëŠ íšŒì‚¬ì˜ QRì½”ë“œì¸ì§€ ì‹ë³„í•©ë‹ˆë‹¤
         */
        let attendanceToken = null;
        let companyInfo = null;
        let currentLocation = { latitude: null, longitude: null };

        // ====================================
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
        // ====================================

        window.addEventListener('DOMContentLoaded', async () => {
            // URL íŒŒë¼ë¯¸í„°ì—ì„œ í† í° ì¶”ì¶œ
            const urlParams = new URLSearchParams(window.location.search);
            attendanceToken = urlParams.get('token');

            // í† í°ì´ ì—†ìœ¼ë©´ ì—ëŸ¬ í‘œì‹œ
            if (!attendanceToken) {
                showStatus('ìœ íš¨í•˜ì§€ ì•Šì€ QRì½”ë“œì…ë‹ˆë‹¤. ë‹¤ì‹œ ì´¬ì˜í•´ì£¼ì„¸ìš”.', 'error');
                disableForm();
                return;
            }

            // í˜„ì¬ ì‹œê° í‘œì‹œ ì‹œì‘
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);  // 1ì´ˆë§ˆë‹¤ ê°±ì‹ 

            // GPS ìœ„ì¹˜ ì •ë³´ ê°€ì ¸ì˜¤ê¸° (ë¹„ë™ê¸°, ì—ëŸ¬ ë¬´ì‹œ)
            try {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            currentLocation.latitude = position.coords.latitude;
                            currentLocation.longitude = position.coords.longitude;
                            console.log('ìœ„ì¹˜ ì •ë³´ íšë“ ì„±ê³µ:', currentLocation);
                        },
                        (error) => {
                            console.warn('ìœ„ì¹˜ ì •ë³´ íšë“ ì‹¤íŒ¨:', error.message);
                            // ìœ„ì¹˜ ì •ë³´ëŠ” ì„ íƒì‚¬í•­ì´ë¯€ë¡œ ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰
                        }
                    );
                }
            } catch (error) {
                console.warn('ìœ„ì¹˜ ì •ë³´ ì ‘ê·¼ ë¶ˆê°€:', error);
            }

            // ì „í™”ë²ˆí˜¸ ì…ë ¥ í•„ë“œì— ìë™ í¬ë§·íŒ… ì ìš©
            setupPhoneNumberFormatting();
        });

        // ====================================
        // í˜„ì¬ ì‹œê° ì—…ë°ì´íŠ¸
        // ====================================

        function updateCurrentTime() {
            const now = new Date();
            
            // ì‹œê° í‘œì‹œ (HH:MM:SS í˜•ì‹)
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            document.getElementById('currentTime').textContent = `${hours}:${minutes}:${seconds}`;

            // ë‚ ì§œ í‘œì‹œ
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const date = String(now.getDate()).padStart(2, '0');
            const dayNames = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
            const dayName = dayNames[now.getDay()];
            document.getElementById('currentDate').textContent = 
                `${year}ë…„ ${month}ì›” ${date}ì¼ (${dayName})`;
        }

        // ====================================
        // ì „í™”ë²ˆí˜¸ ìë™ í¬ë§·íŒ…
        // ====================================

        function setupPhoneNumberFormatting() {
            const phoneInput = document.getElementById('phoneNumber');
            
            phoneInput.addEventListener('input', (e) => {
                // ìˆ«ìë§Œ ì¶”ì¶œ
                let value = e.target.value.replace(/[^0-9]/g, '');
                
                // 11ìë¦¬ë¡œ ì œí•œ
                if (value.length > 11) {
                    value = value.slice(0, 11);
                }
                
                // ìë™ìœ¼ë¡œ í•˜ì´í”ˆ ì¶”ê°€
                // ì˜ˆ: 01012345678 â†’ 010-1234-5678
                if (value.length <= 3) {
                    e.target.value = value;
                } else if (value.length <= 7) {
                    e.target.value = `${value.slice(0, 3)}-${value.slice(3)}`;
                } else {
                    e.target.value = `${value.slice(0, 3)}-${value.slice(3, 7)}-${value.slice(7)}`;
                }
            });
        }

        // ====================================
        // ì¶œê·¼ ì²˜ë¦¬
        // ====================================

        async function handleCheckIn() {
            const phoneNumber = document.getElementById('phoneNumber').value.trim();
            
            // ì „í™”ë²ˆí˜¸ ìœ íš¨ì„± ê²€ì‚¬
            if (!phoneNumber) {
                showStatus('ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            // ì „í™”ë²ˆí˜¸ í˜•ì‹ ê²€ì¦ (010-1234-5678)
            const phoneRegex = /^010-\d{4}-\d{4}$/;
            if (!phoneRegex.test(phoneNumber)) {
                showStatus('ì „í™”ë²ˆí˜¸ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. (ì˜ˆ: 010-1234-5678)', 'error');
                return;
            }

            // ì¶œê·¼ API í˜¸ì¶œ
            await submitAttendance('check-in', phoneNumber);
        }

        // ====================================
        // í‡´ê·¼ ì²˜ë¦¬
        // ====================================

        async function handleCheckOut() {
            const phoneNumber = document.getElementById('phoneNumber').value.trim();
            
            // ì „í™”ë²ˆí˜¸ ìœ íš¨ì„± ê²€ì‚¬
            if (!phoneNumber) {
                showStatus('ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            // ì „í™”ë²ˆí˜¸ í˜•ì‹ ê²€ì¦
            const phoneRegex = /^010-\d{4}-\d{4}$/;
            if (!phoneRegex.test(phoneNumber)) {
                showStatus('ì „í™”ë²ˆí˜¸ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. (ì˜ˆ: 010-1234-5678)', 'error');
                return;
            }

            // í‡´ê·¼ API í˜¸ì¶œ
            await submitAttendance('check-out', phoneNumber);
        }

        // ====================================
        // ì¶œí‡´ê·¼ API í˜¸ì¶œ
        // ====================================

        async function submitAttendance(type, phoneNumber) {
            try {
                // ë¡œë”© ìƒíƒœ í‘œì‹œ
                showLoading(true);
                hideStatus();

                // í˜„ì¬ ì‹œê° ìº¡ì²˜
                const now = new Date();

                /*
                 * API ì—”ë“œí¬ì¸íŠ¸ë¡œ POST ìš”ì²­
                 * ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” Netlify Functionsë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤
                 * 
                 * ì „ì†¡ ë°ì´í„°:
                 * - token: QRì½”ë“œì—ì„œ ë°›ì€ íšŒì‚¬ ì‹ë³„ í† í°
                 * - phoneNumber: ì§ì› ì „í™”ë²ˆí˜¸ (ì§ì› ì‹ë³„ìš©)
                 * - type: 'check-in' ë˜ëŠ” 'check-out'
                 * - timestamp: ì¶œí‡´ê·¼ ê¸°ë¡ ì‹œê°
                 * - location: GPS ì¢Œí‘œ (ì„ íƒì‚¬í•­)
                 */
                const response = await fetch('/.netlify/functions/attendance-checkin', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        token: attendanceToken,
                        phoneNumber: phoneNumber,
                        type: type,  // 'check-in' or 'check-out'
                        timestamp: now.toISOString(),
                        location: currentLocation.latitude ? {
                            latitude: currentLocation.latitude,
                            longitude: currentLocation.longitude
                        } : null
                    })
                });

                const data = await response.json();

                // ë¡œë”© ìƒíƒœ ìˆ¨ê¹€
                showLoading(false);

                if (data.success) {
                    // ì„±ê³µ ë©”ì‹œì§€
                    const actionName = type === 'check-in' ? 'ì¶œê·¼' : 'í‡´ê·¼';
                    const timeStr = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
                    
                    // WiFi ë±ƒì§€ ìƒíƒœ ê²°ì •
                    let wifiBadge = '';
                    if (data.wifiMatched === true) {
                        wifiBadge = '<div class="wifi-badge matched">âœ… WiFi ì¸ì¦ë¨</div>';
                    } else if (data.wifiMatched === false) {
                        wifiBadge = '<div class="wifi-badge unmatched">âš ï¸ WiFi ë¯¸ì¸ì¦ (ê¸°ë¡ì€ ì™„ë£Œ)</div>';
                    }
                    showStatus(
                        `${actionName}ì´ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤. (${timeStr})${wifiBadge}`,
                        'success',
                        true  // HTML í—ˆìš©
                    );

                    // ì „í™”ë²ˆí˜¸ ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                    document.getElementById('phoneNumber').value = '';

                } else {
                    // ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
                    showStatus(data.error || `${type === 'check-in' ? 'ì¶œê·¼' : 'í‡´ê·¼'} ê¸°ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.`, 'error');
                }

            } catch (error) {
                console.error('ì¶œí‡´ê·¼ ê¸°ë¡ ì˜¤ë¥˜:', error);
                showLoading(false);
                showStatus('ì„œë²„ì™€ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'error');
            }
        }

        // ====================================
        // ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ
        // ====================================

        function showStatus(message, type = 'info', isHtml = false) {
            const statusEl = document.getElementById('statusMessage');
            if (isHtml) { statusEl.innerHTML = message; } else { statusEl.textContent = message; }
            statusEl.className = `status-message ${type} show`;

            // ì„±ê³µ ë©”ì‹œì§€ëŠ” 5ì´ˆ í›„ ìë™ìœ¼ë¡œ ìˆ¨ê¹€
            if (type === 'success') {
                setTimeout(() => {
                    statusEl.classList.remove('show');
                }, 5000);
            }
        }

        function hideStatus() {
            const statusEl = document.getElementById('statusMessage');
            statusEl.classList.remove('show');
        }

        // ====================================
        // ë¡œë”© ìƒíƒœ í‘œì‹œ
        // ====================================

        function showLoading(show) {
            const loadingEl = document.getElementById('loading');
            const formEl = document.getElementById('attendanceForm');
            
            if (show) {
                loadingEl.classList.add('show');
                formEl.style.display = 'none';
            } else {
                loadingEl.classList.remove('show');
                formEl.style.display = 'block';
            }
        }

        // ====================================
        // í¼ ë¹„í™œì„±í™”
        // ====================================

        function disableForm() {
            const buttons = document.querySelectorAll('.btn');
            buttons.forEach(btn => {
                btn.disabled = true;
            });
        }
    </script>
</body>
</html>
