<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì§ì› ì¼ê´„ ë“±ë¡ - StaffManager</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif; background: #f5f7fa; min-height: 100vh; }
        .navbar { background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); padding: 0 30px; height: 70px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
        .navbar-brand { display: flex; align-items: center; gap: 12px; font-size: 24px; font-weight: 700; color: #667eea; text-decoration: none; }
        .back-btn { padding: 8px 20px; background: #f5f7fa; border: none; border-radius: 6px; color: #666; cursor: pointer; font-weight: 600; text-decoration: none; display: inline-flex; align-items: center; gap: 8px; }
        .back-btn:hover { background: #e0e0e0; }
        .container { max-width: 1100px; margin: 0 auto; padding: 40px 30px; }
        .page-header { margin-bottom: 30px; }
        .page-title { font-size: 32px; color: #333; margin-bottom: 8px; }
        .page-subtitle { color: #999; font-size: 16px; }
        .card { background: white; border-radius: 12px; padding: 30px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 24px; }
        .card-title { font-size: 18px; font-weight: 600; color: #333; margin-bottom: 16px; }
        .steps { display: flex; gap: 20px; margin-bottom: 30px; }
        .step { flex: 1; text-align: center; padding: 16px; border-radius: 10px; background: #f5f7fa; position: relative; }
        .step.active { background: #667eea; color: white; }
        .step.done { background: #28a745; color: white; }
        .step-num { font-size: 24px; font-weight: 700; }
        .step-label { font-size: 13px; margin-top: 4px; }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.3s; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 16px rgba(102,126,234,0.3); }
        .btn-primary:disabled { background: #ccc; cursor: not-allowed; transform: none; }
        .btn-outline { background: white; color: #667eea; border: 2px solid #667eea; }
        .btn-outline:hover { background: #f0f2ff; }
        .btn-success { background: #28a745; color: white; }
        .btn-success:hover { background: #218838; }
        .btn-row { display: flex; gap: 12px; flex-wrap: wrap; }
        .upload-zone { border: 2px dashed #ccc; border-radius: 12px; padding: 40px; text-align: center; cursor: pointer; transition: all 0.3s; }
        .upload-zone:hover, .upload-zone.dragover { border-color: #667eea; background: #f0f2ff; }
        .upload-zone p { color: #666; margin-top: 10px; }
        .upload-zone .icon { font-size: 48px; }
        #fileInput { display: none; }
        .preview-table { width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 16px; }
        .preview-table th { background: #667eea; color: white; padding: 10px 8px; text-align: left; white-space: nowrap; }
        .preview-table td { padding: 8px; border-bottom: 1px solid #eee; }
        .preview-table tr:hover { background: #f8f9ff; }
        .preview-table .error-row { background: #fff5f5; }
        .preview-table .error-cell { color: #dc3545; font-weight: 600; }
        .preview-wrap { max-height: 400px; overflow: auto; border: 1px solid #eee; border-radius: 8px; }
        .result-box { padding: 20px; border-radius: 10px; margin-top: 16px; }
        .result-box.success { background: #d4edda; color: #155724; }
        .result-box.error { background: #f8d7da; color: #721c24; }
        .result-box .count { font-size: 32px; font-weight: 700; }
        .result-summary { display: flex; gap: 20px; margin-top: 16px; }
        .result-card { flex: 1; padding: 16px; border-radius: 10px; text-align: center; }
        .result-card.ok { background: #d4edda; }
        .result-card.fail { background: #f8d7da; }
        .toast { position: fixed; top: 90px; right: 30px; padding: 16px 24px; border-radius: 10px; color: white; font-weight: 600; z-index: 1000; transform: translateX(120%); transition: transform 0.3s; }
        .toast.show { transform: translateX(0); }
        .toast.success { background: #28a745; }
        .toast.error { background: #dc3545; }
        .hidden { display: none; }
        @media (max-width: 768px) { .container { padding: 20px 15px; } .steps { flex-direction: column; } .preview-table { font-size: 11px; } }
    </style>
</head>
<body>
    <nav class="navbar">
        <a href="/dashboard.html" class="navbar-brand"><span>ğŸ¯</span><span>StaffManager</span></a>
        <a href="/employees.html" class="back-btn"><span>â†</span><span>ì§ì› ëª©ë¡</span></a>
    </nav>
    <div class="toast" id="toast"></div>

    <div class="container">
        <div class="page-header">
            <h1 class="page-title">ğŸ“Š ì§ì› ì¼ê´„ ë“±ë¡</h1>
            <p class="page-subtitle">ì—‘ì…€ íŒŒì¼ë¡œ ì§ì›ì„ í•œ ë²ˆì— ë“±ë¡í•©ë‹ˆë‹¤</p>
        </div>

        <!-- ì§„í–‰ ë‹¨ê³„ -->
        <div class="steps">
            <div class="step active" id="step1"><div class="step-num">1</div><div class="step-label">í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ</div></div>
            <div class="step" id="step2"><div class="step-num">2</div><div class="step-label">íŒŒì¼ ì—…ë¡œë“œ</div></div>
            <div class="step" id="step3"><div class="step-num">3</div><div class="step-label">ë¯¸ë¦¬ë³´ê¸° í™•ì¸</div></div>
            <div class="step" id="step4"><div class="step-num">4</div><div class="step-label">ë“±ë¡ ì™„ë£Œ</div></div>
        </div>

        <!-- Step 1: í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ -->
        <div class="card" id="card1">
            <h3 class="card-title">ğŸ“¥ 1. ì—‘ì…€ í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ</h3>
            <p style="color:#666;margin-bottom:16px;">ì•„ë˜ í…œí”Œë¦¿ì„ ë‹¤ìš´ë¡œë“œí•˜ê³  ì§ì› ì •ë³´ë¥¼ ì…ë ¥í•œ í›„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.</p>
            <div class="btn-row">
                <button class="btn btn-primary" onclick="downloadTemplate()">ğŸ“„ í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ (.xlsx)</button>
            </div>
            <div style="margin-top:16px;padding:16px;background:#f0f2ff;border-radius:8px;font-size:14px;color:#555;">
                <strong>í•„ìˆ˜ í•­ëª©:</strong> ì´ë¦„, ì „í™”ë²ˆí˜¸, ì…ì‚¬ì¼, ê¸‰ì—¬ìœ í˜•, ê¸‰ì—¬ì•¡<br>
                <strong>ì„ íƒ í•­ëª©:</strong> ì´ë©”ì¼, ë¶€ì„œ, ì§ìœ„, ê·¼ë¬´ì‹œì‘/ì¢…ë£Œ, ì£¼ì†Œ, ìƒë…„ì›”ì¼, ì€í–‰, ê³„ì¢Œë²ˆí˜¸
            </div>
        </div>

        <!-- Step 2: íŒŒì¼ ì—…ë¡œë“œ -->
        <div class="card" id="card2">
            <h3 class="card-title">ğŸ“¤ 2. ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ</h3>
            <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
                <div class="icon">ğŸ“‚</div>
                <p><strong>í´ë¦­í•˜ê±°ë‚˜ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ì„¸ìš”</strong></p>
                <p style="font-size:13px;color:#999;">.xlsx, .xls íŒŒì¼ ì§€ì› (ìµœëŒ€ 100ëª…)</p>
            </div>
            <input type="file" id="fileInput" accept=".xlsx,.xls">
        </div>

        <!-- Step 3: ë¯¸ë¦¬ë³´ê¸° -->
        <div class="card hidden" id="card3">
            <h3 class="card-title">ğŸ‘€ 3. ë¯¸ë¦¬ë³´ê¸° â€” <span id="previewCount">0</span>ëª…</h3>
            <div class="preview-wrap">
                <table class="preview-table">
                    <thead><tr id="previewHead"></tr></thead>
                    <tbody id="previewBody"></tbody>
                </table>
            </div>
            <div class="btn-row" style="margin-top:20px;justify-content:flex-end;">
                <button class="btn btn-outline" onclick="resetUpload()">ë‹¤ì‹œ ì—…ë¡œë“œ</button>
                <button class="btn btn-success" id="submitBtn" onclick="submitImport()">âœ… ë“±ë¡í•˜ê¸°</button>
            </div>
        </div>

        <!-- Step 4: ê²°ê³¼ -->
        <div class="card hidden" id="card4">
            <h3 class="card-title">ğŸ“‹ 4. ë“±ë¡ ê²°ê³¼</h3>
            <div class="result-summary">
                <div class="result-card ok"><div class="count" id="okCount">0</div><div>ì„±ê³µ</div></div>
                <div class="result-card fail"><div class="count" id="failCount">0</div><div>ì‹¤íŒ¨</div></div>
            </div>
            <div id="failList" class="hidden" style="margin-top:16px;"></div>
            <div class="btn-row" style="margin-top:20px;">
                <button class="btn btn-outline" onclick="window.location.href='/employees.html'">ì§ì› ëª©ë¡ ë³´ê¸°</button>
                <button class="btn btn-primary" onclick="resetAll()">ì¶”ê°€ ë“±ë¡</button>
            </div>
        </div>
    </div>

    <script>
        const authToken = localStorage.getItem('authToken');
        if (!authToken) window.location.href = '/login.html';

        let parsedData = [];
        const HEADERS_KR = ['ì´ë¦„','ì „í™”ë²ˆí˜¸','ì´ë©”ì¼','ì…ì‚¬ì¼','ë¶€ì„œ','ì§ìœ„','ê¸‰ì—¬ìœ í˜•','ê¸‰ì—¬ì•¡','ê·¼ë¬´ì‹œì‘','ê·¼ë¬´ì¢…ë£Œ','ì£¼ì†Œ','ìƒë…„ì›”ì¼','ì€í–‰','ê³„ì¢Œë²ˆí˜¸'];
        const HEADERS_EN = ['name','phone','email','hireDate','department','position','salaryType','baseSalary','workStartTime','workEndTime','address','birthDate','bankName','accountNumber'];

        function showToast(msg, type='success') {
            const t = document.getElementById('toast');
            t.textContent = msg; t.className = 'toast show ' + type;
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        function setStep(n) {
            for (let i = 1; i <= 4; i++) {
                const el = document.getElementById('step'+i);
                el.className = 'step' + (i < n ? ' done' : i === n ? ' active' : '');
            }
        }

        // í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ
        function downloadTemplate() {
            const sample = [
                ['í™ê¸¸ë™','010-1234-5678','hong@email.com','2026-03-01','ì˜ì—…íŒ€','ëŒ€ë¦¬','ì›”ê¸‰','2500000','09:00','18:00','ì„œìš¸ì‹œ ê°•ë‚¨êµ¬','1995-06-15','ì¹´ì¹´ì˜¤ë±…í¬','3333012345678'],
                ['ê¹€ì˜í¬','010-5678-1234','','2026-03-01','ê°œë°œíŒ€','ì‚¬ì›','ì‹œê¸‰','12220','09:00','18:00','','1998-05-15','','']
            ];
            const ws = XLSX.utils.aoa_to_sheet([HEADERS_KR, ...sample]);
            // ì—´ ë„ˆë¹„ ì„¤ì •
            ws['!cols'] = HEADERS_KR.map(h => ({ wch: Math.max(h.length * 2, 12) }));
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'ì§ì›ëª©ë¡');
            XLSX.writeFile(wb, 'StaffManager_ì§ì›ë“±ë¡_í…œí”Œë¦¿.xlsx');
            showToast('í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ');
        }

        // íŒŒì¼ ì—…ë¡œë“œ í•¸ë“¤ëŸ¬
        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('fileInput');

        uploadZone.addEventListener('dragover', (e) => { e.preventDefault(); uploadZone.classList.add('dragover'); });
        uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('dragover'));
        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault(); uploadZone.classList.remove('dragover');
            if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
        });
        fileInput.addEventListener('change', (e) => { if (e.target.files.length) handleFile(e.target.files[0]); });

        function handleFile(file) {
            if (!file.name.match(/\.xlsx?$/i)) { showToast('ì—‘ì…€ íŒŒì¼(.xlsx)ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤', 'error'); return; }
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const wb = XLSX.read(e.target.result, { type: 'array' });
                    const ws = wb.Sheets[wb.SheetNames[0]];
                    const raw = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '' });

                    if (raw.length < 2) { showToast('ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤ (í—¤ë” + ìµœì†Œ 1í–‰)', 'error'); return; }

                    // í—¤ë” ë§¤í•‘
                    const headers = raw[0].map(h => String(h).trim());
                    const rows = raw.slice(1).filter(r => r.some(c => c !== ''));

                    if (rows.length > 100) { showToast('ìµœëŒ€ 100ëª…ê¹Œì§€ ê°€ëŠ¥í•©ë‹ˆë‹¤', 'error'); return; }

                    parsedData = rows.map(row => {
                        const obj = {};
                        headers.forEach((h, i) => {
                            const idx = HEADERS_KR.indexOf(h);
                            const key = idx >= 0 ? HEADERS_EN[idx] : h;
                            let val = row[i] !== undefined ? String(row[i]).trim() : '';
                            // ë‚ ì§œ ì²˜ë¦¬ (Excel serial â†’ YYYY-MM-DD)
                            if ((key === 'hireDate' || key === 'birthDate') && !isNaN(val) && val.length <= 5) {
                                const d = XLSX.SSF.parse_date_code(Number(val));
                                val = `${d.y}-${String(d.m).padStart(2,'0')}-${String(d.d).padStart(2,'0')}`;
                            }
                            obj[key] = val;
                        });
                        return obj;
                    });

                    showPreview(parsedData);
                } catch (err) {
                    showToast('íŒŒì¼ ì½ê¸° ì‹¤íŒ¨: ' + err.message, 'error');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function showPreview(data) {
            document.getElementById('card3').classList.remove('hidden');
            document.getElementById('previewCount').textContent = data.length;
            setStep(3);

            const head = document.getElementById('previewHead');
            const body = document.getElementById('previewBody');
            head.innerHTML = '<th>#</th>' + HEADERS_KR.map(h => `<th>${h}</th>`).join('');
            body.innerHTML = data.map((row, i) => {
                const errors = validateRow(row);
                const cls = errors.length ? 'error-row' : '';
                const cells = HEADERS_EN.map(key => {
                    const val = row[key] || '';
                    return `<td>${val}</td>`;
                }).join('');
                const errCell = errors.length ? `<td class="error-cell">${errors.join(', ')}</td>` : '';
                return `<tr class="${cls}"><td>${i+1}</td>${cells}${errCell}</tr>`;
            }).join('');
        }

        function validateRow(row) {
            const errors = [];
            if (!row.name || row.name.length < 2) errors.push('ì´ë¦„í•„ìˆ˜');
            if (!row.phone) errors.push('ì „í™”ë²ˆí˜¸í•„ìˆ˜');
            return errors;
        }

        function resetUpload() {
            parsedData = [];
            document.getElementById('card3').classList.add('hidden');
            document.getElementById('fileInput').value = '';
            setStep(2);
        }

        function resetAll() {
            parsedData = [];
            document.getElementById('card3').classList.add('hidden');
            document.getElementById('card4').classList.add('hidden');
            document.getElementById('fileInput').value = '';
            setStep(1);
        }

        // ì„œë²„ ì „ì†¡
        async function submitImport() {
            if (!parsedData.length) return;

            const btn = document.getElementById('submitBtn');
            btn.disabled = true; btn.textContent = 'ë“±ë¡ ì¤‘...';

            try {
                const res = await fetch('/.netlify/functions/employees-import', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + authToken, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ employees: parsedData })
                });
                const data = await res.json();

                if (data.success) {
                    document.getElementById('card3').classList.add('hidden');
                    document.getElementById('card4').classList.remove('hidden');
                    setStep(4);

                    document.getElementById('okCount').textContent = data.data.successCount;
                    document.getElementById('failCount').textContent = data.data.failedCount;

                    if (data.data.failed.length > 0) {
                        const fl = document.getElementById('failList');
                        fl.classList.remove('hidden');
                        fl.innerHTML = '<h4 style="margin-bottom:8px;">ì‹¤íŒ¨ ëª©ë¡:</h4>' +
                            data.data.failed.map(f => `<div style="padding:6px 0;border-bottom:1px solid #eee;">í–‰ ${f.row}: ${f.name || ''} â€” ${f.error}</div>`).join('');
                    }

                    showToast(data.data.message);
                } else {
                    showToast(data.error || 'ë“±ë¡ ì‹¤íŒ¨', 'error');
                }
            } catch (err) {
                showToast('ì„œë²„ í†µì‹  ì˜¤ë¥˜', 'error');
            }
            btn.disabled = false; btn.textContent = 'âœ… ë“±ë¡í•˜ê¸°';
        }
    </script>
</body>
</html>
