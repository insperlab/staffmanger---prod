<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì¶œí‡´ê·¼ ê´€ë¦¬ - StaffManager</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','Roboto','Noto Sans KR',sans-serif;background:#f5f7fa;min-height:100vh}
    .navbar{background:#fff;box-shadow:0 2px 4px rgba(0,0,0,.1);padding:0 30px;height:70px;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:100}
    .navbar-brand{display:flex;align-items:center;gap:12px;font-size:24px;font-weight:700;color:#667eea;text-decoration:none}
    .navbar-menu{display:flex;gap:30px;align-items:center}
    .navbar-menu a{text-decoration:none;color:#666;font-weight:500;transition:color .3s}
    .navbar-menu a:hover,.navbar-menu a.active{color:#667eea;font-weight:600}
    .user-menu{display:flex;align-items:center;gap:15px}
    .user-info{text-align:right}
    .user-name{font-weight:600;color:#333;font-size:14px}
    .company-name{font-size:12px;color:#999}
    .logout-btn{padding:8px 20px;background:#f5f7fa;border:none;border-radius:6px;color:#666;cursor:pointer;font-weight:600;transition:all .3s}
    .logout-btn:hover{background:#667eea;color:#fff}
    .container{max-width:1400px;margin:0 auto;padding:40px 30px}
    .page-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:30px;flex-wrap:wrap;gap:15px}
    .page-title{font-size:32px;color:#333;margin-bottom:8px}
    .page-subtitle{color:#999;font-size:16px}
    .stats-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:20px;margin-bottom:30px}
    .stat-card{background:#fff;padding:20px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.08)}
    .stat-label{font-size:13px;color:#999;margin-bottom:8px}
    .stat-value{font-size:28px;font-weight:700;color:#333}
    .controls{background:#fff;padding:20px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.08);margin-bottom:20px;display:flex;gap:15px;align-items:center;flex-wrap:wrap}
    .filter-select{padding:10px 16px;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;cursor:pointer;background:#fff}
    .filter-select:focus{outline:none;border-color:#667eea}
    .date-input{padding:10px 16px;border:2px solid #e0e0e0;border-radius:8px;font-size:14px}
    .date-input:focus{outline:none;border-color:#667eea}
    .btn-secondary{padding:10px 20px;background:#f5f7fa;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;transition:all .3s}
    .btn-secondary:hover{border-color:#667eea;color:#667eea}
    .table-container{background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.08);overflow:hidden}
    table{width:100%;border-collapse:collapse}
    thead{background:#f8f9fa}
    th{padding:16px 20px;text-align:left;font-weight:600;color:#333;font-size:14px;border-bottom:2px solid #e0e0e0;white-space:nowrap}
    tbody tr{border-bottom:1px solid #f0f0f0;transition:background .2s}
    tbody tr:hover{background:#f8f9fa}
    td{padding:14px 20px;color:#666;font-size:14px}
    .employee-name{font-weight:600;color:#333}
    .status-badge{display:inline-block;padding:4px 12px;border-radius:12px;font-size:12px;font-weight:600}
    .status-normal{background:#d4edda;color:#155724}
    .status-late{background:#fff3cd;color:#856404}
    .status-absent{background:#f8d7da;color:#721c24}
    .status-early_leave{background:#fce4ec;color:#880e4f}
    .biz-badge{display:inline-block;padding:3px 10px;border-radius:10px;font-size:12px;font-weight:500;background:#e8eaf6;color:#3949ab}
    .loading{text-align:center;padding:60px 20px}
    .spinner{border:4px solid #f3f3f3;border-top:4px solid #667eea;border-radius:50%;width:50px;height:50px;animation:spin 1s linear infinite;margin:0 auto 15px}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .empty-state{text-align:center;padding:80px 20px}
    .empty-state-icon{font-size:80px;margin-bottom:15px}
    .empty-state-text{font-size:18px;color:#999;margin-bottom:20px}
    .result-count{font-size:13px;color:#999;padding:8px 0}
    @media(max-width:768px){.navbar-menu{display:none}.controls{flex-direction:column}th,td{padding:12px 10px;font-size:13px}}
  </style>
</head>
<body>
<nav class="navbar">
  <a href="/dashboard.html" class="navbar-brand"><span>ğŸ‘‹</span><span>StaffManager</span></a>
  <div class="navbar-menu">
    <a href="/dashboard.html">ëŒ€ì‹œë³´ë“œ</a>
    <a href="/employees.html">ì§ì› ê´€ë¦¬</a>
    <a href="/attendances.html" class="active">ì¶œí‡´ê·¼ ê´€ë¦¬</a>
    <a href="/calendar.html">ë‹¬ë ¥ ê´€ë¦¬</a>
    <a href="/salary.html">ê¸‰ì—¬ ê´€ë¦¬</a>
    <a href="/contracts.html">ê³„ì•½ ê´€ë¦¬</a>
    <a href="/businesses.html">ì‚¬ì—…ì¥ ê´€ë¦¬</a>
    <a href="/settings.html">ì„¤ì •</a>
  </div>
  <div class="user-menu">
    <div class="user-info">
      <div class="user-name" id="userName">í™ê¸¸ë™</div>
      <div class="company-name" id="companyName">ì¸ìŠ¤í¼ë©</div>
    </div>
    <button class="logout-btn" onclick="handleLogout()">ë¡œê·¸ì•„ì›ƒ</button>
  </div>
</nav>

<div class="container">
  <div class="page-header">
    <div>
      <h1 class="page-title">ğŸ“… ì¶œí‡´ê·¼ ê´€ë¦¬</h1>
      <p class="page-subtitle">ì§ì›ë“¤ì˜ ì¶œí‡´ê·¼ ê¸°ë¡ì„ í™•ì¸í•˜ê³  ê´€ë¦¬í•©ë‹ˆë‹¤.</p>
    </div>
  </div>
  <div class="stats-row">
    <div class="stat-card"><div class="stat-label">ì´ ê¸°ë¡</div><div class="stat-value" id="statTotal">0</div></div>
    <div class="stat-card"><div class="stat-label">ê·¼ë¬´ ì‹œê°„</div><div class="stat-value" id="statHours">0h</div></div>
    <div class="stat-card"><div class="stat-label">ì§€ê° ìˆ˜</div><div class="stat-value" id="statLate">0</div></div>
    <div class="stat-card"><div class="stat-label">ì¡°í‡´ ìˆ˜</div><div class="stat-value" id="statEarlyLeave">0</div></div>
  </div>
  <div class="controls">
    <input type="date" class="date-input" id="startDate">
    <span style="color:#999">~</span>
    <input type="date" class="date-input" id="endDate">
    <!-- âœ… [ë³€ê²½1] ì‚¬ì—…ì¥ í•„í„° select â€” onchangeì— BusinessFilter.setSelected() ì—°ë™ -->
    <select class="filter-select" id="businessFilter" onchange="onBizSelectChange()">
      <option value="all">ì „ì²´ ì‚¬ì—…ì¥</option>
    </select>
    <select class="filter-select" id="departmentFilter" onchange="loadAttendances()">
      <option value="">ì „ì²´ ë¶€ì„œ</option>
    </select>
    <button class="btn-secondary" onclick="loadAttendances()">ğŸ” ì¡°íšŒ</button>
    <button class="btn-secondary" onclick="resetFilters()">ğŸ”„ í•„í„° ì´ˆê¸°í™”</button>
  </div>
  <div class="result-count" id="resultCount"></div>
  <div id="loadingState" class="table-container">
    <div class="loading"><div class="spinner"></div><p style="color:#999">ì¶œí‡´ê·¼ ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p></div>
  </div>
  <div id="attendanceTable" class="table-container" style="display:none">
    <table>
      <thead><tr><th>ê·¼ë¬´ì¼</th><th>ì§ì›ëª…</th><th>ì‚¬ì—…ì¥</th><th>ë¶€ì„œ</th><th>ì¶œê·¼ ì‹œê°„</th><th>í‡´ê·¼ ì‹œê°„</th><th>ê·¼ë¬´ ì‹œê°„</th><th>ì—°ì¥ ê·¼ë¬´</th><th>ìƒíƒœ</th></tr></thead>
      <tbody id="attendanceBody"></tbody>
    </table>
  </div>
  <div id="emptyState" class="table-container" style="display:none">
    <div class="empty-state"><div class="empty-state-icon">ğŸ“„</div><p class="empty-state-text">ì¶œí‡´ê·¼ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p></div>
  </div>
</div>

<!-- âœ… [ë³€ê²½2] business-filter.js ê³µí†µ ëª¨ë“ˆ ë¡œë“œ -->
<script src="/business-filter.js"></script>
<script>
  var authToken=null, userInfo=null, businessMap={};
  var today=new Date().toISOString().split('T')[0];
  var weekAgo=new Date(Date.now()-6*24*60*60*1000).toISOString().split('T')[0];

  window.addEventListener('DOMContentLoaded', async function(){
    authToken=localStorage.getItem('authToken');
    var ui=localStorage.getItem('userInfo');
    if(!authToken||!ui){window.location.href='/login.html';return}
    try{userInfo=JSON.parse(ui)}catch(e){window.location.href='/login.html';return}
    document.getElementById('userName').textContent=userInfo.name||'í™ê¸¸ë™';
    document.getElementById('companyName').textContent=userInfo.companyName||'';
    document.getElementById('startDate').value=weekAgo;
    document.getElementById('endDate').value=today;
    document.getElementById('startDate').addEventListener('change', loadAttendances);
    document.getElementById('endDate').addEventListener('change', loadAttendances);
    await loadBusinesses();
    await loadEmployeeDepartments();
    await loadAttendances();
  });

  /* âœ… [ë³€ê²½3] businesses-list ì‚¬ìš© + localStorage ë³µì› */
  async function loadBusinesses(){
    try{
      var r=await fetch('/.netlify/functions/businesses-list',{headers:{'Authorization':'Bearer '+authToken}});
      var res=await r.json();
      if(res.success && res.businesses){
        var sel=document.getElementById('businessFilter');
        res.businesses.forEach(function(b){
          businessMap[b.id]=b.name;
          var opt=document.createElement('option');
          opt.value=b.id;
          opt.textContent=b.name+(b.is_headquarters?' (ë³¸ì )':'');
          sel.appendChild(opt);
        });
        /* localStorageì—ì„œ ì´ì „ ì„ íƒê°’ ë³µì› (ë‹¤ë¥¸ í˜ì´ì§€ì—ì„œ ì„ íƒí•œ ì‚¬ì—…ì¥ ìœ ì§€) */
        var saved=BusinessFilter.getSelected();
        if(saved && saved!=='all'){sel.value=saved;}
      }
    }catch(e){console.error('ì‚¬ì—…ì¥ ë¡œë“œ ì‹¤íŒ¨:',e)}
  }

  /* âœ… [ë³€ê²½4] ì‚¬ì—…ì¥ ë³€ê²½ ì‹œ localStorageì— ì €ì¥ í›„ ë°ì´í„° ì¬ì¡°íšŒ */
  function onBizSelectChange(){
    var val=document.getElementById('businessFilter').value;
    BusinessFilter.setSelected(val);
    loadAttendances();
  }

  async function loadEmployeeDepartments(){
    try{
      var r=await fetch('/.netlify/functions/employees-list',{headers:{'Authorization':'Bearer '+authToken}});
      var res=await r.json();
      if(res.success && res.data && res.data.employees){
        var depts=[...new Set(res.data.employees.map(function(e){return e.department}).filter(Boolean))];
        var sel=document.getElementById('departmentFilter');
        depts.sort().forEach(function(dept){
          var opt=document.createElement('option');opt.value=dept;opt.textContent=dept;sel.appendChild(opt);
        });
      }
    }catch(e){console.error('ë¶€ì„œ ë¡œë“œ ì‹¤íŒ¨:',e)}
  }

  async function loadAttendances(){
    document.getElementById('loadingState').style.display='block';
    document.getElementById('attendanceTable').style.display='none';
    document.getElementById('emptyState').style.display='none';
    var startDate=document.getElementById('startDate').value;
    var endDate=document.getElementById('endDate').value;
    var businessId=document.getElementById('businessFilter').value;
    var department=document.getElementById('departmentFilter').value;
    var params=new URLSearchParams();
    if(startDate)params.append('startDate',startDate);
    if(endDate)params.append('endDate',endDate);
    /* 'all' ì´ ì•„ë‹ ë•Œë§Œ business_id íŒŒë¼ë¯¸í„° ì „ì†¡ */
    if(businessId && businessId!=='all')params.append('businessId',businessId);
    if(department)params.append('department',department);
    try{
      var response=await fetch('/.netlify/functions/attendances-list?'+params.toString(),{headers:{'Authorization':'Bearer '+authToken}});
      var data=await response.json();
      if(!data.success)throw new Error(data.error||'ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');
      var attendances=data.data.attendances||[];
      var stats=data.data.stats||{};
      document.getElementById('statTotal').textContent=stats.totalRecords||attendances.length;
      document.getElementById('statHours').textContent=(stats.totalWorkHours||0).toFixed(1)+'h';
      document.getElementById('statLate').textContent=stats.totalLateCount||0;
      document.getElementById('statEarlyLeave').textContent=stats.totalEarlyLeaveCount||0;
      document.getElementById('resultCount').textContent='ì´ ê²°ê³¼: '+attendances.length+'ê±´';
      document.getElementById('loadingState').style.display='none';
      if(attendances.length===0){document.getElementById('emptyState').style.display='block';return}
      var tbody=document.getElementById('attendanceBody');tbody.innerHTML='';
      attendances.forEach(function(record){
        var workDate=record.workDate||'-';
        var checkIn=record.checkInTime?formatTime(record.checkInTime):'-';
        var checkOut=record.checkOutTime?formatTime(record.checkOutTime):'-';
        var workHours=record.workHours?record.workHours.toFixed(1)+'h':'-';
        var overtimeHours=record.overtimeHours&&record.overtimeHours>0?'<span style="color:#e74c3c;font-weight:600">+'+record.overtimeHours.toFixed(1)+'h</span>':'-';
        var statusText='',statusClass='status-normal';
        switch(record.status){
          case 'normal':statusText='ì •ìƒ';statusClass='status-normal';break;
          case 'late':statusText='ì§€ê°';statusClass='status-late';break;
          case 'absent':statusText='ê²°ê·¼';statusClass='status-absent';break;
          case 'early_leave':statusText='ì¡°í‡´';statusClass='status-early_leave';break;
          default:statusText=record.status||'-';statusClass='status-normal';
        }
        var emp=record.employee||{};
        var bizName=emp.businessId?(businessMap[emp.businessId]||'ë¯¸ë°°ì •'):'ë¯¸ë°°ì •';
        var bizHtml=emp.businessId?'<span class="biz-badge">'+escapeHtml(bizName)+'</span>':'<span class="biz-badge" style="background:#fff3e0;color:#e65100">ë¯¸ë°°ì •</span>';
        var tr=document.createElement('tr');
        tr.innerHTML='<td>'+workDate+'</td><td class="employee-name">'+escapeHtml(emp.name||'-')+'</td><td>'+bizHtml+'</td><td>'+escapeHtml(emp.department||'-')+'</td><td>'+checkIn+'</td><td>'+checkOut+'</td><td>'+workHours+'</td><td>'+overtimeHours+'</td><td><span class="status-badge '+statusClass+'">'+statusText+'</span></td>';
        tbody.appendChild(tr);
      });
      document.getElementById('attendanceTable').style.display='block';
    }catch(e){
      console.error('ì¶œí‡´ê·¼ ê¸°ë¡ ë¡œë“œ ì‹¤íŒ¨:',e);
      document.getElementById('loadingState').style.display='none';
      document.getElementById('emptyState').style.display='block';
      document.getElementById('resultCount').textContent='ë¡œë“œ ì‹¤íŒ¨: '+e.message;
    }
  }

  function resetFilters(){
    document.getElementById('startDate').value=weekAgo;
    document.getElementById('endDate').value=today;
    document.getElementById('businessFilter').value='all';
    document.getElementById('departmentFilter').value='';
    BusinessFilter.setSelected('all'); /* ì „ì²´ ì´ˆê¸°í™” ì‹œ localStorageë„ ì´ˆê¸°í™” */
    loadAttendances();
  }

  function formatTime(isoStr){if(!isoStr)return'-';try{var d=new Date(isoStr);return String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0')}catch(e){return isoStr}}
  function escapeHtml(str){if(!str)return'';return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');}
  function handleLogout(){
    if(confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')){
      localStorage.removeItem('authToken');
      localStorage.removeItem('userInfo');
      localStorage.removeItem('sm_selected_business');
      sessionStorage.clear();
      window.location.href='/login.html';
    }
  }
</script>
</body>
</html>
