<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì¶œí‡´ê·¼ ê´€ë¦¬ - StaffManager</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','Roboto','Noto Sans KR',sans-serif;background:#f5f7fa;min-height:100vh}
    .navbar{background:#fff;box-shadow:0 2px 4px rgba(0,0,0,.1);padding:0 30px;height:70px;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:100}
    .navbar-brand{display:flex;align-items:center;gap:12px;font-size:24px;font-weight:700;color:#667eea;text-decoration:none}
    .navbar-menu{display:flex;gap:30px;align-items:center}
    .navbar-menu a{text-decoration:none;color:#666;font-weight:500;transition:color .3s}
    .navbar-menu a:hover,.navbar-menu a.active{color:#667eea;font-weight:600}
    .user-menu{display:flex;align-items:center;gap:15px}
    .user-info{text-align:right}
    .user-name{font-weight:600;color:#333;font-size:14px}
    .company-name{font-size:12px;color:#999}
    .logout-btn{padding:8px 20px;background:#f5f7fa;border:none;border-radius:6px;color:#666;cursor:pointer;font-weight:600;transition:all .3s}
    .logout-btn:hover{background:#667eea;color:#fff}
    .container{max-width:1400px;margin:0 auto;padding:40px 30px}
    .page-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:30px;flex-wrap:wrap;gap:15px}
    .page-title{font-size:32px;color:#333;margin-bottom:8px}
    .page-subtitle{color:#999;font-size:16px}
    .stats-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:20px;margin-bottom:30px}
    .stat-card{background:#fff;padding:20px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.08)}
    .stat-label{font-size:13px;color:#999;margin-bottom:8px}
    .stat-value{font-size:28px;font-weight:700;color:#333}
    .controls{background:#fff;padding:20px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.08);margin-bottom:20px;display:flex;gap:15px;align-items:center;flex-wrap:wrap}
    .filter-select{padding:10px 16px;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;cursor:pointer;background:#fff}
    .filter-select:focus{outline:none;border-color:#667eea}
    .date-input{padding:10px 16px;border:2px solid #e0e0e0;border-radius:8px;font-size:14px}
    .date-input:focus{outline:none;border-color:#667eea}
    .btn-secondary{padding:10px 20px;background:#f5f7fa;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;transition:all .3s}
    .btn-secondary:hover{border-color:#667eea;color:#667eea}
    .table-container{background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.08);overflow:hidden}
    table{width:100%;border-collapse:collapse}
    thead{background:#f8f9fa}
    th{padding:16px 20px;text-align:left;font-weight:600;color:#333;font-size:14px;border-bottom:2px solid #e0e0e0;white-space:nowrap}
    tbody tr{border-bottom:1px solid #f0f0f0;transition:background .2s}
    tbody tr:hover{background:#f8f9fa}
    td{padding:14px 20px;color:#666;font-size:14px}
    .employee-name{font-weight:600;color:#333}
    .status-badge{display:inline-block;padding:4px 12px;border-radius:12px;font-size:12px;font-weight:600}
    .status-normal{background:#d4edda;color:#155724}
    .status-late{background:#fff3cd;color:#856404}
    .status-absent{background:#f8d7da;color:#721c24}
    .status-early_leave{background:#fce4ec;color:#880e4f}
    .status-completed{background:#d4edda;color:#155724}
    .status-inprogress{background:#cce5ff;color:#004085}
    .status-night{background:#e8e0ff;color:#4527a0}
    .biz-badge{display:inline-block;padding:3px 10px;border-radius:10px;font-size:12px;font-weight:500;background:#e8eaf6;color:#3949ab}
    .loading{text-align:center;padding:60px 20px}
    .spinner{border:4px solid #f3f3f3;border-top:4px solid #667eea;border-radius:50%;width:50px;height:50px;animation:spin 1s linear infinite;margin:0 auto 15px}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .empty-state{text-align:center;padding:80px 20px}
    .empty-state-icon{font-size:80px;margin-bottom:15px}
    .empty-state-text{font-size:18px;color:#999;margin-bottom:20px}
    .result-count{font-size:13px;color:#999;padding:8px 0}
    @media(max-width:768px){.navbar-menu{display:none}.controls{flex-direction:column}th,td{padding:12px 10px;font-size:13px}}
  
    /* ì¶œí‡´ê·¼ ë°©ì‹ ë±ƒì§€ (M8) */
    .method-badge{display:inline-flex;align-items:center;gap:3px;padding:3px 9px;border-radius:10px;font-size:11px;font-weight:600}
    .method-badge.qr       {background:#EFF6FF;color:#1D4ED8}
    .method-badge.gps      {background:#F0FDF4;color:#15803D}
    .method-badge.wifi     {background:#FDF4FF;color:#7E22CE}
    .method-badge.gpswifi  {background:#FFF7ED;color:#C2410C}
    .method-badge.manual   {background:#F9FAFB;color:#6B7280;border:1px solid #E5E7EB}

    

    /* â”€â”€ ìˆ˜ë™ ë“±ë¡ ëª¨ë‹¬ â”€â”€ */
    .modal-backdrop{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:1000;align-items:center;justify-content:center}
    .modal-backdrop.show{display:flex}
    .modal{background:#fff;border-radius:16px;padding:28px 32px;width:100%;max-width:480px;box-shadow:0 20px 60px rgba(0,0,0,.2);position:relative}
    .modal-title{font-size:18px;font-weight:700;color:#1e293b;margin-bottom:20px}
    .modal-close{position:absolute;top:16px;right:20px;background:none;border:none;font-size:20px;cursor:pointer;color:#94a3b8}
    .modal-close:hover{color:#1e293b}
    .form-row{margin-bottom:14px}
    .form-row label{display:block;font-size:13px;font-weight:600;color:#475569;margin-bottom:5px}
    .form-row input,.form-row select,.form-row textarea{width:100%;padding:9px 12px;border:1.5px solid #e2e8f0;border-radius:8px;font-size:14px;color:#1e293b;box-sizing:border-box}
    .form-row input:focus,.form-row select:focus{outline:none;border-color:#6366f1}
    .form-row textarea{resize:vertical;min-height:60px}
    .form-row-half{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:14px}
    .modal-footer{display:flex;gap:10px;justify-content:flex-end;margin-top:20px}
    .btn-modal-cancel{padding:9px 20px;border:1.5px solid #e2e8f0;border-radius:8px;background:#fff;color:#64748b;font-size:14px;font-weight:600;cursor:pointer}
    .btn-modal-save{padding:9px 20px;border:none;border-radius:8px;background:#6366f1;color:#fff;font-size:14px;font-weight:600;cursor:pointer}
    .btn-modal-save:hover{background:#4f46e5}
    .btn-modal-delete{padding:9px 20px;border:none;border-radius:8px;background:#ef4444;color:#fff;font-size:14px;font-weight:600;cursor:pointer}
    .btn-modal-delete:hover{background:#dc2626}
    .btn-add-record{padding:8px 16px;background:#6366f1;color:#fff;border:none;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;white-space:nowrap}
    .btn-add-record:hover{background:#4f46e5}
    .row-edit-btn{background:none;border:1px solid #e2e8f0;border-radius:6px;padding:3px 8px;font-size:11px;color:#64748b;cursor:pointer;margin-left:4px}
    .row-edit-btn:hover{background:#f1f5f9;color:#1e293b}
</style>
</head>
<body>
<nav class="navbar">
  <a href="/dashboard.html" class="navbar-brand"><span>ğŸ‘‹</span><span>StaffManager</span></a>
  <div class="navbar-menu">
    <a href="/dashboard.html">ëŒ€ì‹œë³´ë“œ</a>
    <a href="/employees.html">ì§ì› ê´€ë¦¬</a>
    <a href="/attendances.html" class="active">ì¶œí‡´ê·¼ ê´€ë¦¬</a>
    <a href="/calendar.html">ë‹¬ë ¥ ê´€ë¦¬</a>
    <a href="/salary.html">ê¸‰ì—¬ ê´€ë¦¬</a>
    <a href="/contracts.html">ê³„ì•½ ê´€ë¦¬</a>
    <a href="/businesses.html">ì‚¬ì—…ì¥ ê´€ë¦¬</a>
    <a href="/settings.html">ì„¤ì •</a>
  </div>
  <div class="user-menu">
    <div class="user-info">
      <div class="user-name" id="userName">í™ê¸¸ë™</div>
      <div class="company-name" id="companyName">ì¸ìŠ¤í¼ë©</div>
    </div>
    <button class="logout-btn" onclick="handleLogout()">ë¡œê·¸ì•„ì›ƒ</button>
  </div>
</nav>

<div class="container">
  <div class="page-header">
    <div>
      <h1 class="page-title">ğŸ“… ì¶œí‡´ê·¼ ê´€ë¦¬</h1>
      <p class="page-subtitle">ì§ì›ë“¤ì˜ ì¶œí‡´ê·¼ ê¸°ë¡ì„ í™•ì¸í•˜ê³  ê´€ë¦¬í•©ë‹ˆë‹¤.</p>
    </div>
  </div>
  <div class="stats-row">
    <div class="stat-card"><div class="stat-label">ì´ ê¸°ë¡</div><div class="stat-value" id="statTotal">0</div></div>
    <div class="stat-card"><div class="stat-label">ê·¼ë¬´ ì‹œê°„</div><div class="stat-value" id="statHours">0h</div></div>
    <div class="stat-card"><div class="stat-label">ì§€ê° ìˆ˜</div><div class="stat-value" id="statLate">0</div></div>
    <div class="stat-card"><div class="stat-label">ì¡°í‡´ ìˆ˜</div><div class="stat-value" id="statEarlyLeave">0</div></div>
  </div>
  <div class="controls">
    <input type="date" class="date-input" id="startDate">
    <span style="color:#999">~</span>
    <input type="date" class="date-input" id="endDate">
    <!-- âœ… [ë³€ê²½1] ì‚¬ì—…ì¥ í•„í„° select â€” onchangeì— BusinessFilter.setSelected() ì—°ë™ -->
    <select class="filter-select" id="businessFilter" onchange="onBizSelectChange()">
      <option value="all">ì „ì²´ ì‚¬ì—…ì¥</option>
    </select>
    <select class="filter-select" id="departmentFilter" onchange="loadAttendances()">
      <option value="">ì „ì²´ ë¶€ì„œ</option>
    </select>
    <button class="btn-secondary" onclick="loadAttendances()">ğŸ” ì¡°íšŒ</button>
    <button class="btn-secondary" onclick="resetFilters()">ğŸ”„ í•„í„° ì´ˆê¸°í™”</button>
    <button class="btn-add-record" onclick="openAddModal()">âœï¸ ìˆ˜ë™ ë“±ë¡</button>
  </div>
  <div class="result-count" id="resultCount"></div>
  <div id="loadingState" class="table-container">
    <div class="loading"><div class="spinner"></div><p style="color:#999">ì¶œí‡´ê·¼ ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p></div>
  </div>
  <div id="attendanceTable" class="table-container" style="display:none">
    <table>
      <thead><tr><th>ê·¼ë¬´ì¼</th><th>ì§ì›ëª…</th><th>ì‚¬ì—…ì¥</th><th>ë¶€ì„œ</th><th>ì¶œê·¼ ì‹œê°„</th><th>í‡´ê·¼ ì‹œê°„</th><th>ê·¼ë¬´ ì‹œê°„</th><th>ì—°ì¥ ê·¼ë¬´</th><th>ì•¼ê°„</th><th>ë°©ì‹</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th></tr></thead>
      <tbody id="attendanceBody"></tbody>
    </table>
  </div>
  <div id="emptyState" class="table-container" style="display:none">
    <div class="empty-state"><div class="empty-state-icon">ğŸ“„</div><p class="empty-state-text">ì¶œí‡´ê·¼ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p></div>
  </div>
</div>

<!-- âœ… [ë³€ê²½2] business-filter.js ê³µí†µ ëª¨ë“ˆ ë¡œë“œ -->
<script src="/business-filter.js"></script>
<script>
  var authToken=null, userInfo=null, businessMap={};
  var today=new Date().toISOString().split('T')[0];
  var weekAgo=new Date(Date.now()-6*24*60*60*1000).toISOString().split('T')[0];

  window.addEventListener('DOMContentLoaded', async function(){
    authToken=localStorage.getItem('authToken');
    var ui=localStorage.getItem('userInfo');
    if(!authToken||!ui){window.location.href='/login.html';return}
    try{userInfo=JSON.parse(ui)}catch(e){window.location.href='/login.html';return}
    document.getElementById('userName').textContent=userInfo.name||'í™ê¸¸ë™';
    document.getElementById('companyName').textContent=userInfo.companyName||'';
    document.getElementById('startDate').value=weekAgo;
    document.getElementById('endDate').value=today;
    document.getElementById('startDate').addEventListener('change', loadAttendances);
    document.getElementById('endDate').addEventListener('change', loadAttendances);
    await loadBusinesses();
    await loadEmployeeDepartments();
    await loadAttendances();
  });

  /* âœ… [ë³€ê²½3] businesses-list ì‚¬ìš© + localStorage ë³µì› */
  async function loadBusinesses(){
    try{
      var r=await fetch('/.netlify/functions/businesses-list',{headers:{'Authorization':'Bearer '+authToken}});
      var res=await r.json();
      if(res.success && res.businesses){
        var sel=document.getElementById('businessFilter');
        res.businesses.forEach(function(b){
          businessMap[b.id]=b.name;
          var opt=document.createElement('option');
          opt.value=b.id;
          opt.textContent=b.name+(b.is_headquarters?' (ë³¸ì )':'');
          sel.appendChild(opt);
        });
        /* localStorageì—ì„œ ì´ì „ ì„ íƒê°’ ë³µì› (ë‹¤ë¥¸ í˜ì´ì§€ì—ì„œ ì„ íƒí•œ ì‚¬ì—…ì¥ ìœ ì§€) */
        var saved=BusinessFilter.getSelected();
        if(saved && saved!=='all'){sel.value=saved;}
      }
    }catch(e){console.error('ì‚¬ì—…ì¥ ë¡œë“œ ì‹¤íŒ¨:',e)}
  }

  /* âœ… [ë³€ê²½4] ì‚¬ì—…ì¥ ë³€ê²½ ì‹œ localStorageì— ì €ì¥ í›„ ë°ì´í„° ì¬ì¡°íšŒ */
  function onBizSelectChange(){
    var val=document.getElementById('businessFilter').value;
    BusinessFilter.setSelected(val);
    loadAttendances();
  }

  async function loadEmployeeDepartments(){
    try{
      var r=await fetch('/.netlify/functions/employees-list',{headers:{'Authorization':'Bearer '+authToken}});
      var res=await r.json();
      if(res.success && res.data && res.data.employees){
        var depts=[...new Set(res.data.employees.map(function(e){return e.department}).filter(Boolean))];
        var sel=document.getElementById('departmentFilter');
        depts.sort().forEach(function(dept){
          var opt=document.createElement('option');opt.value=dept;opt.textContent=dept;sel.appendChild(opt);
        });
      }
    }catch(e){console.error('ë¶€ì„œ ë¡œë“œ ì‹¤íŒ¨:',e)}
  }

  async function loadAttendances(){
    document.getElementById('loadingState').style.display='block';
    document.getElementById('attendanceTable').style.display='none';
    document.getElementById('emptyState').style.display='none';
    var startDate=document.getElementById('startDate').value;
    var endDate=document.getElementById('endDate').value;
    var businessId=document.getElementById('businessFilter').value;
    var department=document.getElementById('departmentFilter').value;
    var params=new URLSearchParams();
    if(startDate)params.append('startDate',startDate);
    if(endDate)params.append('endDate',endDate);
    /* 'all' ì´ ì•„ë‹ ë•Œë§Œ business_id íŒŒë¼ë¯¸í„° ì „ì†¡ */
    if(businessId && businessId!=='all')params.append('businessId',businessId);
    if(department)params.append('department',department);
    try{
      var response=await fetch('/.netlify/functions/attendances-list?'+params.toString(),{headers:{'Authorization':'Bearer '+authToken}});
      var data=await response.json();
      if(!data.success)throw new Error(data.error||'ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');
      var attendances=data.data.attendances||[];
      var stats=data.data.stats||{};
      document.getElementById('statTotal').textContent=stats.totalRecords||attendances.length;
      document.getElementById('statHours').textContent=(stats.totalWorkHours||0).toFixed(1)+'h';
      document.getElementById('statLate').textContent=stats.totalLateCount||0;
      document.getElementById('statEarlyLeave').textContent=stats.totalEarlyLeaveCount||0;
      document.getElementById('resultCount').textContent='ì´ ê²°ê³¼: '+attendances.length+'ê±´';
      document.getElementById('loadingState').style.display='none';
      if(attendances.length===0){document.getElementById('emptyState').style.display='block';return}
      var tbody=document.getElementById('attendanceBody');tbody.innerHTML='';
      attendances.forEach(function(record){
        var workDate=record.workDate||'-';
        var checkIn=record.checkInTime?formatTime(record.checkInTime):'-';
        var checkOut=record.checkOutTime?formatTime(record.checkOutTime):'-';
        var workHours=record.workHours?record.workHours.toFixed(1)+'h':'-';
        var overtimeHours=record.overtimeHours&&record.overtimeHours>0?'<span style="color:#e74c3c;font-weight:600">+'+record.overtimeHours.toFixed(1)+'h</span>':'-';
        var statusText='',statusClass='status-normal';
        switch(record.status){
          case 'normal':statusText='âœ… ì •ìƒ';statusClass='status-normal';break;
          case 'completed':statusText='âœ… í‡´ê·¼';statusClass='status-completed';break;
          case 'in_progress':statusText='ğŸŸ¢ ê·¼ë¬´ì¤‘';statusClass='status-inprogress';break;
          case 'late':statusText='âš ï¸ ì§€ê°';statusClass='status-late';break;
          case 'absent':statusText='âŒ ê²°ê·¼';statusClass='status-absent';break;
          case 'early_leave':statusText='ğŸ”¶ ì¡°í‡´';statusClass='status-early_leave';break;
          default:statusText=record.status||'ì •ìƒ';statusClass='status-normal';
        }
        var emp=record.employee||{};
        var bizName=emp.businessId?(businessMap[emp.businessId]||'ë¯¸ë°°ì •'):'ë¯¸ë°°ì •';
        var bizHtml=emp.businessId?'<span class="biz-badge">'+escapeHtml(bizName)+'</span>':'<span class="biz-badge" style="background:#fff3e0;color:#e65100">ë¯¸ë°°ì •</span>';
        var tr=document.createElement('tr');
        
        // ì¶œí‡´ê·¼ ë°©ì‹ ë±ƒì§€ ìƒì„±
        var method = record.checkMethod || 'qr';
        // gps+wifiëŠ” CSS í´ë˜ìŠ¤ëª…ì— '+' ì‚¬ìš© ë¶ˆê°€ â†’ 'gpswifi'ë¡œ ë³€í™˜
        var methodClass = method.replace('+', '');
        var methodLabel = {
          qr:       'ğŸ“± QR',
          gps:      'ğŸ“ GPS',
          wifi:     'ğŸ“¶ WiFi',
          'gps+wifi': 'ğŸ“ğŸ“¶ GPS+WiFi',
          manual:   'âœï¸ ìˆ˜ë™'
        }[method] || method.toUpperCase();
        var methodBadge = '<span class="method-badge '+methodClass+'">'+methodLabel+'</span>';

        // ì•¼ê°„ê·¼ë¡œ ì‹œê°„ í‘œì‹œ (DB ì €ì¥ê°’ ìš°ì„ , ì—†ìœ¼ë©´ ë‚ ì§œ ë¹„êµë¡œ íŒë³„)
        var nightHours = record.nightHours || 0;
        var nightBadge = '';
        if (nightHours > 0) {
          // DBì— ì €ì¥ëœ ì•¼ê°„ ì‹œê°„ í‘œì‹œ
          nightBadge = '<span style="display:inline-flex;align-items:center;gap:3px;padding:3px 8px;border-radius:10px;background:#ede7f6;color:#4527a0;font-size:11px;font-weight:600">ğŸŒ™ ' + nightHours.toFixed(1) + 'h</span>';
        } else if (record.checkInTime && record.checkOutTime) {
          // êµ¬í˜• ë°ì´í„°: ë‚ ì§œ ë¹„êµë¡œë§Œ íŒë³„
          var inDate  = record.checkInTime.slice(0,10);
          var outDate = record.checkOutTime.slice(0,10);
          if (inDate !== outDate) {
            nightBadge = '<span style="color:#9575cd;font-size:11px">ğŸŒ™ ì•¼ê°„</span>';
          }
        }
        
        // âœ… recordë¥¼ ì „ì—­ ìºì‹œì— ì €ì¥ í›„ IDë§Œ onclickì— ì „ë‹¬ (JSON í°ë”°ì˜´í‘œ ì¶©ëŒ ë°©ì§€)
        window._recordCache = window._recordCache || {};
        window._recordCache[record.id] = record;
        var editBtn='<button class="row-edit-btn" onclick="openEditModal(\'' + record.id + '\')">ìˆ˜ì •</button>';
        tr.innerHTML='<td>'+workDate+'</td><td class="employee-name">'+escapeHtml(emp.name||'-')+'</td><td>'+bizHtml+'</td><td>'+escapeHtml(emp.department||'-')+'</td><td>'+checkIn+'</td><td>'+checkOut+'</td><td>'+workHours+'</td><td>'+overtimeHours+'</td><td style="text-align:center">'+nightBadge+'</td><td>'+methodBadge+'</td><td><span class="status-badge '+statusClass+'">'+statusText+'</span></td><td>'+editBtn+'</td>';
        tbody.appendChild(tr);
      });
      document.getElementById('attendanceTable').style.display='block';
    }catch(e){
      console.error('ì¶œí‡´ê·¼ ê¸°ë¡ ë¡œë“œ ì‹¤íŒ¨:',e);
      document.getElementById('loadingState').style.display='none';
      document.getElementById('emptyState').style.display='block';
      document.getElementById('resultCount').textContent='ë¡œë“œ ì‹¤íŒ¨: '+e.message;
    }
  }

  function resetFilters(){
    document.getElementById('startDate').value=weekAgo;
    document.getElementById('endDate').value=today;
    document.getElementById('businessFilter').value='all';
    document.getElementById('departmentFilter').value='';
    BusinessFilter.setSelected('all'); /* ì „ì²´ ì´ˆê¸°í™” ì‹œ localStorageë„ ì´ˆê¸°í™” */
    loadAttendances();
  }

  function formatTime(isoStr){if(!isoStr)return'-';try{var d=new Date(isoStr);return String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0')}catch(e){return isoStr}}
  function escapeHtml(str){if(!str)return'';return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');}
  function handleLogout(){
    if(confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')){
      localStorage.removeItem('authToken');
      localStorage.removeItem('userInfo');
      localStorage.removeItem('sm_selected_business');
      sessionStorage.clear();
      window.location.href='/login.html';
    }
  }
</script>

  <script>
  // ====================================
  // ìˆ˜ë™ ì¶œí‡´ê·¼ ë“±ë¡/ìˆ˜ì • ëª¨ë‹¬ í•¨ìˆ˜
  // ====================================

  var modalMode = 'add';    // 'add' | 'edit'
  var editRecordId = null;  // ìˆ˜ì • ëª¨ë“œì¼ ë•Œ ê¸°ë¡ ID
  var allEmployees = [];    // ì§ì› ëª©ë¡ ìºì‹œ

  // ì§ì› ëª©ë¡ ë¡œë“œ (ìµœì´ˆ 1íšŒë§Œ)
  async function loadEmployeesForModal() {
    if (allEmployees.length > 0) return;
    try {
      var res = await fetch('/.netlify/functions/employees-list', {
        headers: { Authorization: 'Bearer ' + authToken }
      });
      var data = await res.json();
      allEmployees = (data.data?.employees || []).filter(function(e){ return e.status === 'active'; });
      var sel = document.getElementById('modalEmployee');
      allEmployees.forEach(function(e) {
        var opt = document.createElement('option');
        opt.value = e.id;
        opt.textContent = (e.name || '-') + (e.department ? ' Â· ' + e.department : '');
        sel.appendChild(opt);
      });
    } catch(e) { console.error('ì§ì› ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', e); }
  }

  // ì‹ ê·œ ë“±ë¡ ëª¨ë‹¬ ì—´ê¸°
  async function openAddModal() {
    modalMode = 'add';
    editRecordId = null;
    document.getElementById('modalTitle').textContent = 'âœï¸ ìˆ˜ë™ ì¶œí‡´ê·¼ ë“±ë¡';
    document.getElementById('employeeRow').style.display = 'block';
    document.getElementById('modalEmployee').value = '';
    document.getElementById('modalDate').value = new Date().toISOString().slice(0,10);
    document.getElementById('modalCheckIn').value = '';
    document.getElementById('modalCheckOut').value = '';
    document.getElementById('modalCheckOutDate').value = '';
    document.getElementById('checkOutDateRow').style.display = 'none';
    document.getElementById('modalNotes').value = '';
    document.getElementById('modalDeleteBtn').style.display = 'none';
    await loadEmployeesForModal();
    var m=document.getElementById('attendanceModal'); m.classList.add('show'); m.style.display='flex';
  }

  // ìˆ˜ì • ëª¨ë‹¬ ì—´ê¸° (í…Œì´ë¸” í–‰ì˜ ìˆ˜ì • ë²„íŠ¼ í´ë¦­ ì‹œ)
  function openEditModal(recordId) {
    var record = (window._recordCache || {})[recordId];
    if (!record) { alert('ê¸°ë¡ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.'); return; }
    modalMode = 'edit';
    editRecordId = record.id;
    document.getElementById('modalTitle').textContent = 'âœï¸ ì¶œí‡´ê·¼ ê¸°ë¡ ìˆ˜ì •';
    document.getElementById('employeeRow').style.display = 'none'; // ìˆ˜ì • ì‹œ ì§ì› ë³€ê²½ ë¶ˆê°€

    // ë‚ ì§œ ì¶”ì¶œ
    var dateStr = record.checkInTime ? record.checkInTime.slice(0,10) : '';
    document.getElementById('modalDate').value = dateStr;

    // HH:MM í˜•ì‹ìœ¼ë¡œ ì‹œê°„ íŒŒì‹±
    function toHHMM(iso) {
      if (!iso) return '';
      var d = new Date(iso);
      return String(d.getHours()).padStart(2,'0') + ':' + String(d.getMinutes()).padStart(2,'0');
    }
    document.getElementById('modalCheckIn').value  = toHHMM(record.checkInTime);
    document.getElementById('modalCheckOut').value = toHHMM(record.checkOutTime);

    // í‡´ê·¼ì¼ ì²˜ë¦¬: ì¶œê·¼ì¼ê³¼ ë‹¤ë¥´ë©´ checkOutDateRow í‘œì‹œ
    if (record.checkOutTime) {
      var checkOutDateStr = record.checkOutTime.slice(0,10);
      if (checkOutDateStr !== dateStr) {
        document.getElementById('modalCheckOutDate').value = checkOutDateStr;
        document.getElementById('checkOutDateRow').style.display = 'block';
      } else {
        document.getElementById('modalCheckOutDate').value = dateStr;
        document.getElementById('checkOutDateRow').style.display = 'none';
      }
    } else {
      document.getElementById('modalCheckOutDate').value = dateStr;
      document.getElementById('checkOutDateRow').style.display = 'none';
    }
    document.getElementById('modalNotes').value = record.notes || '';
    document.getElementById('modalDeleteBtn').style.display = 'block';
    var m=document.getElementById('attendanceModal'); m.classList.add('show'); m.style.display='flex';
  }

  // ëª¨ë‹¬ ë‹«ê¸°
  // í‡´ê·¼ ì‹œê°„ ì…ë ¥ ì‹œ í‡´ê·¼ì¼ í•„ë“œ í‘œì‹œ (ì•¼ê°„ê·¼ë¬´ ëŒ€ì‘)
  function handleCheckOutChange() {
    var checkOut = document.getElementById('modalCheckOut').value;
    var row = document.getElementById('checkOutDateRow');
    if (checkOut) {
      // í‡´ê·¼ì¼ ê¸°ë³¸ê°’: ì¶œê·¼ì¼ê³¼ ë™ì¼
      var workDate = document.getElementById('modalDate').value;
      if (!document.getElementById('modalCheckOutDate').value) {
        document.getElementById('modalCheckOutDate').value = workDate;
      }
      row.style.display = 'block';
    } else {
      row.style.display = 'none';
    }
  }

  function closeModal() {
    var modal = document.getElementById('attendanceModal');
    modal.classList.remove('show');
    modal.style.display = 'none'; // ì¸ë¼ì¸ styleë„ í•¨ê»˜ ì œê±°
    document.getElementById('checkOutDateRow').style.display = 'none';
  }

  // ì €ì¥ (ë“±ë¡ or ìˆ˜ì •)
  async function saveRecord() {
    var date     = document.getElementById('modalDate').value;
    var checkIn  = document.getElementById('modalCheckIn').value;
    var checkOut = document.getElementById('modalCheckOut').value;
    var notes    = document.getElementById('modalNotes').value;

    if (!date)    { alert('ê·¼ë¬´ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
    if (!checkIn) { alert('ì¶œê·¼ ì‹œê°„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
    // ì•¼ê°„ê·¼ë¬´ í—ˆìš©: ì‹œê°„ ë¬¸ìì—´ ë‹¨ìˆœ ë¹„êµ ì œê±° (APIì—ì„œ ë‚ ì§œ í¬í•¨ ê³„ì‚°)

    var saveBtn = document.querySelector('.btn-modal-save');
    saveBtn.textContent = 'ì €ì¥ ì¤‘...';
    saveBtn.disabled = true;

    try {
      var body, apiMethod;
      if (modalMode === 'add') {
        var empId = document.getElementById('modalEmployee').value;
        if (!empId) { alert('ì§ì›ì„ ì„ íƒí•´ì£¼ì„¸ìš”'); return; }
        var checkOutDate = document.getElementById('modalCheckOutDate').value || date;
        body = { employeeId: empId, workDate: date, checkInTime: checkIn, checkOutTime: checkOut || null, checkOutDate: checkOutDate, notes: notes };
        apiMethod = 'POST';
      } else {
        var checkOutDate = document.getElementById('modalCheckOutDate').value || date;
        body = { id: editRecordId, workDate: date, checkInTime: checkIn, checkOutTime: checkOut || null, checkOutDate: checkOutDate, notes: notes };
        apiMethod = 'PUT';
      }

      var res = await fetch('/.netlify/functions/attendances-manage', {
        method: apiMethod,
        headers: { 'Content-Type': 'application/json', Authorization: 'Bearer ' + authToken },
        body: JSON.stringify(body)
      });
      var data = await res.json();
      if (data.success) {
        closeModal();
        loadAttendances(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
      } else {
        alert(data.error || 'ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
      }
    } catch(e) {
      alert('ì˜¤ë¥˜: ' + e.message);
    } finally {
      saveBtn.textContent = 'ì €ì¥';
      saveBtn.disabled = false;
    }
  }

  // ì‚­ì œ
  async function deleteRecord() {
    if (!editRecordId) return;
    if (!confirm('ì´ ì¶œí‡´ê·¼ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì‚­ì œëœ ê¸°ë¡ì€ ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) return;
    try {
      var res = await fetch('/.netlify/functions/attendances-manage?id=' + editRecordId, {
        method: 'DELETE',
        headers: { Authorization: 'Bearer ' + authToken }
      });
      var data = await res.json();
      if (data.success) { closeModal(); loadAttendances(); }
      else alert(data.error || 'ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
    } catch(e) { alert('ì˜¤ë¥˜: ' + e.message); }
  }

  // ëª¨ë‹¬ ë°”ê¹¥ í´ë¦­ ì‹œ ë‹«ê¸°
  document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('attendanceModal').addEventListener('click', function(e) {
      if (e.target === this) closeModal();
    });
  });
  </script>

  <!-- â”€â”€ ìˆ˜ë™ ì¶œí‡´ê·¼ ë“±ë¡/ìˆ˜ì • ëª¨ë‹¬ â”€â”€ -->
  <div class="modal-backdrop" id="attendanceModal" style="display:none">
    <div class="modal">
      <button class="modal-close" onclick="closeModal()">âœ•</button>
      <div class="modal-title" id="modalTitle">âœï¸ ìˆ˜ë™ ì¶œí‡´ê·¼ ë“±ë¡</div>

      <div class="form-row" id="employeeRow">
        <label>ì§ì› <span style="color:#ef4444">*</span></label>
        <select id="modalEmployee">
          <option value="">ì§ì›ì„ ì„ íƒí•˜ì„¸ìš”</option>
        </select>
      </div>

      <div class="form-row">
        <label>ê·¼ë¬´ì¼ <span style="color:#ef4444">*</span></label>
        <input type="date" id="modalDate">
      </div>

      <div class="form-row-half">
        <div class="form-row" style="margin-bottom:0">
          <label>ì¶œê·¼ ì‹œê°„ <span style="color:#ef4444">*</span></label>
          <input type="time" id="modalCheckIn">
        </div>
        <div class="form-row" style="margin-bottom:0">
          <label>í‡´ê·¼ ì‹œê°„ <span style="color:#94a3b8">(ì—†ìœ¼ë©´ ê·¼ë¬´ì¤‘)</span></label>
          <input type="time" id="modalCheckOut" onchange="handleCheckOutChange()">
        </div>
      </div>

      <!-- ì•¼ê°„ê·¼ë¬´ ëŒ€ì‘: í‡´ê·¼ì¼ì´ ì¶œê·¼ì¼ê³¼ ë‹¤ë¥¼ ê²½ìš° ì„ íƒ -->
      <div class="form-row" id="checkOutDateRow" style="display:none">
        <label>í‡´ê·¼ì¼ <span style="color:#f59e0b">ğŸŒ™ ì•¼ê°„ê·¼ë¬´ ì ìš©ë¨</span></label>
        <input type="date" id="modalCheckOutDate">
        <small style="color:#94a3b8;margin-top:4px;display:block">ì¶œê·¼ì¼ê³¼ ë‹¤ë¥¸ ë‚  í‡´ê·¼ ì‹œ ìˆ˜ì •í•˜ì„¸ìš”</small>
      </div>

      <div class="form-row">
        <label>ë©”ëª¨</label>
        <textarea id="modalNotes" placeholder="ê´€ë¦¬ì ë©”ëª¨ (ì„ íƒ)"></textarea>
      </div>

      <div class="modal-footer">
        <button class="btn-modal-delete" id="modalDeleteBtn" onclick="deleteRecord()" style="display:none;margin-right:auto">ğŸ—‘ ì‚­ì œ</button>
        <button class="btn-modal-cancel" onclick="closeModal()">ì·¨ì†Œ</button>
        <button class="btn-modal-save" onclick="saveRecord()">ì €ì¥</button>
      </div>
    </div>
  </div>
</body>
</html>
