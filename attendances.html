<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì¶œí‡´ê·¼ ê´€ë¦¬</title>
</head>
<body>

<!-- í•„í„° ì„¹ì…˜ -->
<div class="filters">
    <div class="filter-group">
        <label>ì‚¬ì—…ì¥</label>
        <select id="businessFilter">
            <option value="">ì „ì²´ ì‚¬ì—…ì¥</option>
        </select>
    </div>
    <div class="filter-group">
        <label>ë¶€ì„œ</label>
        <select id="department">
            <option value="">ì „ì²´ ë¶€ì„œ</option>
        </select>
    </div>
</div>

<!-- ì¶œí‡´ê·¼ í…Œì´ë¸” -->
<table>
    <thead>
        <tr>
            <th>ë‚ ì§œ</th>
            <th>ì§ì›ëª…</th>
            <th>ì‚¬ì—…ì¥</th>
            <th>ë¶€ì„œ</th>
            <th>ì¶œê·¼ ì‹œê°</th>
            <th>í‡´ê·¼ ì‹œê°</th>
            <th>ê·¼ë¬´ ì‹œê°„</th>
            <th>ìƒíƒœ</th>
        </tr>
    </thead>
    <tbody id="attendanceBody">
    </tbody>
</table>

<script>
    let employeeMap = {};

    // ì‚¬ì—…ì¥ ëª©ë¡ ë¡œë“œ
    async function loadBusinesses() {
        try {
            const response = await fetch('/.netlify/functions/businesses-manage', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const result = await response.json();
            if (result.success && result.data) {
                const select = document.getElementById('businessFilter');
                // ë¯¸ë°°ì • ì˜µì…˜ ì¶”ê°€
                const unassignedOpt = document.createElement('option');
                unassignedOpt.value = 'unassigned';
                unassignedOpt.textContent = 'ë¯¸ë°°ì •';
                select.appendChild(unassignedOpt);
                // ì‚¬ì—…ì¥ ëª©ë¡ ì¶”ê°€
                result.data.forEach(biz => {
                    const option = document.createElement('option');
                    option.value = biz.id;
                    option.textContent = biz.name + (biz.is_headquarters ? ' (ë³¸ì‚¬)' : '');
                    select.appendChild(option);
                });
                return result.data;
            }
        } catch (error) {
            console.error('ì‚¬ì—…ì¥ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
        }
        return [];
    }

    // ë¶€ì„œ ëª©ë¡ ë° ì§ì› ë§µ ë¡œë“œ
    async function loadEmployeesAndDepartments(businesses) {
        try {
            const response = await fetch('/.netlify/functions/employees-list', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            const result = await response.json();

            if (result.success && result.data && result.data.employees) {
                // ì‚¬ì—…ì¥ ë§µ ìƒì„± (id  name)
                const bizMap = {};
                (businesses || []).forEach(b => { bizMap[b.id] = b.name; });

                // ì§ì› ë§µ ìƒì„± (id  employee info)
                result.data.employees.forEach(emp => {
                    employeeMap[emp.id] = {
                        name: emp.name || '-',
                        department: emp.department || '-',
                        position: emp.position || '-',
                        phone: emp.phone || '-',
                        businessName: emp.business_id ? (bizMap[emp.business_id] || '-') : 'ë¯¸ë°°ì •'
                    };
                });

                // ë¶€ì„œ ëª©ë¡ ë¡œë“œ
                const departments = [...new Set(result.data.employees.map(e => e.department).filter(Boolean))];
                const select = document.getElementById('department');
                
                departments.forEach(dept => {
                    const option = document.createElement('option');
                    option.value = dept;
                    option.textContent = dept;
                    select.appendChild(option);
                });
            }
        } catch (error) {
            console.error('ì§ì› ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
        }
    }

    function loadAttendances() {
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        const department = document.getElementById('department').value;
        const businessId = document.getElementById('businessFilter').value;

        let url = `/.netlify/functions/attendances-list?startDate=${startDate}&endDate=${endDate}`;
        if (businessId) {
            url += `&businessId=${encodeURIComponent(businessId)}`;
        }
        if (department) {
            url += `&department=${encodeURIComponent(department)}`;
        }

        fetch(url)
            .then(response => response.json())
            .then(data => {
                const tbody = document.getElementById('attendanceBody');
                tbody.innerHTML = '';
                data.forEach(record => {
                    const date = record.date || '-';
                    const checkIn = record.check_in || '-';
                    const checkOut = record.check_out || '-';
                    const workHours = record.work_hours || '-';
                    let badge = record.status || '-';

                    const empInfo = employeeMap[record.employee?.id] || record.employee || {};

                    tbody.innerHTML += `
                        <tr>
                            <td>${date}</td>
                            <td>${empInfo.name || '-'}</td>
                            <td>${empInfo.businessName || '-'}</td>
                            <td>${empInfo.department || '-'}</td>
                            <td>${checkIn}</td>
                            <td>${checkOut}</td>
                            <td>${workHours}</td>
                            <td>${badge}</td>
                        </tr>
                    `;
                });
            });
    }

    function resetFilters() {
        document.getElementById('startDate').value = weekAgo;
        document.getElementById('endDate').value = today;
        document.getElementById('businessFilter').value = '';
        document.getElementById('department').value = '';
        loadAttendances();
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
    loadBusinesses().then(businesses => loadEmployeesAndDepartments(businesses)).then(() => loadAttendances());
</script>

</body>
</html>
