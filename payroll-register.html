<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê¸‰ì—¬ ëŒ€ì¥ - StaffManager</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f0f2f5;
            min-height: 100vh;
        }
        .navbar {
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 0 30px;
            height: 70px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .navbar .logo { display:flex;align-items:center;gap:12px;font-size:24px;font-weight:700;color:#667eea; }
        .navbar .nav-links { display:flex;gap:30px;align-items:center; }
        .navbar .nav-links a { text-decoration:none;color:#666;font-weight:500;transition:color 0.2s; }
        .navbar .nav-links a:hover, .navbar .nav-links a.active { color:#667eea;font-weight:600; }
        .navbar .logout-btn { padding:8px 16px;background:#667eea;color:white;border:none;border-radius:6px;cursor:pointer;font-size:14px; }

        .page-container { max-width: 1400px; margin: 0 auto; padding: 30px 20px; }

        /* í—¤ë” */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        .page-header h1 { font-size: 28px; color: #333; }

        /* í•„í„° ë°” */
        .filter-bar {
            background: white;
            border-radius: 12px;
            padding: 20px 24px;
            display: flex;
            align-items: center;
            gap: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            margin-bottom: 24px;
            flex-wrap: wrap;
        }
        .filter-bar label { font-weight: 600; color: #555; font-size: 14px; white-space: nowrap; }
        .filter-bar select, .filter-bar input {
            padding: 10px 14px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 15px;
            background: white;
            min-width: 100px;
        }
        .filter-bar select:focus, .filter-bar input:focus { outline:none;border-color:#667eea; }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .btn:hover { transform: translateY(-1px); }
        .btn-primary { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
        .btn-primary:hover { box-shadow: 0 4px 15px rgba(102,126,234,0.4); }
        .btn-success { background: #4CAF50; color: white; }
        .btn-success:hover { box-shadow: 0 4px 15px rgba(76,175,80,0.4); }
        .btn-info { background: #2196F3; color: white; }
        .btn-info:hover { box-shadow: 0 4px 15px rgba(33,150,243,0.4); }
        .btn:disabled { opacity:0.5; cursor:not-allowed; transform:none !important; }

        /* ìš”ì•½ ì¹´ë“œ */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        .summary-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            text-align: center;
        }
        .summary-card .card-label { font-size: 13px; color: #888; margin-bottom: 8px; font-weight: 500; }
        .summary-card .card-value { font-size: 24px; font-weight: 700; }
        .summary-card.gross .card-value { color: #2196F3; }
        .summary-card.deduction .card-value { color: #f44336; }
        .summary-card.net .card-value { color: #4CAF50; }
        .summary-card.employer .card-value { color: #FF9800; }
        .summary-card.labor .card-value { color: #9C27B0; }
        .summary-card .card-count { font-size: 12px; color: #aaa; margin-top: 4px; }

        /* ê²½ê³  ë°°ë„ˆ */
        .warnings-banner {
            background: #fff3e0;
            border: 1px solid #ffcc02;
            border-radius: 10px;
            padding: 16px 20px;
            margin-bottom: 24px;
            display: none;
        }
        .warnings-banner.show { display: block; }
        .warnings-banner h4 { color: #e65100; margin-bottom: 10px; font-size: 15px; }
        .warning-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 0;
            font-size: 14px;
            color: #bf360c;
        }
        .warning-item.critical { color: #c62828; font-weight: 600; }
        .warning-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 700;
        }
        .warning-badge.critical { background: #ffcdd2; color: #c62828; }
        .warning-badge.warning { background: #fff9c4; color: #f57f17; }

        /* í…Œì´ë¸” */
        .table-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            overflow: hidden;
        }
        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 24px;
            border-bottom: 1px solid #eee;
        }
        .table-header h3 { font-size: 16px; color: #333; }
        .table-actions { display: flex; gap: 10px; }

        .table-scroll { overflow-x: auto; }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            min-width: 1200px;
        }
        thead th {
            background: #f8f9fa;
            padding: 12px 14px;
            text-align: right;
            font-weight: 600;
            color: #555;
            border-bottom: 2px solid #e0e0e0;
            white-space: nowrap;
            position: sticky;
            top: 0;
        }
        thead th:first-child, thead th:nth-child(2) { text-align: left; }
        tbody td {
            padding: 12px 14px;
            border-bottom: 1px solid #f0f0f0;
            text-align: right;
            color: #333;
            white-space: nowrap;
        }
        tbody td:first-child, tbody td:nth-child(2) { text-align: left; }
        tbody tr:hover { background: #f5f7ff; }
        tbody tr.has-warning { background: #fff8e1; }

        .emp-name { font-weight: 600; color: #333; }
        .salary-type-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }
        .salary-type-badge.hourly { background: #e3f2fd; color: #1565c0; }
        .salary-type-badge.daily { background: #f3e5f5; color: #7b1fa2; }
        .salary-type-badge.monthly { background: #e8f5e9; color: #2e7d32; }
        .salary-type-badge.annual { background: #fce4ec; color: #c62828; }

        .amount-positive { color: #2196F3; }
        .amount-negative { color: #f44336; }
        .amount-net { color: #4CAF50; font-weight: 700; }
        .warn-icon { cursor: help; }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }
        .empty-state .icon { font-size: 48px; margin-bottom: 16px; }
        .empty-state p { font-size: 16px; margin-bottom: 20px; }

        .loading-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.8);
            z-index: 999;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            gap: 16px;
        }
        .loading-overlay.show { display: flex; }
        .spinner {
            width: 48px; height: 48px;
            border: 4px solid #e0e0e0;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { font-size: 16px; color: #555; font-weight: 500; }

        @media (max-width: 768px) {
            .filter-bar { flex-direction: column; align-items: stretch; }
            .page-header { flex-direction: column; gap: 12px; align-items: flex-start; }
            .summary-cards { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <!-- ë„¤ë¹„ê²Œì´ì…˜ -->
    <nav class="navbar">
        <div class="logo"><span>ğŸ¯</span><span>StaffManager</span></div>
        <div class="nav-links">
            <a href="/dashboard">ëŒ€ì‹œë³´ë“œ</a>
            <a href="/employees">ì§ì› ê´€ë¦¬</a>
            <a href="/attendances">ì¶œí‡´ê·¼ ê´€ë¦¬</a>
            <a href="/calendar">íœ´ê°€ ê´€ë¦¬</a>
            <a href="/salary">ê¸‰ì—¬ ì¡°íšŒ</a>
            <a href="/payroll-register" class="active">ê¸‰ì—¬ ëŒ€ì¥</a>
            <a href="/contracts">ê³„ì•½ ê´€ë¦¬</a>
            <a href="/settings">ì„¤ì •</a>
        </div>
        <div><button class="logout-btn" onclick="handleLogout()">ë¡œê·¸ì•„ì›ƒ</button></div>
    </nav>

    <div class="page-container">
        <!-- í˜ì´ì§€ í—¤ë” -->
        <div class="page-header">
            <h1>ğŸ“Š ê¸‰ì—¬ ëŒ€ì¥</h1>
        </div>

        <!-- í•„í„° ë°” -->
        <div class="filter-bar">
            <label for="year">ë…„ë„</label>
            <input type="number" id="year" min="2020" max="2035">
            <label for="month">ì›”</label>
            <select id="month">
                <option value="1">1ì›”</option><option value="2">2ì›”</option>
                <option value="3">3ì›”</option><option value="4">4ì›”</option>
                <option value="5">5ì›”</option><option value="6">6ì›”</option>
                <option value="7">7ì›”</option><option value="8">8ì›”</option>
                <option value="9">9ì›”</option><option value="10">10ì›”</option>
                <option value="11">11ì›”</option><option value="12">12ì›”</option>
            </select>
            <button class="btn btn-primary" id="batchCalcBtn" onclick="batchCalculate()">
                ğŸ”„ ì¼ê´„ ê³„ì‚°
            </button>
            <button class="btn btn-info" id="loadBtn" onclick="loadPayrollData()">
                ğŸ“‹ ì¡°íšŒ
            </button>
            <div style="flex:1;"></div>
            <button class="btn btn-success" id="excelBtn" onclick="downloadExcel()" disabled>
                ğŸ“¥ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
            </button>
            <button class="btn" style="background:#FF9800;color:white;" id="bankBtn" onclick="downloadBankFile()" disabled>
                ğŸ¦ ì´ì²´íŒŒì¼
            </button>
        </div>

        <!-- ìš”ì•½ ì¹´ë“œ -->
        <div class="summary-cards" id="summaryCards" style="display:none;">
            <div class="summary-card gross">
                <div class="card-label">ì´ ì§€ê¸‰ì•¡</div>
                <div class="card-value" id="sumGross">-</div>
                <div class="card-count" id="sumCount">-</div>
            </div>
            <div class="summary-card deduction">
                <div class="card-label">ì´ ê³µì œì•¡</div>
                <div class="card-value" id="sumDeduction">-</div>
            </div>
            <div class="summary-card net">
                <div class="card-label">ì´ ì‹¤ìˆ˜ë ¹ì•¡</div>
                <div class="card-value" id="sumNet">-</div>
            </div>
            <div class="summary-card employer">
                <div class="card-label">ì‚¬ì—…ì£¼ ë¶€ë‹´</div>
                <div class="card-value" id="sumEmployer">-</div>
            </div>
            <div class="summary-card labor">
                <div class="card-label">ì´ ì¸ê±´ë¹„</div>
                <div class="card-value" id="sumLabor">-</div>
            </div>
        </div>

        <!-- ê²½ê³  ë°°ë„ˆ -->
        <div class="warnings-banner" id="warningsBanner">
            <h4>âš ï¸ ì´ìƒ íƒì§€ ê²½ê³ </h4>
            <div id="warningsList"></div>
        </div>

        <!-- ê¸‰ì—¬ í…Œì´ë¸” -->
        <div class="table-container">
            <div class="table-header">
                <h3 id="tableTitle">ê¸‰ì—¬ ë‚´ì—­</h3>
                <div class="table-actions" id="tableActions" style="display:none;">
                    <span style="font-size:13px;color:#999;" id="tableInfo"></span>
                </div>
            </div>
            <div class="table-scroll">
                <div id="tableBody">
                    <div class="empty-state">
                        <div class="icon">ğŸ“Š</div>
                        <p>ë…„ë„ì™€ ì›”ì„ ì„ íƒí•œ í›„ [ì¼ê´„ ê³„ì‚°] ë˜ëŠ” [ì¡°íšŒ]ë¥¼ í´ë¦­í•˜ì„¸ìš”.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <div class="loading-text" id="loadingText">ê¸‰ì—¬ë¥¼ ê³„ì‚°í•˜ê³  ìˆìŠµë‹ˆë‹¤...</div>
    </div>

    <script>
        // â”€â”€ ì „ì—­ ë³€ìˆ˜ â”€â”€
        let payrollResults = [];
        const authToken = localStorage.getItem('authToken');

        // â”€â”€ ì´ˆê¸°í™” â”€â”€
        window.addEventListener('DOMContentLoaded', () => {
            const now = new Date();
            document.getElementById('year').value = now.getFullYear();
            document.getElementById('month').value = now.getMonth() + 1;

            if (!authToken) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                window.location.href = '/login.html';
            }
        });

        // â”€â”€ ì¼ê´„ ê¸‰ì—¬ ê³„ì‚° â”€â”€
        async function batchCalculate() {
            const year = parseInt(document.getElementById('year').value);
            const month = parseInt(document.getElementById('month').value);

            if (!confirm(`${year}ë…„ ${month}ì›” ì „ ì§ì› ê¸‰ì—¬ë¥¼ ì¼ê´„ ê³„ì‚°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ë¯¸ ê³„ì‚°ëœ ì§ì›ì€ ê±´ë„ˆëœë‹ˆë‹¤.`)) return;

            showLoading(true, 'ì „ ì§ì› ê¸‰ì—¬ë¥¼ ê³„ì‚°í•˜ê³  ìˆìŠµë‹ˆë‹¤...');
            try {
                const res = await fetch('/.netlify/functions/calculate-payroll-batch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` },
                    body: JSON.stringify({ year, month })
                });

                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err.error || 'ì¼ê´„ ê³„ì‚° ì‹¤íŒ¨');
                }

                const data = await res.json();
                payrollResults = data.results || [];
                renderSummary(data.summary);
                renderWarnings(data.warnings || []);
                renderTable(payrollResults);

                const failMsg = data.errors?.length > 0 ? `\nì‹¤íŒ¨: ${data.errors.map(e => e.name).join(', ')}` : '';
                alert(`âœ… ì¼ê´„ ê³„ì‚° ì™„ë£Œ!\n\nê³„ì‚°: ${data.summary.calculated}ëª… / ì „ì²´: ${data.summary.totalEmployees}ëª…${failMsg}`);

            } catch (err) {
                console.error('ì¼ê´„ ê³„ì‚° ì˜¤ë¥˜:', err);
                alert('ì¼ê´„ ê³„ì‚° ì‹¤íŒ¨: ' + err.message);
            } finally {
                showLoading(false);
            }
        }

        // â”€â”€ ê¸°ì¡´ ê¸‰ì—¬ ë°ì´í„° ì¡°íšŒ â”€â”€
        async function loadPayrollData() {
            const year = parseInt(document.getElementById('year').value);
            const month = parseInt(document.getElementById('month').value);

            showLoading(true, 'ê¸‰ì—¬ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
            try {
                const res = await fetch(`/.netlify/functions/payroll-list?year=${year}&month=${month}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (!res.ok) {
                    // payroll-listê°€ ì—†ìœ¼ë©´ batchë¡œ ì¡°íšŒ ì‹œë„
                    throw new Error('ì¡°íšŒ ì‹¤íŒ¨');
                }

                const data = await res.json();
                payrollResults = data.data || [];

                if (payrollResults.length === 0) {
                    document.getElementById('tableBody').innerHTML = `
                        <div class="empty-state">
                            <div class="icon">ğŸ“­</div>
                            <p>${year}ë…„ ${month}ì›” ê¸‰ì—¬ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                            <button class="btn btn-primary" onclick="batchCalculate()">ğŸ”„ ì¼ê´„ ê³„ì‚°í•˜ê¸°</button>
                        </div>
                    `;
                    document.getElementById('summaryCards').style.display = 'none';
                    return;
                }

                // ìš”ì•½ ê³„ì‚°
                const summary = {
                    totalEmployees: payrollResults.length,
                    calculated: payrollResults.length,
                    totalGrossPayment: payrollResults.reduce((s, r) => s + (r.total_payment || 0), 0),
                    totalDeductions: payrollResults.reduce((s, r) => s + (r.total_deductions || 0), 0),
                    totalNetPayment: payrollResults.reduce((s, r) => s + (r.net_payment || 0), 0),
                    totalEmployerCost: payrollResults.reduce((s, r) => s +
                        (r.employer_national_pension || 0) + (r.employer_health_insurance || 0) +
                        (r.employer_long_term_care || 0) + (r.employer_employment_insurance || 0), 0),
                };
                summary.totalLaborCost = summary.totalGrossPayment + summary.totalEmployerCost;

                renderSummary(summary);
                renderWarnings(payrollResults.filter(r => r.warnings?.length).map(r => ({
                    employee: r.employee_name || r.employee_id,
                    warnings: r.warnings
                })));
                renderTable(payrollResults);

            } catch (err) {
                // payroll-list APIê°€ ì—†ìœ¼ë©´ ì•ˆë‚´
                document.getElementById('tableBody').innerHTML = `
                    <div class="empty-state">
                        <div class="icon">ğŸ’¡</div>
                        <p>ë¨¼ì € [ì¼ê´„ ê³„ì‚°]ì„ ì‹¤í–‰í•˜ì„¸ìš”.</p>
                        <button class="btn btn-primary" onclick="batchCalculate()">ğŸ”„ ì¼ê´„ ê³„ì‚°í•˜ê¸°</button>
                    </div>
                `;
            } finally {
                showLoading(false);
            }
        }

        // â”€â”€ ìš”ì•½ ì¹´ë“œ ë Œë”ë§ â”€â”€
        function renderSummary(summary) {
            if (!summary) return;
            document.getElementById('summaryCards').style.display = 'grid';
            document.getElementById('sumGross').textContent = formatWon(summary.totalGrossPayment);
            document.getElementById('sumDeduction').textContent = formatWon(summary.totalDeductions);
            document.getElementById('sumNet').textContent = formatWon(summary.totalNetPayment);
            document.getElementById('sumEmployer').textContent = formatWon(summary.totalEmployerCost);
            document.getElementById('sumLabor').textContent = formatWon(summary.totalGrossPayment + summary.totalEmployerCost);
            document.getElementById('sumCount').textContent = `${summary.calculated}ëª… ê³„ì‚° ì™„ë£Œ`;
        }

        // â”€â”€ ê²½ê³  ë°°ë„ˆ ë Œë”ë§ â”€â”€
        function renderWarnings(warnings) {
            const banner = document.getElementById('warningsBanner');
            const list = document.getElementById('warningsList');
            if (!warnings || warnings.length === 0) {
                banner.classList.remove('show');
                return;
            }
            banner.classList.add('show');
            list.innerHTML = warnings.map(w => {
                const items = (w.warnings || []).map(warn => `
                    <div class="warning-item ${warn.severity}">
                        <span class="warning-badge ${warn.severity}">${warn.severity === 'critical' ? 'ğŸš¨ ì‹¬ê°' : 'âš ï¸ ì£¼ì˜'}</span>
                        <strong>${w.employee}</strong> - ${warn.message}
                    </div>
                `).join('');
                return items;
            }).join('');
        }

        // â”€â”€ í…Œì´ë¸” ë Œë”ë§ â”€â”€
        function renderTable(results) {
            if (!results || results.length === 0) {
                document.getElementById('tableBody').innerHTML = `
                    <div class="empty-state"><div class="icon">ğŸ“­</div><p>ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p></div>
                `;
                return;
            }

            document.getElementById('excelBtn').disabled = false;
            document.getElementById('bankBtn').disabled = false;
            document.getElementById('tableActions').style.display = 'flex';
            document.getElementById('tableInfo').textContent = `${results.length}ëª…`;

            const year = document.getElementById('year').value;
            const month = document.getElementById('month').value;
            document.getElementById('tableTitle').textContent = `${year}ë…„ ${month}ì›” ê¸‰ì—¬ ë‚´ì—­`;

            const typeLabel = { hourly: 'ì‹œê¸‰', daily: 'ì¼ê¸‰', monthly: 'ì›”ê¸‰', annual: 'ì—°ë´‰' };

            let html = `
                <table id="payrollTable">
                    <thead>
                        <tr>
                            <th style="text-align:center;width:40px;">âš </th>
                            <th>ì§ì›ëª…</th>
                            <th>ìœ í˜•</th>
                            <th>ê·¼ë¬´ì¼</th>
                            <th>ê¸°ë³¸ê¸‰</th>
                            <th>ì£¼íœ´ìˆ˜ë‹¹</th>
                            <th>ì—°ì¥ìˆ˜ë‹¹</th>
                            <th>ë¹„ê³¼ì„¸</th>
                            <th>ì´ ì§€ê¸‰ì•¡</th>
                            <th>êµ­ë¯¼ì—°ê¸ˆ</th>
                            <th>ê±´ê°•ë³´í—˜</th>
                            <th>ê³ ìš©ë³´í—˜</th>
                            <th>ì†Œë“ì„¸</th>
                            <th>ì´ ê³µì œì•¡</th>
                            <th>ì‹¤ìˆ˜ë ¹ì•¡</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            results.forEach(r => {
                const hasWarn = r.warnings && r.warnings.length > 0;
                const warnTitle = hasWarn ? r.warnings.map(w => w.message).join('\n') : '';
                const st = r.salary_type || 'monthly';
                html += `
                    <tr class="${hasWarn ? 'has-warning' : ''}">
                        <td style="text-align:center;">${hasWarn ? `<span class="warn-icon" title="${warnTitle}">ğŸš¨</span>` : ''}</td>
                        <td><span class="emp-name">${r.employee_name || '-'}</span></td>
                        <td><span class="salary-type-badge ${st}">${typeLabel[st] || st}</span></td>
                        <td>${r.total_work_days || 0}ì¼</td>
                        <td>${formatNum(r.basic_pay)}</td>
                        <td>${formatNum(r.weekly_holiday_pay)}</td>
                        <td>${formatNum((r.overtime_pay || 0) + (r.night_work_pay || 0) + (r.holiday_work_pay || 0))}</td>
                        <td>${formatNum(r.non_taxable_amount || 0)}</td>
                        <td class="amount-positive">${formatNum(r.total_payment)}</td>
                        <td>${formatNum(r.national_pension)}</td>
                        <td>${formatNum((r.health_insurance || 0) + (r.long_term_care || 0))}</td>
                        <td>${formatNum(r.employment_insurance)}</td>
                        <td>${formatNum((r.income_tax || 0) + (r.local_income_tax || 0))}</td>
                        <td class="amount-negative">${formatNum(r.total_deductions)}</td>
                        <td class="amount-net">${formatNum(r.net_payment)}</td>
                    </tr>
                `;
            });

            // í•©ê³„í–‰
            const totals = results.reduce((acc, r) => {
                acc.basic += r.basic_pay || 0;
                acc.weekly += r.weekly_holiday_pay || 0;
                acc.extra += (r.overtime_pay || 0) + (r.night_work_pay || 0) + (r.holiday_work_pay || 0);
                acc.nonTax += r.non_taxable_amount || 0;
                acc.gross += r.total_payment || 0;
                acc.pension += r.national_pension || 0;
                acc.health += (r.health_insurance || 0) + (r.long_term_care || 0);
                acc.employ += r.employment_insurance || 0;
                acc.tax += (r.income_tax || 0) + (r.local_income_tax || 0);
                acc.ded += r.total_deductions || 0;
                acc.net += r.net_payment || 0;
                return acc;
            }, { basic:0, weekly:0, extra:0, nonTax:0, gross:0, pension:0, health:0, employ:0, tax:0, ded:0, net:0 });

            html += `
                    <tr style="background:#f0f2ff;font-weight:700;">
                        <td></td>
                        <td>í•©ê³„</td>
                        <td></td>
                        <td></td>
                        <td>${formatNum(totals.basic)}</td>
                        <td>${formatNum(totals.weekly)}</td>
                        <td>${formatNum(totals.extra)}</td>
                        <td>${formatNum(totals.nonTax)}</td>
                        <td class="amount-positive">${formatNum(totals.gross)}</td>
                        <td>${formatNum(totals.pension)}</td>
                        <td>${formatNum(totals.health)}</td>
                        <td>${formatNum(totals.employ)}</td>
                        <td>${formatNum(totals.tax)}</td>
                        <td class="amount-negative">${formatNum(totals.ded)}</td>
                        <td class="amount-net">${formatNum(totals.net)}</td>
                    </tr>
                </tbody></table>
            `;

            document.getElementById('tableBody').innerHTML = html;
        }

        // â”€â”€ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ â”€â”€
        function downloadExcel() {
            if (!payrollResults.length) return alert('ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
            const year = document.getElementById('year').value;
            const month = document.getElementById('month').value;

            const rows = payrollResults.map(r => ({
                'ì§ì›ëª…': r.employee_name || '',
                'ê¸‰ì—¬ìœ í˜•': r.salary_type || '',
                'ê·¼ë¬´ì¼ìˆ˜': r.total_work_days || 0,
                'ê·¼ë¬´ì‹œê°„': r.total_work_hours || 0,
                'ê¸°ë³¸ê¸‰': r.basic_pay || 0,
                'ì£¼íœ´ìˆ˜ë‹¹': r.weekly_holiday_pay || 0,
                'ì—°ì¥ìˆ˜ë‹¹': r.overtime_pay || 0,
                'ì•¼ê°„ìˆ˜ë‹¹': r.night_work_pay || 0,
                'íœ´ì¼ìˆ˜ë‹¹': r.holiday_work_pay || 0,
                'ì‹ëŒ€(ë¹„ê³¼ì„¸)': r.meal_allowance || 0,
                'ì°¨ëŸ‰(ë¹„ê³¼ì„¸)': r.car_allowance || 0,
                'ë³´ìœ¡(ë¹„ê³¼ì„¸)': r.childcare_allowance || 0,
                'ì´ ì§€ê¸‰ì•¡': r.total_payment || 0,
                'êµ­ë¯¼ì—°ê¸ˆ': r.national_pension || 0,
                'ê±´ê°•ë³´í—˜': r.health_insurance || 0,
                'ì¥ê¸°ìš”ì–‘': r.long_term_care || 0,
                'ê³ ìš©ë³´í—˜': r.employment_insurance || 0,
                'ì†Œë“ì„¸': r.income_tax || 0,
                'ì§€ë°©ì†Œë“ì„¸': r.local_income_tax || 0,
                'ì´ ê³µì œì•¡': r.total_deductions || 0,
                'ì‹¤ìˆ˜ë ¹ì•¡': r.net_payment || 0,
                'ì‚¬ì—…ì£¼_êµ­ë¯¼ì—°ê¸ˆ': r.employer_national_pension || 0,
                'ì‚¬ì—…ì£¼_ê±´ê°•ë³´í—˜': r.employer_health_insurance || 0,
                'ì‚¬ì—…ì£¼_ì¥ê¸°ìš”ì–‘': r.employer_long_term_care || 0,
                'ì‚¬ì—…ì£¼_ê³ ìš©ë³´í—˜': r.employer_employment_insurance || 0,
            }));

            const ws = XLSX.utils.json_to_sheet(rows);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'ê¸‰ì—¬ëŒ€ì¥');
            XLSX.writeFile(wb, `ê¸‰ì—¬ëŒ€ì¥_${year}ë…„${month}ì›”.xlsx`);
        }

        // â”€â”€ ì€í–‰ ì´ì²´íŒŒì¼ ë‹¤ìš´ë¡œë“œ â”€â”€
        function downloadBankFile() {
            if (!payrollResults.length) return alert('ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
            const year = document.getElementById('year').value;
            const month = document.getElementById('month').value;

            // ë²”ìš© ì€í–‰ ì´ì²´ í¬ë§· (ê³„ì¢Œë²ˆí˜¸ê°€ employeesì— ìˆë‹¤ê³  ê°€ì •)
            const rows = payrollResults.map((r, i) => ({
                'ìˆœë²ˆ': i + 1,
                'ì„±ëª…': r.employee_name || '',
                'ì€í–‰ëª…': r.bank_name || '',
                'ê³„ì¢Œë²ˆí˜¸': r.bank_account || '',
                'ì´ì²´ê¸ˆì•¡': r.net_payment || 0,
                'ë¹„ê³ ': `${year}ë…„ ${month}ì›” ê¸‰ì—¬`,
            }));

            const ws = XLSX.utils.json_to_sheet(rows);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'ì´ì²´ë‚´ì—­');
            XLSX.writeFile(wb, `ê¸‰ì—¬ì´ì²´_${year}ë…„${month}ì›”.xlsx`);
        }

        // â”€â”€ ìœ í‹¸ â”€â”€
        function formatNum(n) {
            if (!n && n !== 0) return '-';
            return Math.floor(n).toLocaleString('ko-KR');
        }
        function formatWon(n) {
            if (!n && n !== 0) return '-';
            if (n >= 100000000) return (n / 100000000).toFixed(1) + 'ì–µ';
            if (n >= 10000) return (n / 10000).toFixed(0) + 'ë§Œ';
            return Math.floor(n).toLocaleString('ko-KR') + 'ì›';
        }
        function showLoading(show, text) {
            const overlay = document.getElementById('loadingOverlay');
            if (text) document.getElementById('loadingText').textContent = text;
            if (show) overlay.classList.add('show');
            else overlay.classList.remove('show');
        }
        function handleLogout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('userInfo');
            window.location.href = '/login.html';
        }
    </script>
</body>
</html>
