<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>StaffManager - ëŒ€ì‹œë³´ë“œ</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Malgun Gothic', sans-serif;
      background: #f5f7fa;
      color: #333;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      background: white;
      padding: 20px 30px;
      border-radius: 12px;
      margin-bottom: 30px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .header h1 {
      font-size: 28px;
      color: #1a1a1a;
      margin-bottom: 5px;
    }

    .header p {
      color: #666;
      font-size: 14px;
    }

    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 30px;
      border-bottom: 2px solid #e0e0e0;
      padding-bottom: 0;
    }

    .tab {
      padding: 12px 24px;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 16px;
      color: #666;
      border-bottom: 3px solid transparent;
      margin-bottom: -2px;
      transition: all 0.3s;
    }

    .tab.active {
      color: #4CAF50;
      border-bottom-color: #4CAF50;
      font-weight: 600;
    }

    .tab:hover {
      color: #4CAF50;
    }

    .today-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      text-align: center;
    }

    .stat-card h3 {
      font-size: 14px;
      color: #666;
      margin-bottom: 10px;
    }

    .stat-card .number {
      font-size: 48px;
      font-weight: 700;
      margin-bottom: 5px;
    }

    .stat-card .label {
      font-size: 13px;
      color: #999;
    }

    .stat-card.present .number { color: #4CAF50; }
    .stat-card.vacation .number { color: #FF9800; }
    .stat-card.absent .number { color: #F44336; }

    .grid-2 {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .card {
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .card h2 {
      font-size: 18px;
      margin-bottom: 20px;
      color: #1a1a1a;
    }

    .week-staffing {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .day-row {
      display: flex;
      align-items: center;
      padding: 12px;
      background: #f8f9fa;
      border-radius: 8px;
    }

    .day-row.warning { background: #fff3cd; }
    .day-row.danger { background: #f8d7da; }

    .day-row .date {
      font-weight: 600;
      width: 100px;
      color: #333;
    }

    .day-row .count {
      font-size: 24px;
      font-weight: 700;
      margin: 0 15px;
    }

    .day-row .bar {
      flex: 1;
      height: 8px;
      background: #e0e0e0;
      border-radius: 4px;
      overflow: hidden;
    }

    .day-row .bar-fill {
      height: 100%;
      transition: width 0.3s;
    }

    .day-row .bar-fill.good { background: #4CAF50; }
    .day-row .bar-fill.warning { background: #FF9800; }
    .day-row .bar-fill.danger { background: #F44336; }

    .notifications {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .notification {
      display: flex;
      align-items: start;
      padding: 12px;
      background: #f8f9fa;
      border-radius: 8px;
      border-left: 4px solid #ddd;
    }

    .notification.late { border-left-color: #FF9800; }
    .notification.payroll { border-left-color: #4CAF50; }
    .notification.contract { border-left-color: #2196F3; }

    .notification .icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 12px;
      font-size: 20px;
    }

    .notification.late .icon { background: #fff3cd; }
    .notification.payroll .icon { background: #d4edda; }
    .notification.contract .icon { background: #d1ecf1; }

    .notification .content { flex: 1; }

    .notification .title {
      font-weight: 600;
      margin-bottom: 4px;
      color: #333;
    }

    .notification .time {
      font-size: 12px;
      color: #999;
    }

    .monthly-stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
    }

    .monthly-stat {
      text-align: center;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 8px;
    }

    .monthly-stat .value {
      font-size: 32px;
      font-weight: 700;
      color: #4CAF50;
      margin-bottom: 5px;
    }

    .monthly-stat .label {
      font-size: 13px;
      color: #666;
    }

    .quick-actions {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }

    .action-btn {
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: transform 0.2s, box-shadow 0.2s;
      text-align: left;
    }

    .action-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(0,0,0,0.2);
    }

    .action-btn:nth-child(1) {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .action-btn:nth-child(2) {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .action-btn:nth-child(3) {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }

    .action-btn:nth-child(4) {
      background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
    }

    .action-btn .icon {
      font-size: 24px;
      margin-bottom: 8px;
    }

    .action-btn .text {
      display: block;
      font-size: 14px;
      opacity: 0.9;
    }

    .loading {
      text-align: center;
      padding: 60px;
      color: #999;
    }

    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #4CAF50;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ“Š ëŒ€ì‹œë³´ë“œ</h1>
      <p id="current-date"></p>
    </div>

    <div class="tabs">
      <button class="tab active">ëŒ€ì‹œë³´ë“œ</button>
      <button class="tab" onclick="location.href='calendar.html'">ê·¼íƒœê´€ë¦¬</button>
      <button class="tab" onclick="location.href='payroll.html'">ê¸‰ì—¬ê´€ë¦¬</button>
      <button class="tab" onclick="location.href='contracts.html'">ê³„ì•½ê´€ë¦¬</button>
    </div>

    <div id="content">
      <div class="loading">
        <div class="spinner"></div>
        <p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
      </div>
    </div>
  </div>

  <script>
    (function() {
      const supabaseUrl = 'https://mlkumikpcfuopqlleszc.supabase.co';
      const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1sa3VtaWtwY2Z1b3BxbGxlc3pjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3NzU3MzUsImV4cCI6MjA4NjM1MTczNX0.K56zqmAMZmz2PS79IpkkUCwFDVQibeCW8Zxh4QSqqHE';
      const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);

      const today = new Date();
      const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
      document.getElementById('current-date').textContent = today.toLocaleDateString('ko-KR', options);

      const COMPANY_ID = 'b5327195-a4de-42d5-adaf-0d906ab49a6e';

      async function loadDashboard() {
        try {
          const todayStr = today.toISOString().split('T')[0];

          // ì˜¤ëŠ˜ ì¶œê·¼ ë°ì´í„° (work_date ì‚¬ìš©)
          const { data: todayAttendances } = await supabaseClient
            .from('attendances')
            .select('*, employee:employees(name)')
            .eq('company_id', COMPANY_ID)
            .gte('work_date', todayStr + ' 00:00:00')
            .lte('work_date', todayStr + ' 23:59:59');

          // ì˜¤ëŠ˜ íœ´ê°€ ë°ì´í„°
          const { data: todayVacations } = await supabaseClient
            .from('vacations')
            .select('*, employee:employees(name)')
            .eq('company_id', COMPANY_ID)
            .lte('start_date', todayStr)
            .gte('end_date', todayStr);

          // ì „ì²´ ì§ì› ìˆ˜
          const { data: allEmployees } = await supabaseClient
            .from('employees')
            .select('id')
            .eq('company_id', COMPANY_ID);

          const presentCount = todayAttendances?.length || 0;
          const vacationCount = todayVacations?.length || 0;
          const totalEmployees = allEmployees?.length || 0;
          const absentCount = totalEmployees - presentCount - vacationCount;

          const weekData = await getWeekStaffing();
          const monthStats = await getMonthStats();

          renderDashboard({
            present: presentCount,
            vacation: vacationCount,
            absent: absentCount,
            total: totalEmployees,
            weekData,
            monthStats
          });

        } catch (error) {
          console.error('ëŒ€ì‹œë³´ë“œ ë¡œë”© ì—ëŸ¬:', error);
          document.getElementById('content').innerHTML = `
            <div class="loading">
              <p style="color: red;">âŒ ë°ì´í„° ë¡œë”© ì‹¤íŒ¨</p>
              <p style="font-size: 14px; color: #999;">${error.message}</p>
            </div>
          `;
        }
      }

      async function getWeekStaffing() {
        const weekData = [];
        const daysOfWeek = ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ'];
        
        for (let i = 1; i <= 5; i++) {
          const date = new Date(today);
          date.setDate(date.getDate() - date.getDay() + i + 7);
          const dateStr = date.toISOString().split('T')[0];

          const { data: vacations } = await supabaseClient
            .from('vacations')
            .select('id')
            .eq('company_id', COMPANY_ID)
            .lte('start_date', dateStr)
            .gte('end_date', dateStr);

          const vacationCount = vacations?.length || 0;
          const expectedCount = 15;

          weekData.push({
            day: daysOfWeek[i - 1],
            date: `${date.getMonth() + 1}/${date.getDate()}`,
            count: Math.max(expectedCount - vacationCount, 0),
            total: expectedCount
          });
        }

        return weekData;
      }

      async function getMonthStats() {
        const year = today.getFullYear();
        const month = today.getMonth() + 1;

        // ì´ë²ˆ ë‹¬ ì¶œê·¼ (work_date ì‚¬ìš©)
        const startOfMonth = new Date(year, month - 1, 1);
        const endOfMonth = new Date(year, month, 0);
        
        const { data: attendances } = await supabaseClient
          .from('attendances')
          .select('id')
          .eq('company_id', COMPANY_ID)
          .gte('work_date', startOfMonth.toISOString())
          .lte('work_date', endOfMonth.toISOString());

        // ì´ë²ˆ ë‹¬ íœ´ê°€
        const startDate = `${year}-${String(month).padStart(2, '0')}-01`;
        const endDate = `${year}-${String(month).padStart(2, '0')}-${endOfMonth.getDate()}`;

        const { data: vacations } = await supabaseClient
          .from('vacations')
          .select('id')
          .eq('company_id', COMPANY_ID)
          .gte('start_date', startDate)
          .lte('end_date', endDate);

        // ì´ë²ˆ ë‹¬ ì§€ê° (late_minutes > 0)
        const { data: lateAttendances } = await supabaseClient
          .from('attendances')
          .select('id')
          .eq('company_id', COMPANY_ID)
          .gte('work_date', startOfMonth.toISOString())
          .lte('work_date', endOfMonth.toISOString())
          .gt('late_minutes', 0);

        // ì´ë²ˆ ë‹¬ ê¸‰ì—¬ (year, month ì‚¬ìš©)
        const { data: payrolls } = await supabaseClient
          .from('payrolls')
          .select('total_payment')
          .eq('company_id', COMPANY_ID)
          .eq('year', year)
          .eq('month', month);

        const totalPayment = payrolls?.reduce((sum, p) => sum + (p.total_payment || 0), 0) || 0;

        return {
          attendances: attendances?.length || 0,
          vacations: vacations?.length || 0,
          lates: lateAttendances?.length || 0,
          payroll: totalPayment
        };
      }

      function renderDashboard(data) {
        const html = `
          <div class="today-stats">
            <div class="stat-card present">
              <h3>ì¶œê·¼</h3>
              <div class="number">${data.present}</div>
              <div class="label">${data.total}ëª… ì¤‘</div>
            </div>
            <div class="stat-card vacation">
              <h3>íœ´ê°€</h3>
              <div class="number">${data.vacation}</div>
              <div class="label">ì˜¤ëŠ˜ íœ´ê°€</div>
            </div>
            <div class="stat-card absent">
              <h3>ë¯¸ì¶œê·¼</h3>
              <div class="number">${data.absent}</div>
              <div class="label">ì¶œê·¼ ì „/ê²°ê·¼</div>
            </div>
          </div>

          <div class="grid-2">
            <div class="card">
              <h2>ğŸ“… ë‹¤ìŒ ì£¼ ì¸ë ¥ í˜„í™©</h2>
              <div class="week-staffing">
                ${data.weekData.map(day => {
                  const percentage = (day.count / day.total) * 100;
                  const status = day.count >= 13 ? 'good' : day.count >= 10 ? 'warning' : 'danger';
                  const rowClass = day.count < 10 ? 'danger' : day.count < 13 ? 'warning' : '';
                  return `
                    <div class="day-row ${rowClass}">
                      <div class="date">${day.day} ${day.date}</div>
                      <div class="count">${day.count}ëª…</div>
                      <div class="bar">
                        <div class="bar-fill ${status}" style="width: ${percentage}%"></div>
                      </div>
                    </div>
                  `;
                }).join('')}
              </div>
            </div>

            <div class="card">
              <h2>ğŸ”” ìµœê·¼ ì•Œë¦¼</h2>
              <div class="notifications">
                <div class="notification vacation">
                  <div class="icon">ğŸ–ï¸</div>
                  <div class="content">
                    <div class="title">íœ´ê°€ ì‹œìŠ¤í…œ í™œì„±í™”</div>
                    <div class="time">Phase 8 ì™„ë£Œ Â· ë°©ê¸ˆ ì „</div>
                  </div>
                </div>
                <div class="notification payroll">
                  <div class="icon">ğŸ’°</div>
                  <div class="content">
                    <div class="title">ê¸‰ì—¬ ê³„ì‚° ì™„ë£Œ</div>
                    <div class="time">2ì›” ê¸‰ì—¬ â‚©${(data.monthStats.payroll / 10000).toFixed(0)}ë§Œì› Â· ì–´ì œ</div>
                  </div>
                </div>
                <div class="notification contract">
                  <div class="icon">ğŸ“„</div>
                  <div class="content">
                    <div class="title">ì‹œìŠ¤í…œ ì•ˆì •í™”</div>
                    <div class="time">ëª¨ë“  ê¸°ëŠ¥ ì •ìƒ ì‘ë™ Â· ì˜¤ëŠ˜</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="grid-2">
            <div class="card">
              <h2>ğŸ“Š 2ì›” í†µê³„</h2>
              <div class="monthly-stats">
                <div class="monthly-stat">
                  <div class="value">${data.monthStats.attendances}</div>
                  <div class="label">ì´ ì¶œê·¼</div>
                </div>
                <div class="monthly-stat">
                  <div class="value">${data.monthStats.vacations}</div>
                  <div class="label">ì´ íœ´ê°€</div>
                </div>
                <div class="monthly-stat">
                  <div class="value">${data.monthStats.lates}</div>
                  <div class="label">ì´ ì§€ê°</div>
                </div>
                <div class="monthly-stat">
                  <div class="value">â‚©${(data.monthStats.payroll / 10000).toFixed(0)}ë§Œ</div>
                  <div class="label">ì´ ê¸‰ì—¬</div>
                </div>
              </div>
            </div>

            <div class="card">
              <h2>âš¡ ë¹ ë¥¸ ì‘ì—…</h2>
              <div class="quick-actions">
                <button class="action-btn" onclick="location.href='calendar.html'">
                  <div class="icon">ğŸ–ï¸</div>
                  <div class="text">íœ´ê°€ ë“±ë¡</div>
                </button>
                <button class="action-btn" onclick="location.href='calendar.html'">
                  <div class="icon">ğŸ“…</div>
                  <div class="text">ê·¼íƒœ ìº˜ë¦°ë”</div>
                </button>
                <button class="action-btn" onclick="alert('Phase 4 ì™„ë£Œ!')">
                  <div class="icon">ğŸ’°</div>
                  <div class="text">ê¸‰ì—¬ ê³„ì‚°</div>
                </button>
                <button class="action-btn" onclick="alert('Phase 6 ì˜ˆì •!')">
                  <div class="icon">ğŸ“„</div>
                  <div class="text">ê³„ì•½ì„œ ë°œì†¡</div>
                </button>
              </div>
            </div>
          </div>
        `;

        document.getElementById('content').innerHTML = html;
      }

      loadDashboard();
    })();
  </script>
</body>
</html>
